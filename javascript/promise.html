<!DOCTYPE html><html lang="cn"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link data-next-font="" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/css/9028decf9ceeb2fa.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9028decf9ceeb2fa.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/_next/static/chunks/webpack-38cee4c0e358b1a3.js" defer=""></script><script src="/_next/static/chunks/framework-6698976aa0ea586d.js" defer=""></script><script src="/_next/static/chunks/main-9ca4f46f71f15dad.js" defer=""></script><script src="/_next/static/chunks/pages/_app-11554ab0b3aa1eb4.js" defer=""></script><script src="/_next/static/chunks/7a7c95a0-ab903f899792323b.js" defer=""></script><script src="/_next/static/chunks/581-340f217658a3c725.js" defer=""></script><script src="/_next/static/chunks/pages/%5B%5B...id%5D%5D-706fc642a67ce3cd.js" defer=""></script><script src="/_next/static/mX_CC2RW8ik5AG8i3Lo6r/_buildManifest.js" defer=""></script><script src="/_next/static/mX_CC2RW8ik5AG8i3Lo6r/_ssgManifest.js" defer=""></script></head><body class=" bg-light text-light-text dark:bg-dark dark:text-dark-text max-sm:text-sm"><script>
                (function () {
                  function setTheme(newTheme) {
                    window.__theme = newTheme;
                    if (newTheme === 'dark') {
                      document.documentElement.classList.add('dark');
                    } else if (newTheme === 'light') {
                      document.documentElement.classList.remove('dark');
                    }
                  }

                  var preferredTheme;
                  try {
                    preferredTheme = localStorage.getItem('theme');
                  } catch (err) { }

                  window.__setPreferredTheme = function(newTheme) {
                    preferredTheme = newTheme;
                    setTheme(newTheme);
                    try {
                      localStorage.setItem('theme', newTheme);
                    } catch (err) { }
                  };

                  var initialTheme = preferredTheme;
                  var darkQuery = window.matchMedia('(prefers-color-scheme: dark)');

                  if (!initialTheme) {
                    initialTheme = darkQuery.matches ? 'dark' : 'light';
                  }
                  setTheme(initialTheme);

                  darkQuery.addEventListener('change', function (e) {
                    if (!preferredTheme) {
                      setTheme(e.matches ? 'dark' : 'light');
                    }
                  });
                })();
              </script><div id="__next"><header class="w-full fixed t-0 h-14 border-b backdrop-blur border-slate-900/10 dark:border-slate-300/10 z-10"><div class="w-full h-full flex flex-row items-center justify-between px-4"><div>厘清逻辑</div><div class="mr-2 flex flex-row items-center justify-between gap-2 text-xl"><a href="https://github.com/Xxs-7/Xxs-7.github.io" class="p-1 rounded-full hover:bg-dark/5 hover:dark:bg-light/5"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a><button class="block dark:hidden p-1 rounded-full hover:bg-dark/5 hover:dark:bg-light/5" type="button" aria-label="Use Dark Mode"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0z"></path><path d="M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"></path></svg></button><button type="button" class="hidden dark:block p-1 rounded-full hover:bg-dark/5 hover:dark:bg-light/5" aria-label="Use Light Mode"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0V0z"></path><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79zM1 10.5h3v2H1zM11 .55h2V3.5h-2zm8.04 2.495l1.408 1.407-1.79 1.79-1.407-1.408zm-1.8 15.115l1.79 1.8 1.41-1.41-1.8-1.79zM20 10.5h3v2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm-1 4h2v2.95h-2zm-7.45-.96l1.41 1.41 1.79-1.8-1.41-1.41z"></path></svg></button></div></div></header><div class="pt-14 flex max-w-screen overflow-y-scroll"><nav class="hidden lg:block fixed top-14 lg:bottom-0 lg:h-screen w-[18rem] pb-10 px-4 overflow-y-auto min-h-screen z-10"><nav><ul class="mt-6"><!--$--><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">html</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/html/SemanticsTag">语义化标签</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/html/anchor">锚元素</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">css</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/css/flex">flex 布局</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/css/grid">grid 布局</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/css/unit">布局单位</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">javascript</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5 text-highlight"><a class="block" href="/javascript/promise">promise</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/javascript/execution-context">执行上下文</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/javascript/scopes">作用域</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">react</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react/lifecycle">lifecycle</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react/hook">hook</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react/high-compoment">组件逻辑复用方案</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">react 源码</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/architecture">源码架构</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/fiber-node">fiber 节点</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/render-mode">渲染模式</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/scheduler">scheduler</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/first-render">初次渲染</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/update-render">更新渲染</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/render-task">渲染任务的执行</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/context">Context</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">实践</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/demo/music-player">音乐播放器</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/demo/font-advance">字体库优化</a></li></ul></li><!--/$--></ul></nav></nav><main class="relative lg:ml-[18rem] min-w-0 flex-1 px-5 "><article class="mx-auto xl:max-w-none overflow-x-hidden xl:ml-0 xl:mr-[18rem]"><h1 class="mdx-heading text-3xl font-extrabold my-6 text-header dark:text-header-dark" id="promise">promise</h1>
<h2 class="mdx-heading text-2xl font-bold whitespace-pre-wrap mt-6 mb-4 group text-header  dark:text-header-dark" id="api">API<a href="#api" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h2>
<p class="whitespace-pre-wrap my-2 ">Promise 实例具有三种状态</p>
<ul class="ml-6 my-3 list-disc">
<li class="leading-relaxed ">pending 异步操作未完成</li>
<li class="leading-relaxed ">fulfilled 兑现，异步操作成功</li>
<li class="leading-relaxed ">rejected 拒绝，异步操作失败</li>
</ul>
<p class="whitespace-pre-wrap my-2 ">这三种状态的变化途径只有两种</p>
<ul class="ml-6 my-3 list-disc">
<li class="leading-relaxed ">从 pending 到 fulfilled</li>
<li class="leading-relaxed ">从 pending 到 rejected</li>
</ul>
<p class="whitespace-pre-wrap my-2 ">函数：</p>
<ul class="ml-6 my-3 list-disc">
<li class="leading-relaxed "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">Promise.then</code>：最多接受两个参数，用于 Promise 在 fulfilled 和 rejected 时的回调函数，返回一个等效的 Promise 对象。</li>
<li class="leading-relaxed "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">Promise.resolve</code>：使用给定 value 创建一个 resolved 的 promise。</li>
<li class="leading-relaxed "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">Promise.reject</code>：使用给定 error 创建一个 rejected 的 promise。</li>
<li class="leading-relaxed "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">Promise.all</code>：静态方法接受一个 Promise 可迭代对象（数组为可迭代对象），并返回一个 Promise。当所有输入的 Promise 都为 fulfilled 时，返回的 Promise 也将为 fulfilled；当任意一个 promise 被 reject，返回的 promise 就为 rejected，并且带有这个 error，所有其他 promise 的结果都会被忽略。</li>
<li class="leading-relaxed "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">Promise.allSettled</code>：返回保留所有 promise 的执行结果（settled 包含 fulfilled 和 rejected）的 promise。对于 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">Promise.all</code> 如果任意的 promise reject，则其他 promise 的结果都会被忽略。</li>
<li class="leading-relaxed "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">Promise.race</code>：与 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">Promise.all</code> 类似，但只等待第一个 settled 的 promise 并获取其结果（或 error）。</li>
<li class="leading-relaxed "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">Promise.any</code>与 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">Promise.race</code> 类似，区别在于 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">Promise.any</code> 只等待第一个 fulfilled 的 promise，并将这个 fulfilled 的 promise 返回。</li>
</ul>
<h2 class="mdx-heading text-2xl font-bold whitespace-pre-wrap mt-6 mb-4 group text-header  dark:text-header-dark" id="问题">问题<a href="#问题" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h2>
<h3 class="mdx-heading text-xl font-semibold whitespace-pre-wrap mt-4 mb-2 group text-header dark:text-header-dark" id="then-链式调用">then 链式调用<a href="#then-链式调用" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h3>
<p class="whitespace-pre-wrap my-2 "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">then</code> 方法返回一个新的 Promise 实例，因此可以链式调用。后一个 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">then</code> 方法接收前一个 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">then</code> 方法的返回值作为参数，并且只会调用 resolve 函数。也就是无论前一个 promise 的状态如何，then 调用后返回的 promise 均为 fulfilled。</p>
<pre><!--$--><div class="prism-code language-js rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="whitespace-pre-wrap"> promise </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Promise</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">resolve</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> reject</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">reject</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&quot;ok&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">promise</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">then</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">value</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap">console</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">log</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&quot;resolve&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> value</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> value</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">value</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap">console</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">log</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&quot;reject&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> value</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> value</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">then</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">value</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">console</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">log</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&quot;second&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> value</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">console</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">log</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&quot;promise catch err&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 控制台输出</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// reject ok</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// second ok</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 ">有点 generator 的样子了。</p>
<h3 class="mdx-heading text-xl font-semibold whitespace-pre-wrap mt-4 mb-2 group text-header dark:text-header-dark" id="promise-会吃掉错误">Promise 会吃掉错误<a href="#promise-会吃掉错误" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h3>
<p class="whitespace-pre-wrap my-2 ">在浏览器中执行以下代码：</p>
<pre><!--$--><div class="prism-code language-js rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">doAsyncThing</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Promise</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">resolve</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> reject</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 下面一行会报错，因为 x 没有声明</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">throw</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Error</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&quot;test error&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">doAsyncThing</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">setTimeout</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">console</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">log</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">123</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">2000</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Uncaught (in promise) Error: test error</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 123</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 ">上面代码中，<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">someAsyncThing()</code>函数产生的 Promise 对象，内部有语法错误，浏览器会打印出错误提示<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">ReferenceError: x is not defined</code>，但是不会退出进程、终止脚本执行，2 秒之后还是会输出<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">123</code>。</p>
<p class="whitespace-pre-wrap my-2 ">阮一峰的 es6 书籍中说：</p>
<blockquote class="border-l-2 border-current border-solid py-2 px-4 my-2 shadow-inner bg-[rgba(135,131,120,0.15)] dark:bg-highlight-dark bg-opacity-50 flex relative"><span class="block relative">
<p class="whitespace-pre-wrap my-2 ">跟传统的<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">try/catch</code>代码块不同的是，如果没有使用<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">catch()</code>方法指定错误处理的回调函数，Promise 对象抛出的错误不会传递到外层代码，即不会有任何反应。</p>
</span></blockquote>
<p class="whitespace-pre-wrap my-2 "><em>抛出的错误不会传递到外层代码</em> 这句话换成人话就是：设置 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">window.onerror</code> 捕获 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">error</code> ，是捕获不到 promise 内部抛出的错误，看以下代码，<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">onerror</code> 里的打印并未执行（即捕获不到 promise 内部 throw 的 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">error</code>：</p>
<pre><!--$--><div class="prism-code language-jsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">window</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">onerror</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap">   </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 我们添加了 window 的 onerror 处理函数</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">console</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">log</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;window err&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">promise </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Promise</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">resolve</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> reject</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">throw</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Error</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;test&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">promise</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">then</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">value</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">console</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">log</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">value</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap">   </span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 控制台输出:</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Uncaught (in promise) Error: test</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 ">如果加了 catch，是能捕获到内部的错误</p>
<pre><!--$--><div class="prism-code language-jsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">window</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">onerror</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">console</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">log</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;window err&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="whitespace-pre-wrap"> promise </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Promise</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">resolve</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> reject</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">throw</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Error</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;test&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">promise</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">then</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">value</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">console</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">log</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">value</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">err</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">console</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">log</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;promise catch err&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 控制台输出:</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// promise catch err</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 ">有些博客说吃掉错误是指不影响全局代码的执行，这是误解，<strong class="font-bold">实际应是 promise 外部捕获不到内部抛出的错误。</strong></p>
<p class="whitespace-pre-wrap my-2 ">在浏览器中，确实不会影响全局代码的执行。
但是在 nodeJS 中，会影响全局代码的执行，直接 exit 0 了，必须设置 catch，才会继续执行。</p>
<pre><!--$--><div class="prism-code language-jsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">doAsyncThing</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Promise</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">resolve</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> reject</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 下面一行会报错，因为 x 没有声明</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">throw</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Error</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&quot;test error&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">doAsyncThing</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">setTimeout</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">console</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">log</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">123</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">2000</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 控制台输出:</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Error: test error</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 ">链式调用 promise 时，写上 catch 是一个好习惯。</p>
<h2 class="mdx-heading text-2xl font-bold whitespace-pre-wrap mt-6 mb-4 group text-header  dark:text-header-dark" id="手写-promise">手写 promise<a href="#手写-promise" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h2>
<pre><!--$--><div class="prism-code language-jsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">PENDING</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&quot;PENDING&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">FULFILLED</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&quot;FULFILLED&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">REJECTED</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&quot;REJECTED&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">MyPromsie</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">constructor</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">executor</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">status</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">PENDING</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">value</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">undefined</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">reason</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">undefined</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">onResolvedCallbacks</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">onRejectedCallbacks</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">resolve</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">value</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">status</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">PENDING</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">status</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">FULFILLED</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">value</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> value</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">onResolvedCallbacks</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">forEach</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">fn</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">fn</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">reject</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">reason</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">status</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">PENDING</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">status</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">REJECTED</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">reason</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> reason</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">onRejectedCallbacks</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">forEach</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">fn</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">fn</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">executor</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">resolve</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> reject</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">e</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">reject</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">error</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">then</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">onFullfilled</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> onRejected</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">status</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">FULFILLED</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">onFullfilled</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">value</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">status</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">REJECTED</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">onRejected</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">reason</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">status</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">PENDING</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 如果 promise 的状态是 pending，需要将 onFulfilled 和 onRejected 函数存放起来，等待状态确定后，再依次将对应的函数执行</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">onResolvedCallbacks</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">push</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">onFullfilled</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">value</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 如果 promise 的状态是 pending，需要将 onFulfilled 和 onRejected 函数存放起来，等待状态确定后，再依次将对应的函数执行</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">onRejectedCallbacks</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">push</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">onRejected</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">reason</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="whitespace-pre-wrap"> p1 </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">MyPromsie</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">res</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">setTimeout</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">res</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&quot;ok&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">1000</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">p1</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">then</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">res</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">console</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">log</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&quot;then&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> res</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<h2 class="mdx-heading text-2xl font-bold whitespace-pre-wrap mt-6 mb-4 group text-header  dark:text-header-dark" id="应用场景">应用场景<a href="#应用场景" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h2>
<ol class="ml-6 my-3 list-decimal">
<li class="leading-relaxed ">在访问接口的时候，需要有过渡动画，实现一个需求，如果接口在半秒内响应完毕，只显示半秒的过渡动画，若超过，则等到接口响应完毕再关闭动画。</li>
</ol>
<pre><!--$--><div class="prism-code language-jsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">API</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Promise</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">resolve</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> reject</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">setTimeout</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">resolve</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">5000</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">loadTime</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Promise</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">resolve</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> reject</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">setTimeout</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">resolve</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">500</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">wrapFun</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">request</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Promise</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">allSettled</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">loadTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">request</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">wrapFun</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">API</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">then</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">console</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">log</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&quot;ok&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<ol class="ml-6 my-3 list-decimal" start="2">
<li class="leading-relaxed ">实现最多 5 个并行请求。</li>
</ol>
<pre><!--$--><div class="prism-code language-jsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 在并行请求多张图片，由于 Chrome 浏览器的 network 模块最大能够同时发起 6 个请求</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 如果超过可能会导致浏览器网络过载，从而影响页面加载性能</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 例如在页面同时发起 20 个请求，发起请求就会占用内存，即使实际未被 network 模块处理。</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 设计实现分批发送请求的功能，假设最多同时发起 6 个请求，需要处理的请求有很多个。</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="whitespace-pre-wrap"> i </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">0</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="whitespace-pre-wrap"> arr </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Array</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">18</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">fill</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&quot;url&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">limitLoad</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">arr</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">6</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">API</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">url</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Promise</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">resolve</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> reject</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">setTimeout</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 假设 20% 可能性请求失败</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">Math</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">random</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">+</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">0.8</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">1</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">resolve</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&quot;ok&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">reject</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&quot;error&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">1000</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">limitLoad</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">requests</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> limit</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> promises </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> requests</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">slice</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">0</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> limit</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">map</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">url</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> index</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">API</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">url</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">then</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> index</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> index</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> requests</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">reduce</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">pre</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> url</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> index</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">index </span><span class="whitespace-pre-wrap">&lt;</span><span class="whitespace-pre-wrap"> limit</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> pre</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> pre</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">then</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Promise</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">race</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">promises</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">then</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">idx</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          </span><span class="whitespace-pre-wrap">console</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">log</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">            </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">`</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">第</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">${</span><span class="whitespace-pre-wrap">idx</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">个位置的请求结束，将第</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">${</span><span class="whitespace-pre-wrap">index</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">个接口放入,共</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">${</span><span class="whitespace-pre-wrap">requests</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">length</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">个请求</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">`</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          promises</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap">idx</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">API</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">url</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">then</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">            </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> index</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">            </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> index</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">err</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">console</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">error</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">err</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Promise</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">resolve</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">then</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Promise</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">allSettled</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">promises</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">then</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">res</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">console</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">log</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">res</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 还可以再优化逻辑，将结果都记录</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<h2 class="mdx-heading text-2xl font-bold whitespace-pre-wrap mt-6 mb-4 group text-header  dark:text-header-dark" id="参考资料">参考资料<a href="#参考资料" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h2>
<p class="whitespace-pre-wrap my-2 "><a href="https://zh.javascript.info/promise-api" class="hover:underline text-highlight decoration-2 underline-offset-2 decoration-highlight">Promise API</a></p></article><aside class="hidden xl:block fixed top-14 right-0 w-[18rem] py-6 overflow-y-auto"><ul class="text-sm font-medium"><li class="pl-2 text-base">promise</li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-4"><a href="#api" class="block py-1">API</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-4"><a href="#问题" class="block py-1">问题</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-6 text-xs"><a href="#then-链式调用" class="block py-1">then 链式调用</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-6 text-xs"><a href="#promise-会吃掉错误" class="block py-1">Promise 会吃掉错误</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-4"><a href="#手写-promise" class="block py-1">手写 promise</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-4"><a href="#应用场景" class="block py-1">应用场景</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-4"><a href="#参考资料" class="block py-1">参考资料</a></li></ul></aside></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"toc":[{"text":"promise","hash":"#promise","depth":1},{"text":"API","hash":"#api","depth":2},{"text":"问题","hash":"#问题","depth":2},{"text":"then 链式调用","hash":"#then-链式调用","depth":3},{"text":"Promise 会吃掉错误","hash":"#promise-会吃掉错误","depth":3},{"text":"手写 promise","hash":"#手写-promise","depth":2},{"text":"应用场景","hash":"#应用场景","depth":2},{"text":"参考资料","hash":"#参考资料","depth":2}],"code":"var Component=(()=\u003e{var a=Object.create;var l=Object.defineProperty;var u=Object.getOwnPropertyDescriptor;var m=Object.getOwnPropertyNames;var p=Object.getPrototypeOf,f=Object.prototype.hasOwnProperty;var g=(r,e)=\u003e()=\u003e(e||r((e={exports:{}}).exports,e),e.exports),P=(r,e)=\u003e{for(var o in e)l(r,o,{get:e[o],enumerable:!0})},c=(r,e,o,s)=\u003e{if(e\u0026\u0026typeof e==\"object\"||typeof e==\"function\")for(let i of m(e))!f.call(r,i)\u0026\u0026i!==o\u0026\u0026l(r,i,{get:()=\u003ee[i],enumerable:!(s=u(e,i))||s.enumerable});return r};var j=(r,e,o)=\u003e(o=r!=null?a(p(r)):{},c(e||!r||!r.__esModule?l(o,\"default\",{value:r,enumerable:!0}):o,r)),v=r=\u003ec(l({},\"__esModule\",{value:!0}),r);var d=g((k,t)=\u003e{t.exports=_jsx_runtime});var x={};P(x,{default:()=\u003eE});var n=j(d());function h(r){let e=Object.assign({h1:\"h1\",h2:\"h2\",p:\"p\",ul:\"ul\",li:\"li\",code:\"code\",h3:\"h3\",pre:\"pre\",blockquote:\"blockquote\",em:\"em\",strong:\"strong\",ol:\"ol\",a:\"a\"},r.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(e.h1,{hash:\"promise\",children:\"promise\"}),`\n`,(0,n.jsx)(e.h2,{hash:\"api\",children:\"API\"}),`\n`,(0,n.jsx)(e.p,{children:\"Promise \\u5B9E\\u4F8B\\u5177\\u6709\\u4E09\\u79CD\\u72B6\\u6001\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"pending \\u5F02\\u6B65\\u64CD\\u4F5C\\u672A\\u5B8C\\u6210\"}),`\n`,(0,n.jsx)(e.li,{children:\"fulfilled \\u5151\\u73B0\\uFF0C\\u5F02\\u6B65\\u64CD\\u4F5C\\u6210\\u529F\"}),`\n`,(0,n.jsx)(e.li,{children:\"rejected \\u62D2\\u7EDD\\uFF0C\\u5F02\\u6B65\\u64CD\\u4F5C\\u5931\\u8D25\"}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"\\u8FD9\\u4E09\\u79CD\\u72B6\\u6001\\u7684\\u53D8\\u5316\\u9014\\u5F84\\u53EA\\u6709\\u4E24\\u79CD\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"\\u4ECE pending \\u5230 fulfilled\"}),`\n`,(0,n.jsx)(e.li,{children:\"\\u4ECE pending \\u5230 rejected\"}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"\\u51FD\\u6570\\uFF1A\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"Promise.then\"}),\"\\uFF1A\\u6700\\u591A\\u63A5\\u53D7\\u4E24\\u4E2A\\u53C2\\u6570\\uFF0C\\u7528\\u4E8E Promise \\u5728 fulfilled \\u548C rejected \\u65F6\\u7684\\u56DE\\u8C03\\u51FD\\u6570\\uFF0C\\u8FD4\\u56DE\\u4E00\\u4E2A\\u7B49\\u6548\\u7684 Promise \\u5BF9\\u8C61\\u3002\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"Promise.resolve\"}),\"\\uFF1A\\u4F7F\\u7528\\u7ED9\\u5B9A value \\u521B\\u5EFA\\u4E00\\u4E2A resolved \\u7684 promise\\u3002\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"Promise.reject\"}),\"\\uFF1A\\u4F7F\\u7528\\u7ED9\\u5B9A error \\u521B\\u5EFA\\u4E00\\u4E2A rejected \\u7684 promise\\u3002\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"Promise.all\"}),\"\\uFF1A\\u9759\\u6001\\u65B9\\u6CD5\\u63A5\\u53D7\\u4E00\\u4E2A Promise \\u53EF\\u8FED\\u4EE3\\u5BF9\\u8C61\\uFF08\\u6570\\u7EC4\\u4E3A\\u53EF\\u8FED\\u4EE3\\u5BF9\\u8C61\\uFF09\\uFF0C\\u5E76\\u8FD4\\u56DE\\u4E00\\u4E2A Promise\\u3002\\u5F53\\u6240\\u6709\\u8F93\\u5165\\u7684 Promise \\u90FD\\u4E3A fulfilled \\u65F6\\uFF0C\\u8FD4\\u56DE\\u7684 Promise \\u4E5F\\u5C06\\u4E3A fulfilled\\uFF1B\\u5F53\\u4EFB\\u610F\\u4E00\\u4E2A promise \\u88AB reject\\uFF0C\\u8FD4\\u56DE\\u7684 promise \\u5C31\\u4E3A rejected\\uFF0C\\u5E76\\u4E14\\u5E26\\u6709\\u8FD9\\u4E2A error\\uFF0C\\u6240\\u6709\\u5176\\u4ED6 promise \\u7684\\u7ED3\\u679C\\u90FD\\u4F1A\\u88AB\\u5FFD\\u7565\\u3002\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"Promise.allSettled\"}),\"\\uFF1A\\u8FD4\\u56DE\\u4FDD\\u7559\\u6240\\u6709 promise \\u7684\\u6267\\u884C\\u7ED3\\u679C\\uFF08settled \\u5305\\u542B fulfilled \\u548C rejected\\uFF09\\u7684 promise\\u3002\\u5BF9\\u4E8E \",(0,n.jsx)(e.code,{children:\"Promise.all\"}),\" \\u5982\\u679C\\u4EFB\\u610F\\u7684 promise reject\\uFF0C\\u5219\\u5176\\u4ED6 promise \\u7684\\u7ED3\\u679C\\u90FD\\u4F1A\\u88AB\\u5FFD\\u7565\\u3002\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"Promise.race\"}),\"\\uFF1A\\u4E0E \",(0,n.jsx)(e.code,{children:\"Promise.all\"}),\" \\u7C7B\\u4F3C\\uFF0C\\u4F46\\u53EA\\u7B49\\u5F85\\u7B2C\\u4E00\\u4E2A settled \\u7684 promise \\u5E76\\u83B7\\u53D6\\u5176\\u7ED3\\u679C\\uFF08\\u6216 error\\uFF09\\u3002\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"Promise.any\"}),\"\\u4E0E\\xA0\",(0,n.jsx)(e.code,{children:\"Promise.race\"}),\"\\xA0\\u7C7B\\u4F3C\\uFF0C\\u533A\\u522B\\u5728\\u4E8E\\xA0\",(0,n.jsx)(e.code,{children:\"Promise.any\"}),\"\\xA0\\u53EA\\u7B49\\u5F85\\u7B2C\\u4E00\\u4E2A fulfilled \\u7684 promise\\uFF0C\\u5E76\\u5C06\\u8FD9\\u4E2A fulfilled \\u7684 promise \\u8FD4\\u56DE\\u3002\"]}),`\n`]}),`\n`,(0,n.jsx)(e.h2,{hash:\"\\u95EE\\u9898\",children:\"\\u95EE\\u9898\"}),`\n`,(0,n.jsx)(e.h3,{hash:\"then-\\u94FE\\u5F0F\\u8C03\\u7528\",children:\"then \\u94FE\\u5F0F\\u8C03\\u7528\"}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.code,{children:\"then\"}),\" \\u65B9\\u6CD5\\u8FD4\\u56DE\\u4E00\\u4E2A\\u65B0\\u7684 Promise \\u5B9E\\u4F8B\\uFF0C\\u56E0\\u6B64\\u53EF\\u4EE5\\u94FE\\u5F0F\\u8C03\\u7528\\u3002\\u540E\\u4E00\\u4E2A \",(0,n.jsx)(e.code,{children:\"then\"}),\" \\u65B9\\u6CD5\\u63A5\\u6536\\u524D\\u4E00\\u4E2A \",(0,n.jsx)(e.code,{children:\"then\"}),\" \\u65B9\\u6CD5\\u7684\\u8FD4\\u56DE\\u503C\\u4F5C\\u4E3A\\u53C2\\u6570\\uFF0C\\u5E76\\u4E14\\u53EA\\u4F1A\\u8C03\\u7528 resolve \\u51FD\\u6570\\u3002\\u4E5F\\u5C31\\u662F\\u65E0\\u8BBA\\u524D\\u4E00\\u4E2A promise \\u7684\\u72B6\\u6001\\u5982\\u4F55\\uFF0Cthen \\u8C03\\u7528\\u540E\\u8FD4\\u56DE\\u7684 promise \\u5747\\u4E3A fulfilled\\u3002\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-js\",children:`var promise = new Promise(function (resolve, reject) {\n  reject(\"ok\");\n});\npromise\n  .then(\n    function (value) {\n      console.log(\"resolve\", value);\n      return value;\n    },\n    function (value) {\n      console.log(\"reject\", value);\n      return value;\n    }\n  )\n  .then(function (value) {\n    console.log(\"second\", value);\n  })\n  .catch(() =\u003e console.log(\"promise catch err\"));\n\n// \\u63A7\\u5236\\u53F0\\u8F93\\u51FA\n// reject ok\n// second ok\n`})}),`\n`,(0,n.jsx)(e.p,{children:\"\\u6709\\u70B9 generator \\u7684\\u6837\\u5B50\\u4E86\\u3002\"}),`\n`,(0,n.jsx)(e.h3,{hash:\"promise-\\u4F1A\\u5403\\u6389\\u9519\\u8BEF\",children:\"Promise \\u4F1A\\u5403\\u6389\\u9519\\u8BEF\"}),`\n`,(0,n.jsx)(e.p,{children:\"\\u5728\\u6D4F\\u89C8\\u5668\\u4E2D\\u6267\\u884C\\u4EE5\\u4E0B\\u4EE3\\u7801\\uFF1A\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-js\",children:`const doAsyncThing = function () {\n  return new Promise(function (resolve, reject) {\n    // \\u4E0B\\u9762\\u4E00\\u884C\\u4F1A\\u62A5\\u9519\\uFF0C\\u56E0\\u4E3A x \\u6CA1\\u6709\\u58F0\\u660E\n    throw new Error(\"test error\");\n  });\n};\n\ndoAsyncThing()\n\nsetTimeout(() =\u003e {\n  console.log(123);\n}, 2000);\n// Uncaught (in promise) Error: test error\n// 123\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u4E0A\\u9762\\u4EE3\\u7801\\u4E2D\\uFF0C\",(0,n.jsx)(e.code,{children:\"someAsyncThing()\"}),\"\\u51FD\\u6570\\u4EA7\\u751F\\u7684 Promise \\u5BF9\\u8C61\\uFF0C\\u5185\\u90E8\\u6709\\u8BED\\u6CD5\\u9519\\u8BEF\\uFF0C\\u6D4F\\u89C8\\u5668\\u4F1A\\u6253\\u5370\\u51FA\\u9519\\u8BEF\\u63D0\\u793A\",(0,n.jsx)(e.code,{children:\"ReferenceError: x is not defined\"}),\"\\uFF0C\\u4F46\\u662F\\u4E0D\\u4F1A\\u9000\\u51FA\\u8FDB\\u7A0B\\u3001\\u7EC8\\u6B62\\u811A\\u672C\\u6267\\u884C\\uFF0C2 \\u79D2\\u4E4B\\u540E\\u8FD8\\u662F\\u4F1A\\u8F93\\u51FA\",(0,n.jsx)(e.code,{children:\"123\"}),\"\\u3002\"]}),`\n`,(0,n.jsx)(e.p,{children:\"\\u962E\\u4E00\\u5CF0\\u7684 es6 \\u4E66\\u7C4D\\u4E2D\\u8BF4\\uFF1A\"}),`\n`,(0,n.jsxs)(e.blockquote,{children:[`\n`,(0,n.jsxs)(e.p,{children:[\"\\u8DDF\\u4F20\\u7EDF\\u7684\",(0,n.jsx)(e.code,{children:\"try/catch\"}),\"\\u4EE3\\u7801\\u5757\\u4E0D\\u540C\\u7684\\u662F\\uFF0C\\u5982\\u679C\\u6CA1\\u6709\\u4F7F\\u7528\",(0,n.jsx)(e.code,{children:\"catch()\"}),\"\\u65B9\\u6CD5\\u6307\\u5B9A\\u9519\\u8BEF\\u5904\\u7406\\u7684\\u56DE\\u8C03\\u51FD\\u6570\\uFF0CPromise \\u5BF9\\u8C61\\u629B\\u51FA\\u7684\\u9519\\u8BEF\\u4E0D\\u4F1A\\u4F20\\u9012\\u5230\\u5916\\u5C42\\u4EE3\\u7801\\uFF0C\\u5373\\u4E0D\\u4F1A\\u6709\\u4EFB\\u4F55\\u53CD\\u5E94\\u3002\"]}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.em,{children:\"\\u629B\\u51FA\\u7684\\u9519\\u8BEF\\u4E0D\\u4F1A\\u4F20\\u9012\\u5230\\u5916\\u5C42\\u4EE3\\u7801\"}),\" \\u8FD9\\u53E5\\u8BDD\\u6362\\u6210\\u4EBA\\u8BDD\\u5C31\\u662F\\uFF1A\\u8BBE\\u7F6E \",(0,n.jsx)(e.code,{children:\"window.onerror\"}),\" \\u6355\\u83B7 \",(0,n.jsx)(e.code,{children:\"error\"}),\" \\uFF0C\\u662F\\u6355\\u83B7\\u4E0D\\u5230 promise \\u5185\\u90E8\\u629B\\u51FA\\u7684\\u9519\\u8BEF\\uFF0C\\u770B\\u4EE5\\u4E0B\\u4EE3\\u7801\\uFF0C\",(0,n.jsx)(e.code,{children:\"onerror\"}),\" \\u91CC\\u7684\\u6253\\u5370\\u5E76\\u672A\\u6267\\u884C\\uFF08\\u5373\\u6355\\u83B7\\u4E0D\\u5230 promise \\u5185\\u90E8 throw \\u7684 \",(0,n.jsx)(e.code,{children:\"error\"}),\"\\uFF1A\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-jsx\",children:`window.onerror = function () {   // \\u6211\\u4EEC\\u6DFB\\u52A0\\u4E86 window \\u7684 onerror \\u5904\\u7406\\u51FD\\u6570\n    console.log('window err')\n} \n\npromise = new Promise(function(resolve, reject) {\n    throw new Error('test');\n});\npromise.then(function(value) { console.log(value) })   \n\n// \\u63A7\\u5236\\u53F0\\u8F93\\u51FA:\n// Uncaught (in promise) Error: test\n`})}),`\n`,(0,n.jsx)(e.p,{children:\"\\u5982\\u679C\\u52A0\\u4E86 catch\\uFF0C\\u662F\\u80FD\\u6355\\u83B7\\u5230\\u5185\\u90E8\\u7684\\u9519\\u8BEF\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-jsx\",children:`window.onerror = function () {\n    console.log('window err')\n} \n\nvar promise = new Promise(function(resolve, reject) {\n    throw new Error('test');\n});\n\npromise\n    .then(function(value) { console.log(value) })\n    .catch((err) =\u003e console.log('promise catch err'))\n\n// \\u63A7\\u5236\\u53F0\\u8F93\\u51FA:\n// promise catch err\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u6709\\u4E9B\\u535A\\u5BA2\\u8BF4\\u5403\\u6389\\u9519\\u8BEF\\u662F\\u6307\\u4E0D\\u5F71\\u54CD\\u5168\\u5C40\\u4EE3\\u7801\\u7684\\u6267\\u884C\\uFF0C\\u8FD9\\u662F\\u8BEF\\u89E3\\uFF0C\",(0,n.jsx)(e.strong,{children:\"\\u5B9E\\u9645\\u5E94\\u662F promise \\u5916\\u90E8\\u6355\\u83B7\\u4E0D\\u5230\\u5185\\u90E8\\u629B\\u51FA\\u7684\\u9519\\u8BEF\\u3002\"})]}),`\n`,(0,n.jsx)(e.p,{children:`\\u5728\\u6D4F\\u89C8\\u5668\\u4E2D\\uFF0C\\u786E\\u5B9E\\u4E0D\\u4F1A\\u5F71\\u54CD\\u5168\\u5C40\\u4EE3\\u7801\\u7684\\u6267\\u884C\\u3002\n\\u4F46\\u662F\\u5728 nodeJS \\u4E2D\\uFF0C\\u4F1A\\u5F71\\u54CD\\u5168\\u5C40\\u4EE3\\u7801\\u7684\\u6267\\u884C\\uFF0C\\u76F4\\u63A5 exit 0 \\u4E86\\uFF0C\\u5FC5\\u987B\\u8BBE\\u7F6E catch\\uFF0C\\u624D\\u4F1A\\u7EE7\\u7EED\\u6267\\u884C\\u3002`}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-jsx\",children:`const doAsyncThing = function () {\n  return new Promise(function (resolve, reject) {\n    // \\u4E0B\\u9762\\u4E00\\u884C\\u4F1A\\u62A5\\u9519\\uFF0C\\u56E0\\u4E3A x \\u6CA1\\u6709\\u58F0\\u660E\n    throw new Error(\"test error\");\n  });\n};\n\ndoAsyncThing();\n\nsetTimeout(() =\u003e {\n  console.log(123);\n}, 2000);\n\n// \\u63A7\\u5236\\u53F0\\u8F93\\u51FA:\n// Error: test error\n`})}),`\n`,(0,n.jsx)(e.p,{children:\"\\u94FE\\u5F0F\\u8C03\\u7528 promise \\u65F6\\uFF0C\\u5199\\u4E0A catch \\u662F\\u4E00\\u4E2A\\u597D\\u4E60\\u60EF\\u3002\"}),`\n`,(0,n.jsx)(e.h2,{hash:\"\\u624B\\u5199-promise\",children:\"\\u624B\\u5199 promise\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-jsx\",children:`const PENDING = \"PENDING\";\nconst FULFILLED = \"FULFILLED\";\nconst REJECTED = \"REJECTED\";\n\nclass MyPromsie {\n  constructor(executor) {\n    this.status = PENDING;\n    this.value = undefined;\n    this.reason = undefined;\n    this.onResolvedCallbacks = [];\n    this.onRejectedCallbacks = [];\n\n    let resolve = (value) =\u003e {\n      if (this.status == PENDING) {\n        this.status = FULFILLED;\n        this.value = value;\n        this.onResolvedCallbacks.forEach((fn) =\u003e fn());\n      }\n    };\n\n    let reject = (reason) =\u003e {\n      if (this.status == PENDING) {\n        this.status = REJECTED;\n        this.reason = reason;\n        this.onRejectedCallbacks.forEach((fn) =\u003e fn());\n      }\n    };\n\n    try {\n      executor(resolve, reject);\n    } catch (e) {\n      reject(error);\n    }\n  }\n\n  then(onFullfilled, onRejected) {\n    if (this.status == FULFILLED) {\n      onFullfilled(this.value);\n    }\n\n    if (this.status == REJECTED) {\n      onRejected(this.reason);\n    }\n\n    if (this.status === PENDING) {\n      // \\u5982\\u679C promise \\u7684\\u72B6\\u6001\\u662F pending\\uFF0C\\u9700\\u8981\\u5C06 onFulfilled \\u548C onRejected \\u51FD\\u6570\\u5B58\\u653E\\u8D77\\u6765\\uFF0C\\u7B49\\u5F85\\u72B6\\u6001\\u786E\\u5B9A\\u540E\\uFF0C\\u518D\\u4F9D\\u6B21\\u5C06\\u5BF9\\u5E94\\u7684\\u51FD\\u6570\\u6267\\u884C\n      this.onResolvedCallbacks.push(() =\u003e {\n        onFullfilled(this.value);\n      });\n\n      // \\u5982\\u679C promise \\u7684\\u72B6\\u6001\\u662F pending\\uFF0C\\u9700\\u8981\\u5C06 onFulfilled \\u548C onRejected \\u51FD\\u6570\\u5B58\\u653E\\u8D77\\u6765\\uFF0C\\u7B49\\u5F85\\u72B6\\u6001\\u786E\\u5B9A\\u540E\\uFF0C\\u518D\\u4F9D\\u6B21\\u5C06\\u5BF9\\u5E94\\u7684\\u51FD\\u6570\\u6267\\u884C\n      this.onRejectedCallbacks.push(() =\u003e {\n        onRejected(this.reason);\n      });\n    }\n  }\n}\n\nlet p1 = new MyPromsie((res) =\u003e {\n  setTimeout(() =\u003e {\n    res(\"ok\");\n  }, 1000);\n});\np1.then((res) =\u003e {\n  console.log(\"then\", res);\n});\n`})}),`\n`,(0,n.jsx)(e.h2,{hash:\"\\u5E94\\u7528\\u573A\\u666F\",children:\"\\u5E94\\u7528\\u573A\\u666F\"}),`\n`,(0,n.jsxs)(e.ol,{children:[`\n`,(0,n.jsx)(e.li,{children:\"\\u5728\\u8BBF\\u95EE\\u63A5\\u53E3\\u7684\\u65F6\\u5019\\uFF0C\\u9700\\u8981\\u6709\\u8FC7\\u6E21\\u52A8\\u753B\\uFF0C\\u5B9E\\u73B0\\u4E00\\u4E2A\\u9700\\u6C42\\uFF0C\\u5982\\u679C\\u63A5\\u53E3\\u5728\\u534A\\u79D2\\u5185\\u54CD\\u5E94\\u5B8C\\u6BD5\\uFF0C\\u53EA\\u663E\\u793A\\u534A\\u79D2\\u7684\\u8FC7\\u6E21\\u52A8\\u753B\\uFF0C\\u82E5\\u8D85\\u8FC7\\uFF0C\\u5219\\u7B49\\u5230\\u63A5\\u53E3\\u54CD\\u5E94\\u5B8C\\u6BD5\\u518D\\u5173\\u95ED\\u52A8\\u753B\\u3002\"}),`\n`]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-jsx\",children:`function API() {\n  return new Promise((resolve, reject) =\u003e {\n    setTimeout(() =\u003e {\n      resolve();\n    }, 5000);\n  });\n}\n\nlet loadTime = () =\u003e {\n  return new Promise((resolve, reject) =\u003e {\n    setTimeout(() =\u003e {\n      resolve();\n    }, 500);\n  });\n};\n\nfunction wrapFun(request) {\n  return Promise.allSettled([loadTime(), request()]);\n}\n\nwrapFun(API).then(() =\u003e {\n  console.log(\"ok\");\n});\n`})}),`\n`,(0,n.jsxs)(e.ol,{start:\"2\",children:[`\n`,(0,n.jsx)(e.li,{children:\"\\u5B9E\\u73B0\\u6700\\u591A 5 \\u4E2A\\u5E76\\u884C\\u8BF7\\u6C42\\u3002\"}),`\n`]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-jsx\",children:`// \\u5728\\u5E76\\u884C\\u8BF7\\u6C42\\u591A\\u5F20\\u56FE\\u7247\\uFF0C\\u7531\\u4E8E Chrome \\u6D4F\\u89C8\\u5668\\u7684 network \\u6A21\\u5757\\u6700\\u5927\\u80FD\\u591F\\u540C\\u65F6\\u53D1\\u8D77 6 \\u4E2A\\u8BF7\\u6C42\n// \\u5982\\u679C\\u8D85\\u8FC7\\u53EF\\u80FD\\u4F1A\\u5BFC\\u81F4\\u6D4F\\u89C8\\u5668\\u7F51\\u7EDC\\u8FC7\\u8F7D\\uFF0C\\u4ECE\\u800C\\u5F71\\u54CD\\u9875\\u9762\\u52A0\\u8F7D\\u6027\\u80FD\n// \\u4F8B\\u5982\\u5728\\u9875\\u9762\\u540C\\u65F6\\u53D1\\u8D77 20 \\u4E2A\\u8BF7\\u6C42\\uFF0C\\u53D1\\u8D77\\u8BF7\\u6C42\\u5C31\\u4F1A\\u5360\\u7528\\u5185\\u5B58\\uFF0C\\u5373\\u4F7F\\u5B9E\\u9645\\u672A\\u88AB network \\u6A21\\u5757\\u5904\\u7406\\u3002\n// \\u8BBE\\u8BA1\\u5B9E\\u73B0\\u5206\\u6279\\u53D1\\u9001\\u8BF7\\u6C42\\u7684\\u529F\\u80FD\\uFF0C\\u5047\\u8BBE\\u6700\\u591A\\u540C\\u65F6\\u53D1\\u8D77 6 \\u4E2A\\u8BF7\\u6C42\\uFF0C\\u9700\\u8981\\u5904\\u7406\\u7684\\u8BF7\\u6C42\\u6709\\u5F88\\u591A\\u4E2A\\u3002\nlet i = 0;\nlet arr = new Array(18).fill(\"url\");\nlimitLoad(arr, 6);\n\nfunction API(url) {\n  return new Promise((resolve, reject) =\u003e {\n    setTimeout(() =\u003e {\n      // \\u5047\\u8BBE 20% \\u53EF\\u80FD\\u6027\\u8BF7\\u6C42\\u5931\\u8D25\n      if (Math.random() + 0.8 \u003e 1) {\n        resolve(\"ok\");\n      } else {\n        reject(\"error\");\n      }\n    }, 1000);\n  });\n}\n\nfunction limitLoad(requests, limit) {\n  const promises = requests.slice(0, limit).map((url, index) =\u003e {\n    return API(url).then(\n      () =\u003e index,\n      () =\u003e index\n    );\n  });\n\n  return requests\n    .reduce((pre, url, index) =\u003e {\n      if (index \u003c limit) {\n        return pre;\n      }\n      return pre\n        .then(() =\u003e Promise.race(promises))\n        .then((idx) =\u003e {\n          console.log(\n            \\`\\u7B2C\\${idx}\\u4E2A\\u4F4D\\u7F6E\\u7684\\u8BF7\\u6C42\\u7ED3\\u675F\\uFF0C\\u5C06\\u7B2C\\${index}\\u4E2A\\u63A5\\u53E3\\u653E\\u5165,\\u5171\\${requests.length}\\u4E2A\\u8BF7\\u6C42\\`\n          );\n          promises[idx] = API(url).then(\n            () =\u003e index,\n            () =\u003e index\n          );\n        })\n        .catch((err) =\u003e console.error(err));\n    }, Promise.resolve())\n    .then(() =\u003e Promise.allSettled(promises))\n    .then((res) =\u003e console.log(res));\n}\n// \\u8FD8\\u53EF\\u4EE5\\u518D\\u4F18\\u5316\\u903B\\u8F91\\uFF0C\\u5C06\\u7ED3\\u679C\\u90FD\\u8BB0\\u5F55\n`})}),`\n`,(0,n.jsx)(e.h2,{hash:\"\\u53C2\\u8003\\u8D44\\u6599\",children:\"\\u53C2\\u8003\\u8D44\\u6599\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.a,{href:\"https://zh.javascript.info/promise-api\",children:\"Promise API\"})})]})}function w(r={}){let{wrapper:e}=r.components||{};return e?(0,n.jsx)(e,Object.assign({},r,{children:(0,n.jsx)(h,r)})):h(r)}var E=w;return v(x);})();\n;return Component;"},"__N_SSG":true},"page":"/[[...id]]","query":{"id":["javascript","promise"]},"buildId":"mX_CC2RW8ik5AG8i3Lo6r","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>