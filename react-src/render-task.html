<!DOCTYPE html><html lang="cn"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link data-next-font="" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/css/9028decf9ceeb2fa.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9028decf9ceeb2fa.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/_next/static/chunks/webpack-38cee4c0e358b1a3.js" defer=""></script><script src="/_next/static/chunks/framework-6698976aa0ea586d.js" defer=""></script><script src="/_next/static/chunks/main-9ca4f46f71f15dad.js" defer=""></script><script src="/_next/static/chunks/pages/_app-11554ab0b3aa1eb4.js" defer=""></script><script src="/_next/static/chunks/7a7c95a0-ab903f899792323b.js" defer=""></script><script src="/_next/static/chunks/581-340f217658a3c725.js" defer=""></script><script src="/_next/static/chunks/pages/%5B%5B...id%5D%5D-706fc642a67ce3cd.js" defer=""></script><script src="/_next/static/mX_CC2RW8ik5AG8i3Lo6r/_buildManifest.js" defer=""></script><script src="/_next/static/mX_CC2RW8ik5AG8i3Lo6r/_ssgManifest.js" defer=""></script></head><body class=" bg-light text-light-text dark:bg-dark dark:text-dark-text max-sm:text-sm"><script>
                (function () {
                  function setTheme(newTheme) {
                    window.__theme = newTheme;
                    if (newTheme === 'dark') {
                      document.documentElement.classList.add('dark');
                    } else if (newTheme === 'light') {
                      document.documentElement.classList.remove('dark');
                    }
                  }

                  var preferredTheme;
                  try {
                    preferredTheme = localStorage.getItem('theme');
                  } catch (err) { }

                  window.__setPreferredTheme = function(newTheme) {
                    preferredTheme = newTheme;
                    setTheme(newTheme);
                    try {
                      localStorage.setItem('theme', newTheme);
                    } catch (err) { }
                  };

                  var initialTheme = preferredTheme;
                  var darkQuery = window.matchMedia('(prefers-color-scheme: dark)');

                  if (!initialTheme) {
                    initialTheme = darkQuery.matches ? 'dark' : 'light';
                  }
                  setTheme(initialTheme);

                  darkQuery.addEventListener('change', function (e) {
                    if (!preferredTheme) {
                      setTheme(e.matches ? 'dark' : 'light');
                    }
                  });
                })();
              </script><div id="__next"><header class="w-full fixed t-0 h-14 border-b backdrop-blur border-slate-900/10 dark:border-slate-300/10 z-10"><div class="w-full h-full flex flex-row items-center justify-between px-4"><div>厘清逻辑</div><div class="mr-2 flex flex-row items-center justify-between gap-2 text-xl"><a href="https://github.com/Xxs-7/Xxs-7.github.io" class="p-1 rounded-full hover:bg-dark/5 hover:dark:bg-light/5"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a><button class="block dark:hidden p-1 rounded-full hover:bg-dark/5 hover:dark:bg-light/5" type="button" aria-label="Use Dark Mode"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0z"></path><path d="M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"></path></svg></button><button type="button" class="hidden dark:block p-1 rounded-full hover:bg-dark/5 hover:dark:bg-light/5" aria-label="Use Light Mode"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0V0z"></path><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79zM1 10.5h3v2H1zM11 .55h2V3.5h-2zm8.04 2.495l1.408 1.407-1.79 1.79-1.407-1.408zm-1.8 15.115l1.79 1.8 1.41-1.41-1.8-1.79zM20 10.5h3v2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm-1 4h2v2.95h-2zm-7.45-.96l1.41 1.41 1.79-1.8-1.41-1.41z"></path></svg></button></div></div></header><div class="pt-14 flex max-w-screen overflow-y-scroll"><nav class="hidden lg:block fixed top-14 lg:bottom-0 lg:h-screen w-[18rem] pb-10 px-4 overflow-y-auto min-h-screen z-10"><nav><ul class="mt-6"><!--$--><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">html</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/html/SemanticsTag">语义化标签</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/html/anchor">锚元素</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">css</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/css/flex">flex 布局</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/css/grid">grid 布局</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/css/unit">布局单位</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">javascript</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/javascript/promise">promise</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/javascript/execution-context">执行上下文</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/javascript/scopes">作用域</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">react</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react/lifecycle">lifecycle</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react/hook">hook</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react/high-compoment">组件逻辑复用方案</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">react 源码</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/architecture">源码架构</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/fiber-node">fiber 节点</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/render-mode">渲染模式</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/scheduler">scheduler</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/first-render">初次渲染</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/update-render">更新渲染</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5 text-highlight"><a class="block" href="/react-src/render-task">渲染任务的执行</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/context">Context</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">实践</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/demo/music-player">音乐播放器</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/demo/font-advance">字体库优化</a></li></ul></li><!--/$--></ul></nav></nav><main class="relative lg:ml-[18rem] min-w-0 flex-1 px-5 "><article class="mx-auto xl:max-w-none overflow-x-hidden xl:ml-0 xl:mr-[18rem]"><h1 class="mdx-heading text-3xl font-extrabold my-6 text-header dark:text-header-dark" id="渲染任务的执行">渲染任务的执行</h1>
<p class="whitespace-pre-wrap my-2 ">初次渲染和更新渲染的处理走到最后都是进入了<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">scheduleUpdateOnFiber</code></p>
<h2 class="mdx-heading text-2xl font-bold whitespace-pre-wrap mt-6 mb-4 group text-header  dark:text-header-dark" id="源码分析">源码分析<a href="#源码分析" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h2>
<p class="whitespace-pre-wrap my-2 "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">scheduleUpdateOnFiber</code> 重点在于执行了 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">ensureRootIsScheduled(root, eventTime);</code></p>
<pre><!--$--><div class="prism-code language-jsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// react/packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">export</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">scheduleUpdateOnFiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">root</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">FiberRoot</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">fiber</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Fiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">lane</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Lane</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">eventTime</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> number</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Mark that the root has a pending update.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 标记当前的 fiber 有 update 任务</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">markRootUpdated</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> lane</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> eventTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">executionContext </span><span class="whitespace-pre-wrap">&amp;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">RenderContext</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">NoLanes</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    root </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> workInProgressRoot</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// This update was dispatched during the render phase. This is a mistake</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// if the update originates from user space (with the exception of local</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// hook updates, which are handled differently and don&#x27;t reach this</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// function), but there are some internal React features that use this as</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// an implementation detail, like selective hydration.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">warnAboutRenderPhaseUpdatesInDEV</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">fiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Track lanes that were updated during the render phase</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    workInProgressRootRenderPhaseUpdatedLanes </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">mergeLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      workInProgressRootRenderPhaseUpdatedLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      lane</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// This is a normal update, scheduled from outside the render phase. For</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// example, during an input event.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    ···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">root </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> workInProgressRoot</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Received an update to a tree that&#x27;s in the middle of rendering. Mark</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// that there was an interleaved update work on this root. Unless the</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// `deferRenderPhaseUpdateToNextBatch` flag is off and this is a render</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// phase update. In that case, we don&#x27;t treat render phase updates as if</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// they were interleaved, for backwards compat reasons.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        deferRenderPhaseUpdateToNextBatch </span><span class="whitespace-pre-wrap">||</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">executionContext </span><span class="whitespace-pre-wrap">&amp;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">RenderContext</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">NoContext</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        workInProgressRootInterleavedUpdatedLanes </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">mergeLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          workInProgressRootInterleavedUpdatedLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          lane</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">workInProgressRootExitStatus </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">RootSuspendedWithDelay</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// The root already suspended with a delay, which means this render</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// definitely won&#x27;t finish. Since we have a new update, let&#x27;s mark it as</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// suspended now, right before marking the incoming update. This has the</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// effect of interrupting the current render and switching to the update.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// TODO: Make sure this doesn&#x27;t override pings that happen while we&#x27;ve</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// already started rendering.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">markRootSuspended</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> workInProgressRootRenderLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 重点在于这行</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">ensureRootIsScheduled</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> eventTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      lane </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">SyncLane</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      executionContext </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">NoContext</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">fiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">mode</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">ConcurrentMode</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">NoMode</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Treat `act` as if it&#x27;s inside `batchedUpdates`, even in legacy mode.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap">!</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">__DEV__ </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">ReactCurrentActQueue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">isBatchingLegacy</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Flush the synchronous work now, unless we&#x27;re already working or inside</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// a batch. This is intentionally inside scheduleUpdateOnFiber instead of</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// scheduleCallbackForFiber to preserve the ability to schedule a callback</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// without immediately flushing it. We only do this for user-initiated</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// updates, to preserve historical behavior of legacy mode.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">resetRenderTimer</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">flushSyncCallbacksOnlyInLegacyMode</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<pre><!--$--><div class="prism-code language-jsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">export</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">markRootUpdated</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">root</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">FiberRoot</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">updateLane</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Lane</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">eventTime</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> number</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">pendingLanes</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">|=</span><span class="whitespace-pre-wrap"> updateLane</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// If there are any suspended transitions, it&#x27;s possible this new update</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// could unblock them. Clear the suspended lanes so that we can try rendering</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// them again.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">//</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// TODO: We really only need to unsuspend only lanes that are in the</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// `subtreeLanes` of the updated fiber, or the update lanes of the return</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// path. This would exclude suspended updates in an unrelated sibling tree,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// since there&#x27;s no way for this update to unblock it.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">//</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// We don&#x27;t do this if the incoming update is idle, because we never process</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// idle updates until after all the regular updates have finished; there&#x27;s no</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// way it could unblock a transition.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">updateLane </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">IdleLane</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">suspendedLanes</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">NoLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">pingedLanes</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">NoLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> eventTimes </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">eventTimes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> index </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">laneToIndex</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">updateLane</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// We can always overwrite an existing timestamp because we prefer the most</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// recent event, and we assume time is monotonically increasing.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  eventTimes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap">index</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> eventTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">markRootUpdated</code> 可以看到，实际是在 fiber 修改了 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">root.pendingLanes |= updateLane;</code></p>
<p class="whitespace-pre-wrap my-2 ">并且由对 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">lane</code> 的处理可知，<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">fiber.eventTime[laneToIndex(updateLane)] = eventTime</code></p>
<p class="whitespace-pre-wrap my-2 ">这里初步接触的 lane 模型的概念，利用 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">eventTime</code> 数组模拟了一个多车道的模型。</p>
<pre><!--$--><div class="prism-code language-tsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> eventTimes </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">eventTimes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> index </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">laneToIndex</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">updateLane</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// We can always overwrite an existing timestamp because we prefer the most</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// recent event, and we assume time is monotonically increasing.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">eventTimes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap">index</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> eventTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">ensureRootIsScheduled</code></p>
<pre><!--$--><div class="prism-code language-jsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Use this function to schedule a task for a root. There&#x27;s only one task per</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// root; if a task was already scheduled, we&#x27;ll check to make sure the priority</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// of the existing task is the same as the priority of the next level that the</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// root has work on. This function is called on every update, and right before</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// exiting a task.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">ensureRootIsScheduled</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">root</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">FiberRoot</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">currentTime</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> number</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 杂七杂八代码比较多，这里简化核心代码</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Determine the next lanes to work on, and their priority.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> nextLanes </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">getNextLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    root </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> workInProgressRoot </span><span class="whitespace-pre-wrap">?</span><span class="whitespace-pre-wrap"> workInProgressRootRenderLanes </span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">NoLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// We use the highest priority lane to represent the priority of the callback.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> newCallbackPriority </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">getHighestPriorityLane</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">nextLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Schedule a new callback.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="whitespace-pre-wrap"> newCallbackNode</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">newCallbackPriority </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">SyncLane</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="whitespace-pre-wrap"> schedulerPriorityLevel</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">switch</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">lanesToEventPriority</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">nextLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">DiscreteEventPriority</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        schedulerPriorityLevel </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">ImmediateSchedulerPriority</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">break</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">ContinuousEventPriority</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        schedulerPriorityLevel </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">UserBlockingSchedulerPriority</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">break</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">DefaultEventPriority</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        schedulerPriorityLevel </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">NormalSchedulerPriority</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">break</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">IdleEventPriority</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        schedulerPriorityLevel </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">IdleSchedulerPriority</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">break</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">default</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        schedulerPriorityLevel </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">NormalSchedulerPriority</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">break</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 核心逻辑是走到这里</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 调用 scheduleCallback，将渲染任务（具体为performConcurrentWorkOnRoot）作为 callback</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 传入 scheduler 的 API ---- scheduleCallback，里面会创建 task，放入 taskQueue 等待调度执行</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 也就是所谓的渲染会在空闲时候执行</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    newCallbackNode </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">scheduleCallback</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      schedulerPriorityLevel</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 任务调度的优先级</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      performConcurrentWorkOnRoot</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">bind</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 要执行的任务</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">callbackPriority</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> newCallbackPriority</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">callbackNode</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> newCallbackNode</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 ">至此，发起渲染任务的代码（<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">root.render</code> 或 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">setState</code>）执行结束，产生了 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">performConcurrentWorkOnRoot.bind(null, root),</code> 这样一个闭包函数，交给了 scheduler。</p>
<h2 class="mdx-heading text-2xl font-bold whitespace-pre-wrap mt-6 mb-4 group text-header  dark:text-header-dark" id="核心逻辑">核心逻辑<a href="#核心逻辑" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h2>
<p class="whitespace-pre-wrap my-2 "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">performConcurrentWorkOnRoot</code></p>
<pre><!--$--><div class="prism-code language-jsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// This is the entry point for every concurrent task, i.e. anything that</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// goes through Scheduler.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">performConcurrentWorkOnRoot</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> didTimeout</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  ···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// We disable time-slicing in some cases: if the work has been CPU-bound</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// for too long (&quot;expired&quot; work, to prevent starvation), or we&#x27;re in</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// sync-updates-by-default mode.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// TODO: We only check `didTimeout` defensively, to account for a Scheduler</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// bug we&#x27;re still investigating. Once the bug in Scheduler is fixed,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// we can remove this, since we track expiration ourselves.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> shouldTimeSlice </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">!</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">includesBlockingLane</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> lanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">!</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">includesExpiredLane</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> lanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">disableSchedulerTimeoutInWorkLoop </span><span class="whitespace-pre-wrap">||</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">!</span><span class="whitespace-pre-wrap">didTimeout</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 只看核心代码行</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="whitespace-pre-wrap"> exitStatus </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> shouldTimeSlice</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">?</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">renderRootConcurrent</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> lanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 包含 18 的新特性</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">renderRootSync</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> lanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 没有 concurrent 的处理逻辑，简化版本</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">exitStatus </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">RootInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 ">在初次渲染中，由于 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">lane</code> 是默认的 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">DefaultLane</code>，<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">includesBlockingLane</code> 的结果为 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">true</code>，<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">shouldTimeSlice</code> 值为 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">false</code>，走的是 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">renderRootSync</code>。</p>
<pre><!--$--><div class="prism-code language-jsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">renderRootSync</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">root</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">FiberRoot</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">lanes</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Lanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> prevExecutionContext </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> executionContext</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  executionContext </span><span class="whitespace-pre-wrap">|=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">RenderContext</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 进入 render 阶段</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> prevDispatcher </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">pushDispatcher</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">containerInfo</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> prevCacheDispatcher </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">pushCacheDispatcher</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// If the root or lanes have changed, throw out the existing stack</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// and prepare a fresh one. Otherwise we&#x27;ll continue where we left off.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">workInProgressRoot </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> root </span><span class="whitespace-pre-wrap">||</span><span class="whitespace-pre-wrap"> workInProgressRootRenderLanes </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> lanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 这个函数调用了 createWorkInProgress，以 rootfiber 为模板复制一份 fiber</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 并赋值给 workInProgress</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">prepareFreshStack</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> lanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  ···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 核心在这里，执行 workLoopSync</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">do</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">workLoopSync</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">break</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">thrownValue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">handleThrow</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">root</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> thrownValue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// todo：暂未明白为什么要 while 循环，</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 从代码来看是 workLoopSync 如果出错，仍然可以重复执行进行纠错，一旦执行完毕即 break</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 所以 renderRootSync 是阻塞的</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 而 renderRootConcurrent 函数会通过判断 workInProgressSuspendedThenableState 阻止阻塞</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">while</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"> </span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">resetContextDependencies</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> workInProgressRootExitStatus</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<pre><!--$--><div class="prism-code language-jsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// The work loop is an extremely hot path. Tell Closure not to inline it.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">/** @noinline */</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">workLoopSync</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Perform work without checking if we need to yield between fiber.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">workInProgressIsSuspended</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// The current work-in-progress was already attempted. We need to unwind</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// it before we continue the normal work loop.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// react 源码其实还是会滥用全局变量的...</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> thrownValue </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> workInProgressThrownValue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    workInProgressIsSuspended </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">false</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    workInProgressThrownValue </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">workInProgress </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">			</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 如果发现之前处理的任务被中断了，那么则会恢复现场，继续执行</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">resumeSuspendedUnitOfWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> thrownValue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">while</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">workInProgress </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 进入到 workLoopSync，核心逻辑就是遍历 fiber 树</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">performUnitOfWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<pre><!--$--><div class="prism-code language-jsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// react/packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">performUnitOfWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">unitOfWork</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Fiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">void</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// The current, flushed, state of this fiber is the alternate. Ideally</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// nothing should rely on this, but relying on it here means that we don&#x27;t</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// need an additional field on the work in progress.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> current </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> unitOfWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">alternate</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">setCurrentDebugFiberInDEV</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">unitOfWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="whitespace-pre-wrap"> next</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">console</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">log</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;workInProgress&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap">workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">enableProfilerTimer </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">unitOfWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">mode</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">ProfileMode</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">NoMode</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">startProfilerTimer</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">unitOfWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    next </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">beginWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">current</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> unitOfWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> renderLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">stopProfilerTimerIfRunningAndRecordDelta</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">unitOfWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 走这里</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    next </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">beginWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">current</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> unitOfWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> renderLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">console</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">log</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;next&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap">next</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">resetCurrentDebugFiberInDEV</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  unitOfWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">memoizedProps</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> unitOfWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">pendingProps</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">next </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// If this doesn&#x27;t spawn new work, complete the current work.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">completeUnitOfWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">unitOfWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    workInProgress </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> next</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">ReactCurrentOwner</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">current</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 ">参数 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">unitOfWork</code> 为 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">workInProgress</code></p>
<p class="whitespace-pre-wrap my-2 ">首次渲染情况下，如果渲染以下页面：</p>
<pre><!--$--><div class="prism-code language-jsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> jsx </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">&lt;</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">div</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)"> </span><span class="whitespace-pre-wrap" style="color:rgb(241, 250, 140)">className</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">=</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">box border</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)"> </span><span class="whitespace-pre-wrap" style="color:rgb(241, 250, 140)">style</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">=</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">color</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">:</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&quot;red&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">lineHeight</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">:</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&quot;20px&quot;</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">&gt;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">&lt;</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">h2</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">&gt;</span><span class="whitespace-pre-wrap">ooo</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">&lt;/</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">h2</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">&gt;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">&lt;/</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">div</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">&gt;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 ">打印结果：</p>
<pre><!--$--><div class="prism-code language-tsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">workInProgress </span><span class="whitespace-pre-wrap">FiberNode </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap">tag</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">3</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> key</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> elementType</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> type</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> stateNode</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">FiberRootNode</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> …</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">next </span><span class="whitespace-pre-wrap">FiberNode </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap">tag</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">5</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> key</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> elementType</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;div&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> type</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;div&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> stateNode</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> …</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">workInProgress </span><span class="whitespace-pre-wrap">FiberNode </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap">tag</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">5</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> key</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> elementType</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;div&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> type</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;div&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> stateNode</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> …</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">next </span><span class="whitespace-pre-wrap">FiberNode </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap">tag</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">5</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> key</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> elementType</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;h2&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> type</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;h2&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> stateNode</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> …</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">workInProgress </span><span class="whitespace-pre-wrap">FiberNode </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap">tag</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">5</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> key</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> elementType</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;h2&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> type</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;h2&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> stateNode</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> …</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">next </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 ">根据打印结果可以得到，<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">workLoopSync</code> 的 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">while</code> 循环中的 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">performUnitOfWork</code> 执行了三次：</p>
<pre><!--$--><div class="prism-code language-tsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">//1 FiberRootNode</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">next </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">beginWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">current</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> unitOfWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> renderLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">workInProgress </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> next</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 2</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">next </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">beginWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">current</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> unitOfWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> renderLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">workInProgress </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> next</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 3</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">next </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">beginWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">current</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> unitOfWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> renderLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">completeUnitOfWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">unitOfWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">beginWork</code> 函数用于执行组件的更新操作；接收两个参数：当前的 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">fiber</code> 节点（<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">current</code>）和待更新的 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">fiber</code> 节点（<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">workInProgress</code>）。</p>
<p class="whitespace-pre-wrap my-2 ">调用 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">reconcileChildren</code> 函数来处理子组件的更新，然后返回一个新的 fiber 节点，这个新节点包含了更新后的组件实例和属性。</p>
<pre><!--$--><div class="prism-code language-jsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">beginWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">current</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Fiber</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">|</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// rootFiber</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">workInProgress</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Fiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 当前处理的 fiber</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">renderLanes</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Lanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Fiber</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">|</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  ···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// current 指向 alternate，不为 null 则表示不是首次渲染</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">current </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> oldProps </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> current</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">memoizedProps</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> newProps </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">pendingProps</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      oldProps </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> newProps </span><span class="whitespace-pre-wrap">||</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">hasLegacyContextChanged</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">||</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Force a re-render if the implementation changed due to hot reload:</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">__DEV__ </span><span class="whitespace-pre-wrap">?</span><span class="whitespace-pre-wrap"> workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">type</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> current</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">type</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">false</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// If props or context changed, mark the fiber as having performed work.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// This may be unset if the props are determined to be equal later (memo).</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      didReceiveUpdate </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Neither props nor legacy context changes. Check if there&#x27;s a pending</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// update or context change.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> hasScheduledUpdateOrContext </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">checkScheduledUpdateOrContext</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        current</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        renderLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap">!</span><span class="whitespace-pre-wrap">hasScheduledUpdateOrContext </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// If this is the second pass of an error or suspense boundary, there</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// may not be work scheduled on `current`, so we check for this flag.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">flags</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">DidCapture</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">NoFlags</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// No pending updates or context. Bail out now.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        didReceiveUpdate </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">false</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">attemptEarlyBailoutIfNoScheduledUpdate</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          current</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          renderLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">current</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">flags</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">ForceUpdateForLegacySuspense</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">NoFlags</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// This is a special case that only exists for legacy mode.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// See https://github.com/facebook/react/pull/19216.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        didReceiveUpdate </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// An update was scheduled on this fiber, but there are no new props</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// nor legacy context. Set this to false. If an update queue or context</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// consumer produces a changed value, it will set this to true. Otherwise,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// the component will assume the children have not changed and bail out.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        didReceiveUpdate </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">false</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 首次渲染</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 这个变量可以暂时不理会</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    didReceiveUpdate </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">false</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	  ···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Before entering the begin phase, clear pending update priority.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// TODO: This assumes that we&#x27;re about to evaluate the component and process</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// the update queue. However, there&#x27;s an exception: SimpleMemoComponent</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// sometimes bails out later in the begin phase. This indicates that we should</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// move this assignment out of the common path and into each branch.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">lanes</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">NoLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 根据当前 fiber 的类型对组件进行处理</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">switch</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">tag</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    ···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">FunctionComponent</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Component</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">type</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> unresolvedProps </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">pendingProps</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> resolvedProps </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">elementType</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Component</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          </span><span class="whitespace-pre-wrap">?</span><span class="whitespace-pre-wrap"> unresolvedProps</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          </span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">resolveDefaultProps</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">Component</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> unresolvedProps</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">updateFunctionComponent</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        current</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap">Component</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        resolvedProps</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        renderLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">ClassComponent</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Component</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">type</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> unresolvedProps </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">pendingProps</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> resolvedProps </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">elementType</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Component</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          </span><span class="whitespace-pre-wrap">?</span><span class="whitespace-pre-wrap"> unresolvedProps</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          </span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">resolveDefaultProps</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">Component</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> unresolvedProps</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">updateClassComponent</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        current</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap">Component</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        resolvedProps</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        renderLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	  ···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">throw</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Error</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">`</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">Unknown unit of work tag (</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">${</span><span class="whitespace-pre-wrap">workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">tag</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">). This error is likely caused by a bug in </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">`</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">+</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;React. Please file an issue.&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">completeUnitOfWork</code> 函数用于完成一个组件的遍历。在函数内部，会先检查 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">workInProgress</code> 是否为 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">null</code>，如果是，那么说明这个组件已经完成了所有的更新操作。</p>
<p class="whitespace-pre-wrap my-2 ">Todo：继续深挖逻辑</p></article><aside class="hidden xl:block fixed top-14 right-0 w-[18rem] py-6 overflow-y-auto"><ul class="text-sm font-medium"><li class="pl-2 text-base">渲染任务的执行</li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-4"><a href="#源码分析" class="block py-1">源码分析</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-4"><a href="#核心逻辑" class="block py-1">核心逻辑</a></li></ul></aside></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"toc":[{"text":"渲染任务的执行","hash":"#渲染任务的执行","depth":1},{"text":"源码分析","hash":"#源码分析","depth":2},{"text":"核心逻辑","hash":"#核心逻辑","depth":2}],"code":"var Component=(()=\u003e{var h=Object.create;var s=Object.defineProperty;var u=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var g=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty;var f=(r,e)=\u003e()=\u003e(e||r((e={exports:{}}).exports,e),e.exports),m=(r,e)=\u003e{for(var t in e)s(r,t,{get:e[t],enumerable:!0})},i=(r,e,t,a)=\u003e{if(e\u0026\u0026typeof e==\"object\"||typeof e==\"function\")for(let o of p(e))!k.call(r,o)\u0026\u0026o!==t\u0026\u0026s(r,o,{get:()=\u003ee[o],enumerable:!(a=u(e,o))||a.enumerable});return r};var w=(r,e,t)=\u003e(t=r!=null?h(g(r)):{},i(e||!r||!r.__esModule?s(t,\"default\",{value:r,enumerable:!0}):t,r)),b=r=\u003ei(s({},\"__esModule\",{value:!0}),r);var l=f((I,d)=\u003e{d.exports=_jsx_runtime});var x={};m(x,{default:()=\u003eP});var n=w(l());function c(r){let e=Object.assign({h1:\"h1\",p:\"p\",code:\"code\",h2:\"h2\",pre:\"pre\"},r.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(e.h1,{hash:\"\\u6E32\\u67D3\\u4EFB\\u52A1\\u7684\\u6267\\u884C\",children:\"\\u6E32\\u67D3\\u4EFB\\u52A1\\u7684\\u6267\\u884C\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u521D\\u6B21\\u6E32\\u67D3\\u548C\\u66F4\\u65B0\\u6E32\\u67D3\\u7684\\u5904\\u7406\\u8D70\\u5230\\u6700\\u540E\\u90FD\\u662F\\u8FDB\\u5165\\u4E86\",(0,n.jsx)(e.code,{children:\"scheduleUpdateOnFiber\"})]}),`\n`,(0,n.jsx)(e.h2,{hash:\"\\u6E90\\u7801\\u5206\\u6790\",children:\"\\u6E90\\u7801\\u5206\\u6790\"}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.code,{children:\"scheduleUpdateOnFiber\"}),\" \\u91CD\\u70B9\\u5728\\u4E8E\\u6267\\u884C\\u4E86 \",(0,n.jsx)(e.code,{children:\"ensureRootIsScheduled(root, eventTime);\"})]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-jsx\",children:`// react/packages/react-reconciler/src/ReactFiberWorkLoop.old.js\nexport function scheduleUpdateOnFiber(\n  root: FiberRoot,\n  fiber: Fiber,\n  lane: Lane,\n  eventTime: number,\n) {\n\t\\xB7\\xB7\\xB7\n\n  // Mark that the root has a pending update.\n\t// \\u6807\\u8BB0\\u5F53\\u524D\\u7684 fiber \\u6709 update \\u4EFB\\u52A1\n  markRootUpdated(root, lane, eventTime);\n\n  if (\n    (executionContext \u0026 RenderContext) !== NoLanes \u0026\u0026\n    root === workInProgressRoot\n  ) {\n    // This update was dispatched during the render phase. This is a mistake\n    // if the update originates from user space (with the exception of local\n    // hook updates, which are handled differently and don't reach this\n    // function), but there are some internal React features that use this as\n    // an implementation detail, like selective hydration.\n    warnAboutRenderPhaseUpdatesInDEV(fiber);\n\n    // Track lanes that were updated during the render phase\n    workInProgressRootRenderPhaseUpdatedLanes = mergeLanes(\n      workInProgressRootRenderPhaseUpdatedLanes,\n      lane,\n    );\n  } else {\n    // This is a normal update, scheduled from outside the render phase. For\n    // example, during an input event.\n    \\xB7\\xB7\\xB7\n  \n    if (root === workInProgressRoot) {\n      // Received an update to a tree that's in the middle of rendering. Mark\n      // that there was an interleaved update work on this root. Unless the\n      // \\`deferRenderPhaseUpdateToNextBatch\\` flag is off and this is a render\n      // phase update. In that case, we don't treat render phase updates as if\n      // they were interleaved, for backwards compat reasons.\n      if (\n        deferRenderPhaseUpdateToNextBatch ||\n        (executionContext \u0026 RenderContext) === NoContext\n      ) {\n        workInProgressRootInterleavedUpdatedLanes = mergeLanes(\n          workInProgressRootInterleavedUpdatedLanes,\n          lane,\n        );\n      }\n      if (workInProgressRootExitStatus === RootSuspendedWithDelay) {\n        // The root already suspended with a delay, which means this render\n        // definitely won't finish. Since we have a new update, let's mark it as\n        // suspended now, right before marking the incoming update. This has the\n        // effect of interrupting the current render and switching to the update.\n        // TODO: Make sure this doesn't override pings that happen while we've\n        // already started rendering.\n        markRootSuspended(root, workInProgressRootRenderLanes);\n      }\n    }\n\n\t\t// \\u91CD\\u70B9\\u5728\\u4E8E\\u8FD9\\u884C\n    ensureRootIsScheduled(root, eventTime);\n    if (\n      lane === SyncLane \u0026\u0026\n      executionContext === NoContext \u0026\u0026\n      (fiber.mode \u0026 ConcurrentMode) === NoMode \u0026\u0026\n      // Treat \\`act\\` as if it's inside \\`batchedUpdates\\`, even in legacy mode.\n      !(__DEV__ \u0026\u0026 ReactCurrentActQueue.isBatchingLegacy)\n    ) {\n      // Flush the synchronous work now, unless we're already working or inside\n      // a batch. This is intentionally inside scheduleUpdateOnFiber instead of\n      // scheduleCallbackForFiber to preserve the ability to schedule a callback\n      // without immediately flushing it. We only do this for user-initiated\n      // updates, to preserve historical behavior of legacy mode.\n      resetRenderTimer();\n      flushSyncCallbacksOnlyInLegacyMode();\n    }\n  }\n}\n`})}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-jsx\",children:`export function markRootUpdated(\n  root: FiberRoot,\n  updateLane: Lane,\n  eventTime: number,\n) {\n  root.pendingLanes |= updateLane;\n\n  // If there are any suspended transitions, it's possible this new update\n  // could unblock them. Clear the suspended lanes so that we can try rendering\n  // them again.\n  //\n  // TODO: We really only need to unsuspend only lanes that are in the\n  // \\`subtreeLanes\\` of the updated fiber, or the update lanes of the return\n  // path. This would exclude suspended updates in an unrelated sibling tree,\n  // since there's no way for this update to unblock it.\n  //\n  // We don't do this if the incoming update is idle, because we never process\n  // idle updates until after all the regular updates have finished; there's no\n  // way it could unblock a transition.\n  if (updateLane !== IdleLane) {\n    root.suspendedLanes = NoLanes;\n    root.pingedLanes = NoLanes;\n  }\n\n  const eventTimes = root.eventTimes;\n  const index = laneToIndex(updateLane);\n  // We can always overwrite an existing timestamp because we prefer the most\n  // recent event, and we assume time is monotonically increasing.\n  eventTimes[index] = eventTime;\n}\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.code,{children:\"markRootUpdated\"}),\" \\u53EF\\u4EE5\\u770B\\u5230\\uFF0C\\u5B9E\\u9645\\u662F\\u5728 fiber \\u4FEE\\u6539\\u4E86 \",(0,n.jsx)(e.code,{children:\"root.pendingLanes |= updateLane;\"})]}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u5E76\\u4E14\\u7531\\u5BF9 \",(0,n.jsx)(e.code,{children:\"lane\"}),\" \\u7684\\u5904\\u7406\\u53EF\\u77E5\\uFF0C\",(0,n.jsx)(e.code,{children:\"fiber.eventTime[laneToIndex(updateLane)] = eventTime\"})]}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u8FD9\\u91CC\\u521D\\u6B65\\u63A5\\u89E6\\u7684 lane \\u6A21\\u578B\\u7684\\u6982\\u5FF5\\uFF0C\\u5229\\u7528 \",(0,n.jsx)(e.code,{children:\"eventTime\"}),\" \\u6570\\u7EC4\\u6A21\\u62DF\\u4E86\\u4E00\\u4E2A\\u591A\\u8F66\\u9053\\u7684\\u6A21\\u578B\\u3002\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-tsx\",children:`const eventTimes = root.eventTimes;\nconst index = laneToIndex(updateLane);\n// We can always overwrite an existing timestamp because we prefer the most\n// recent event, and we assume time is monotonically increasing.\neventTimes[index] = eventTime;\n`})}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.code,{children:\"ensureRootIsScheduled\"})}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-jsx\",children:`// Use this function to schedule a task for a root. There's only one task per\n// root; if a task was already scheduled, we'll check to make sure the priority\n// of the existing task is the same as the priority of the next level that the\n// root has work on. This function is called on every update, and right before\n// exiting a task.\nfunction ensureRootIsScheduled(root: FiberRoot, currentTime: number) {\n\t// \\u6742\\u4E03\\u6742\\u516B\\u4EE3\\u7801\\u6BD4\\u8F83\\u591A\\uFF0C\\u8FD9\\u91CC\\u7B80\\u5316\\u6838\\u5FC3\\u4EE3\\u7801\n\t\\xB7\\xB7\\xB7\n\n\t// Determine the next lanes to work on, and their priority.\n  const nextLanes = getNextLanes(\n    root,\n    root === workInProgressRoot ? workInProgressRootRenderLanes : NoLanes,\n  );\n\n\t\\xB7\\xB7\\xB7\n\n\t// We use the highest priority lane to represent the priority of the callback.\n  const newCallbackPriority = getHighestPriorityLane(nextLanes);\n\n\t\\xB7\\xB7\\xB7\n\t// Schedule a new callback.\n  let newCallbackNode;\n  if (newCallbackPriority === SyncLane) {\n\t\t\\xB7\\xB7\\xB7\n\t} else {\n    let schedulerPriorityLevel;\n    switch (lanesToEventPriority(nextLanes)) {\n      case DiscreteEventPriority:\n        schedulerPriorityLevel = ImmediateSchedulerPriority;\n        break;\n      case ContinuousEventPriority:\n        schedulerPriorityLevel = UserBlockingSchedulerPriority;\n        break;\n      case DefaultEventPriority:\n        schedulerPriorityLevel = NormalSchedulerPriority;\n        break;\n      case IdleEventPriority:\n        schedulerPriorityLevel = IdleSchedulerPriority;\n        break;\n      default:\n        schedulerPriorityLevel = NormalSchedulerPriority;\n        break;\n    }\n\t\t// \\u6838\\u5FC3\\u903B\\u8F91\\u662F\\u8D70\\u5230\\u8FD9\\u91CC\n\t\t// \\u8C03\\u7528 scheduleCallback\\uFF0C\\u5C06\\u6E32\\u67D3\\u4EFB\\u52A1\\uFF08\\u5177\\u4F53\\u4E3AperformConcurrentWorkOnRoot\\uFF09\\u4F5C\\u4E3A callback\n\t\t// \\u4F20\\u5165 scheduler \\u7684 API ---- scheduleCallback\\uFF0C\\u91CC\\u9762\\u4F1A\\u521B\\u5EFA task\\uFF0C\\u653E\\u5165 taskQueue \\u7B49\\u5F85\\u8C03\\u5EA6\\u6267\\u884C\n\t\t// \\u4E5F\\u5C31\\u662F\\u6240\\u8C13\\u7684\\u6E32\\u67D3\\u4F1A\\u5728\\u7A7A\\u95F2\\u65F6\\u5019\\u6267\\u884C\n    newCallbackNode = scheduleCallback(\n      schedulerPriorityLevel, // \\u4EFB\\u52A1\\u8C03\\u5EA6\\u7684\\u4F18\\u5148\\u7EA7\n      performConcurrentWorkOnRoot.bind(null, root), // \\u8981\\u6267\\u884C\\u7684\\u4EFB\\u52A1\n    );\n  }\n\n  root.callbackPriority = newCallbackPriority;\n  root.callbackNode = newCallbackNode;\n}\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u81F3\\u6B64\\uFF0C\\u53D1\\u8D77\\u6E32\\u67D3\\u4EFB\\u52A1\\u7684\\u4EE3\\u7801\\uFF08\",(0,n.jsx)(e.code,{children:\"root.render\"}),\" \\u6216 \",(0,n.jsx)(e.code,{children:\"setState\"}),\"\\uFF09\\u6267\\u884C\\u7ED3\\u675F\\uFF0C\\u4EA7\\u751F\\u4E86 \",(0,n.jsx)(e.code,{children:\"performConcurrentWorkOnRoot.bind(null, root),\"}),\" \\u8FD9\\u6837\\u4E00\\u4E2A\\u95ED\\u5305\\u51FD\\u6570\\uFF0C\\u4EA4\\u7ED9\\u4E86 scheduler\\u3002\"]}),`\n`,(0,n.jsx)(e.h2,{hash:\"\\u6838\\u5FC3\\u903B\\u8F91\",children:\"\\u6838\\u5FC3\\u903B\\u8F91\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.code,{children:\"performConcurrentWorkOnRoot\"})}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-jsx\",children:`// This is the entry point for every concurrent task, i.e. anything that\n// goes through Scheduler.\nfunction performConcurrentWorkOnRoot(root, didTimeout) {\n  \\xB7\\xB7\\xB7\n\n\t// We disable time-slicing in some cases: if the work has been CPU-bound\n  // for too long (\"expired\" work, to prevent starvation), or we're in\n  // sync-updates-by-default mode.\n  // TODO: We only check \\`didTimeout\\` defensively, to account for a Scheduler\n  // bug we're still investigating. Once the bug in Scheduler is fixed,\n  // we can remove this, since we track expiration ourselves.\n  const shouldTimeSlice =\n    !includesBlockingLane(root, lanes) \u0026\u0026\n    !includesExpiredLane(root, lanes) \u0026\u0026\n    (disableSchedulerTimeoutInWorkLoop || !didTimeout);\n\t// \\u53EA\\u770B\\u6838\\u5FC3\\u4EE3\\u7801\\u884C\n  let exitStatus = shouldTimeSlice\n    ? renderRootConcurrent(root, lanes) // \\u5305\\u542B 18 \\u7684\\u65B0\\u7279\\u6027\n\t\t: renderRootSync(root, lanes); // \\u6CA1\\u6709 concurrent \\u7684\\u5904\\u7406\\u903B\\u8F91\\uFF0C\\u7B80\\u5316\\u7248\\u672C\n\tif (exitStatus !== RootInProgress) {\n\t\t\\xB7\\xB7\\xB7\n\t}\n\n\t\\xB7\\xB7\\xB7\n\n\treturn null;\n}\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u5728\\u521D\\u6B21\\u6E32\\u67D3\\u4E2D\\uFF0C\\u7531\\u4E8E \",(0,n.jsx)(e.code,{children:\"lane\"}),\" \\u662F\\u9ED8\\u8BA4\\u7684 \",(0,n.jsx)(e.code,{children:\"DefaultLane\"}),\"\\uFF0C\",(0,n.jsx)(e.code,{children:\"includesBlockingLane\"}),\" \\u7684\\u7ED3\\u679C\\u4E3A \",(0,n.jsx)(e.code,{children:\"true\"}),\"\\uFF0C\",(0,n.jsx)(e.code,{children:\"shouldTimeSlice\"}),\" \\u503C\\u4E3A \",(0,n.jsx)(e.code,{children:\"false\"}),\"\\uFF0C\\u8D70\\u7684\\u662F \",(0,n.jsx)(e.code,{children:\"renderRootSync\"}),\"\\u3002\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-jsx\",children:`function renderRootSync(root: FiberRoot, lanes: Lanes) {\n  const prevExecutionContext = executionContext;\n  executionContext |= RenderContext; // \\u8FDB\\u5165 render \\u9636\\u6BB5\n  const prevDispatcher = pushDispatcher(root.containerInfo);\n  const prevCacheDispatcher = pushCacheDispatcher();\n\n\t// If the root or lanes have changed, throw out the existing stack\n  // and prepare a fresh one. Otherwise we'll continue where we left off.\n  if (workInProgressRoot !== root || workInProgressRootRenderLanes !== lanes) {\n\t\t\\xB7\\xB7\\xB7\n\t\t// \\u8FD9\\u4E2A\\u51FD\\u6570\\u8C03\\u7528\\u4E86 createWorkInProgress\\uFF0C\\u4EE5 rootfiber \\u4E3A\\u6A21\\u677F\\u590D\\u5236\\u4E00\\u4EFD fiber\n\t\t// \\u5E76\\u8D4B\\u503C\\u7ED9 workInProgress\n\t\tprepareFreshStack(root, lanes);\n  }\n  \\xB7\\xB7\\xB7\n\n\t// \\u6838\\u5FC3\\u5728\\u8FD9\\u91CC\\uFF0C\\u6267\\u884C workLoopSync\n  do {\n    try {\n      workLoopSync();\n      break;\n    } catch (thrownValue) {\n      handleThrow(root, thrownValue);\n    }\n\t\t// todo\\uFF1A\\u6682\\u672A\\u660E\\u767D\\u4E3A\\u4EC0\\u4E48\\u8981 while \\u5FAA\\u73AF\\uFF0C\n\t\t// \\u4ECE\\u4EE3\\u7801\\u6765\\u770B\\u662F workLoopSync \\u5982\\u679C\\u51FA\\u9519\\uFF0C\\u4ECD\\u7136\\u53EF\\u4EE5\\u91CD\\u590D\\u6267\\u884C\\u8FDB\\u884C\\u7EA0\\u9519\\uFF0C\\u4E00\\u65E6\\u6267\\u884C\\u5B8C\\u6BD5\\u5373 break\n\t\t// \\u6240\\u4EE5 renderRootSync \\u662F\\u963B\\u585E\\u7684\n\t\t// \\u800C renderRootConcurrent \\u51FD\\u6570\\u4F1A\\u901A\\u8FC7\\u5224\\u65AD workInProgressSuspendedThenableState \\u963B\\u6B62\\u963B\\u585E\n  } while (true); \n  resetContextDependencies();\n\n\t\\xB7\\xB7\\xB7\n\treturn workInProgressRootExitStatus;\n}\n`})}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-jsx\",children:`// The work loop is an extremely hot path. Tell Closure not to inline it.\n/** @noinline */\nfunction workLoopSync() {\n  // Perform work without checking if we need to yield between fiber.\n\n  if (workInProgressIsSuspended) {\n    // The current work-in-progress was already attempted. We need to unwind\n    // it before we continue the normal work loop.\n\t\t// react \\u6E90\\u7801\\u5176\\u5B9E\\u8FD8\\u662F\\u4F1A\\u6EE5\\u7528\\u5168\\u5C40\\u53D8\\u91CF\\u7684...\n    const thrownValue = workInProgressThrownValue;\n    workInProgressIsSuspended = false;\n    workInProgressThrownValue = null;\n    if (workInProgress !== null) {\n\t\t\t// \\u5982\\u679C\\u53D1\\u73B0\\u4E4B\\u524D\\u5904\\u7406\\u7684\\u4EFB\\u52A1\\u88AB\\u4E2D\\u65AD\\u4E86\\uFF0C\\u90A3\\u4E48\\u5219\\u4F1A\\u6062\\u590D\\u73B0\\u573A\\uFF0C\\u7EE7\\u7EED\\u6267\\u884C\n      resumeSuspendedUnitOfWork(workInProgress, thrownValue);\n    }\n  }\n\n  while (workInProgress !== null) {\n\t\t// \\u8FDB\\u5165\\u5230 workLoopSync\\uFF0C\\u6838\\u5FC3\\u903B\\u8F91\\u5C31\\u662F\\u904D\\u5386 fiber \\u6811\n    performUnitOfWork(workInProgress);\n  }\n}\n`})}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-jsx\",children:`// react/packages/react-reconciler/src/ReactFiberWorkLoop.old.js\n\nfunction performUnitOfWork(unitOfWork: Fiber): void {\n  // The current, flushed, state of this fiber is the alternate. Ideally\n  // nothing should rely on this, but relying on it here means that we don't\n  // need an additional field on the work in progress.\n  const current = unitOfWork.alternate;\n  setCurrentDebugFiberInDEV(unitOfWork);\n\n  let next;\n  console.log('workInProgress',workInProgress)\n  if (enableProfilerTimer \u0026\u0026 (unitOfWork.mode \u0026 ProfileMode) !== NoMode) {\n    startProfilerTimer(unitOfWork);\n    next = beginWork(current, unitOfWork, renderLanes);\n    stopProfilerTimerIfRunningAndRecordDelta(unitOfWork, true);\n  } else {\n\t\t// \\u8D70\\u8FD9\\u91CC\n    next = beginWork(current, unitOfWork, renderLanes);\n  }\n  console.log('next',next)\n  resetCurrentDebugFiberInDEV();\n  unitOfWork.memoizedProps = unitOfWork.pendingProps;\n  if (next === null) {\n    // If this doesn't spawn new work, complete the current work.\n    completeUnitOfWork(unitOfWork);\n  } else {\n    workInProgress = next;\n  }\n\n  ReactCurrentOwner.current = null;\n}\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u53C2\\u6570 \",(0,n.jsx)(e.code,{children:\"unitOfWork\"}),\" \\u4E3A \",(0,n.jsx)(e.code,{children:\"workInProgress\"})]}),`\n`,(0,n.jsx)(e.p,{children:\"\\u9996\\u6B21\\u6E32\\u67D3\\u60C5\\u51B5\\u4E0B\\uFF0C\\u5982\\u679C\\u6E32\\u67D3\\u4EE5\\u4E0B\\u9875\\u9762\\uFF1A\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-jsx\",children:`const jsx = (\n  \u003cdiv className=\"box border\" style={{ color: \"red\", lineHeight: \"20px\" }}\u003e\n    \u003ch2\u003eooo\u003c/h2\u003e\n  \u003c/div\u003e\n);\n`})}),`\n`,(0,n.jsx)(e.p,{children:\"\\u6253\\u5370\\u7ED3\\u679C\\uFF1A\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-tsx\",children:`workInProgress FiberNode\\xA0{tag: 3, key: null, elementType: null, type: null, stateNode: FiberRootNode,\\xA0\\u2026}\nnext FiberNode\\xA0{tag: 5, key: null, elementType: 'div', type: 'div', stateNode: null,\\xA0\\u2026}\nworkInProgress FiberNode\\xA0{tag: 5, key: null, elementType: 'div', type: 'div', stateNode: null,\\xA0\\u2026}\nnext FiberNode\\xA0{tag: 5, key: null, elementType: 'h2', type: 'h2', stateNode: null,\\xA0\\u2026}\nworkInProgress FiberNode\\xA0{tag: 5, key: null, elementType: 'h2', type: 'h2', stateNode: null,\\xA0\\u2026}\nnext null\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u6839\\u636E\\u6253\\u5370\\u7ED3\\u679C\\u53EF\\u4EE5\\u5F97\\u5230\\uFF0C\",(0,n.jsx)(e.code,{children:\"workLoopSync\"}),\" \\u7684 \",(0,n.jsx)(e.code,{children:\"while\"}),\" \\u5FAA\\u73AF\\u4E2D\\u7684 \",(0,n.jsx)(e.code,{children:\"performUnitOfWork\"}),\" \\u6267\\u884C\\u4E86\\u4E09\\u6B21\\uFF1A\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-tsx\",children:`//1 FiberRootNode\nnext = beginWork(current, unitOfWork, renderLanes);\nworkInProgress = next;\n\n// 2\nnext = beginWork(current, unitOfWork, renderLanes);\nworkInProgress = next;\n\n// 3\nnext = beginWork(current, unitOfWork, renderLanes);\ncompleteUnitOfWork(unitOfWork);\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.code,{children:\"beginWork\"}),\" \\u51FD\\u6570\\u7528\\u4E8E\\u6267\\u884C\\u7EC4\\u4EF6\\u7684\\u66F4\\u65B0\\u64CD\\u4F5C\\uFF1B\\u63A5\\u6536\\u4E24\\u4E2A\\u53C2\\u6570\\uFF1A\\u5F53\\u524D\\u7684 \",(0,n.jsx)(e.code,{children:\"fiber\"}),\" \\u8282\\u70B9\\uFF08\",(0,n.jsx)(e.code,{children:\"current\"}),\"\\uFF09\\u548C\\u5F85\\u66F4\\u65B0\\u7684 \",(0,n.jsx)(e.code,{children:\"fiber\"}),\" \\u8282\\u70B9\\uFF08\",(0,n.jsx)(e.code,{children:\"workInProgress\"}),\"\\uFF09\\u3002\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u8C03\\u7528 \",(0,n.jsx)(e.code,{children:\"reconcileChildren\"}),\" \\u51FD\\u6570\\u6765\\u5904\\u7406\\u5B50\\u7EC4\\u4EF6\\u7684\\u66F4\\u65B0\\uFF0C\\u7136\\u540E\\u8FD4\\u56DE\\u4E00\\u4E2A\\u65B0\\u7684 fiber \\u8282\\u70B9\\uFF0C\\u8FD9\\u4E2A\\u65B0\\u8282\\u70B9\\u5305\\u542B\\u4E86\\u66F4\\u65B0\\u540E\\u7684\\u7EC4\\u4EF6\\u5B9E\\u4F8B\\u548C\\u5C5E\\u6027\\u3002\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-jsx\",children:`function beginWork(\n  current: Fiber | null, // rootFiber\n  workInProgress: Fiber, // \\u5F53\\u524D\\u5904\\u7406\\u7684 fiber\n  renderLanes: Lanes,\n): Fiber | null {\n  \\xB7\\xB7\\xB7\n\n  // current \\u6307\\u5411 alternate\\uFF0C\\u4E0D\\u4E3A null \\u5219\\u8868\\u793A\\u4E0D\\u662F\\u9996\\u6B21\\u6E32\\u67D3\n  if (current !== null) {\n    const oldProps = current.memoizedProps;\n    const newProps = workInProgress.pendingProps;\n\n    if (\n      oldProps !== newProps ||\n      hasLegacyContextChanged() ||\n      // Force a re-render if the implementation changed due to hot reload:\n      (__DEV__ ? workInProgress.type !== current.type : false)\n    ) {\n      // If props or context changed, mark the fiber as having performed work.\n      // This may be unset if the props are determined to be equal later (memo).\n      didReceiveUpdate = true;\n    } else {\n      // Neither props nor legacy context changes. Check if there's a pending\n      // update or context change.\n      const hasScheduledUpdateOrContext = checkScheduledUpdateOrContext(\n        current,\n        renderLanes,\n      );\n      if (\n        !hasScheduledUpdateOrContext \u0026\u0026\n        // If this is the second pass of an error or suspense boundary, there\n        // may not be work scheduled on \\`current\\`, so we check for this flag.\n        (workInProgress.flags \u0026 DidCapture) === NoFlags\n      ) {\n        // No pending updates or context. Bail out now.\n        didReceiveUpdate = false;\n        return attemptEarlyBailoutIfNoScheduledUpdate(\n          current,\n          workInProgress,\n          renderLanes,\n        );\n      }\n      if ((current.flags \u0026 ForceUpdateForLegacySuspense) !== NoFlags) {\n        // This is a special case that only exists for legacy mode.\n        // See https://github.com/facebook/react/pull/19216.\n        didReceiveUpdate = true;\n      } else {\n        // An update was scheduled on this fiber, but there are no new props\n        // nor legacy context. Set this to false. If an update queue or context\n        // consumer produces a changed value, it will set this to true. Otherwise,\n        // the component will assume the children have not changed and bail out.\n        didReceiveUpdate = false;\n      }\n    }\n  } else {\n\t\t// \\u9996\\u6B21\\u6E32\\u67D3\n\t\t// \\u8FD9\\u4E2A\\u53D8\\u91CF\\u53EF\\u4EE5\\u6682\\u65F6\\u4E0D\\u7406\\u4F1A\n    didReceiveUpdate = false;\n\n\t  \\xB7\\xB7\\xB7\n  }\n\n  // Before entering the begin phase, clear pending update priority.\n  // TODO: This assumes that we're about to evaluate the component and process\n  // the update queue. However, there's an exception: SimpleMemoComponent\n  // sometimes bails out later in the begin phase. This indicates that we should\n  // move this assignment out of the common path and into each branch.\n  workInProgress.lanes = NoLanes;\n\t// \\u6839\\u636E\\u5F53\\u524D fiber \\u7684\\u7C7B\\u578B\\u5BF9\\u7EC4\\u4EF6\\u8FDB\\u884C\\u5904\\u7406\n  switch (workInProgress.tag) {\n    \\xB7\\xB7\\xB7\n    case FunctionComponent: {\n      const Component = workInProgress.type;\n      const unresolvedProps = workInProgress.pendingProps;\n      const resolvedProps =\n        workInProgress.elementType === Component\n          ? unresolvedProps\n          : resolveDefaultProps(Component, unresolvedProps);\n      return updateFunctionComponent(\n        current,\n        workInProgress,\n        Component,\n        resolvedProps,\n        renderLanes,\n      );\n    }\n    case ClassComponent: {\n      const Component = workInProgress.type;\n      const unresolvedProps = workInProgress.pendingProps;\n      const resolvedProps =\n        workInProgress.elementType === Component\n          ? unresolvedProps\n          : resolveDefaultProps(Component, unresolvedProps);\n      return updateClassComponent(\n        current,\n        workInProgress,\n        Component,\n        resolvedProps,\n        renderLanes,\n      );\n    }\n\t  \\xB7\\xB7\\xB7\n  }\n\n  throw new Error(\n    \\`Unknown unit of work tag (\\${workInProgress.tag}). This error is likely caused by a bug in \\` +\n      'React. Please file an issue.',\n  );\n}\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.code,{children:\"completeUnitOfWork\"}),\" \\u51FD\\u6570\\u7528\\u4E8E\\u5B8C\\u6210\\u4E00\\u4E2A\\u7EC4\\u4EF6\\u7684\\u904D\\u5386\\u3002\\u5728\\u51FD\\u6570\\u5185\\u90E8\\uFF0C\\u4F1A\\u5148\\u68C0\\u67E5 \",(0,n.jsx)(e.code,{children:\"workInProgress\"}),\" \\u662F\\u5426\\u4E3A \",(0,n.jsx)(e.code,{children:\"null\"}),\"\\uFF0C\\u5982\\u679C\\u662F\\uFF0C\\u90A3\\u4E48\\u8BF4\\u660E\\u8FD9\\u4E2A\\u7EC4\\u4EF6\\u5DF2\\u7ECF\\u5B8C\\u6210\\u4E86\\u6240\\u6709\\u7684\\u66F4\\u65B0\\u64CD\\u4F5C\\u3002\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Todo\\uFF1A\\u7EE7\\u7EED\\u6DF1\\u6316\\u903B\\u8F91\"})]})}function y(r={}){let{wrapper:e}=r.components||{};return e?(0,n.jsx)(e,Object.assign({},r,{children:(0,n.jsx)(c,r)})):c(r)}var P=y;return b(x);})();\n;return Component;"},"__N_SSG":true},"page":"/[[...id]]","query":{"id":["react-src","render-task"]},"buildId":"mX_CC2RW8ik5AG8i3Lo6r","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>