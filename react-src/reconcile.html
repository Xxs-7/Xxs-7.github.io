<!DOCTYPE html><html lang="cn"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link data-next-font="" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/css/0b3619e1f688ca46.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0b3619e1f688ca46.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/_next/static/chunks/webpack-38cee4c0e358b1a3.js" defer=""></script><script src="/_next/static/chunks/framework-6698976aa0ea586d.js" defer=""></script><script src="/_next/static/chunks/main-9ca4f46f71f15dad.js" defer=""></script><script src="/_next/static/chunks/pages/_app-979b2f9127ab1499.js" defer=""></script><script src="/_next/static/chunks/7a7c95a0-ab903f899792323b.js" defer=""></script><script src="/_next/static/chunks/581-340f217658a3c725.js" defer=""></script><script src="/_next/static/chunks/pages/%5B%5B...id%5D%5D-706fc642a67ce3cd.js" defer=""></script><script src="/_next/static/F5pi5djmx84d7mAaXUDE6/_buildManifest.js" defer=""></script><script src="/_next/static/F5pi5djmx84d7mAaXUDE6/_ssgManifest.js" defer=""></script></head><body class=" bg-light text-light-text dark:bg-dark dark:text-dark-text max-sm:text-sm"><script>
                (function () {
                  function setTheme(newTheme) {
                    window.__theme = newTheme;
                    if (newTheme === 'dark') {
                      document.documentElement.classList.add('dark');
                    } else if (newTheme === 'light') {
                      document.documentElement.classList.remove('dark');
                    }
                  }

                  var preferredTheme;
                  try {
                    preferredTheme = localStorage.getItem('theme');
                  } catch (err) { }

                  window.__setPreferredTheme = function(newTheme) {
                    preferredTheme = newTheme;
                    setTheme(newTheme);
                    try {
                      localStorage.setItem('theme', newTheme);
                    } catch (err) { }
                  };

                  var initialTheme = preferredTheme;
                  var darkQuery = window.matchMedia('(prefers-color-scheme: dark)');

                  if (!initialTheme) {
                    initialTheme = darkQuery.matches ? 'dark' : 'light';
                  }
                  setTheme(initialTheme);

                  darkQuery.addEventListener('change', function (e) {
                    if (!preferredTheme) {
                      setTheme(e.matches ? 'dark' : 'light');
                    }
                  });
                })();
              </script><div id="__next"><header class="w-full fixed t-0 h-14 border-b backdrop-blur border-slate-900/10 dark:border-slate-300/10 z-10"><div class="w-full h-full flex flex-row items-center justify-between px-4"><div>厘清逻辑</div><div class="mr-2 flex flex-row items-center justify-between gap-2 text-xl"><a href="https://github.com/Xxs-7/Xxs-7.github.io" class="p-1 rounded-full hover:bg-dark/5 hover:dark:bg-light/5"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a><button class="block dark:hidden p-1 rounded-full hover:bg-dark/5 hover:dark:bg-light/5" type="button" aria-label="Use Dark Mode"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0z"></path><path d="M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"></path></svg></button><button type="button" class="hidden dark:block p-1 rounded-full hover:bg-dark/5 hover:dark:bg-light/5" aria-label="Use Light Mode"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0V0z"></path><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79zM1 10.5h3v2H1zM11 .55h2V3.5h-2zm8.04 2.495l1.408 1.407-1.79 1.79-1.407-1.408zm-1.8 15.115l1.79 1.8 1.41-1.41-1.8-1.79zM20 10.5h3v2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm-1 4h2v2.95h-2zm-7.45-.96l1.41 1.41 1.79-1.8-1.41-1.41z"></path></svg></button></div></div></header><div class="pt-14 flex max-w-screen overflow-y-scroll"><nav class="hidden lg:block fixed top-14 lg:bottom-0 lg:h-screen w-[18rem] pb-10 pl-4 overflow-y-auto min-h-screen z-10"><nav><ul class="mt-6 mb-12"><!--$--><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">html</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/html/SemanticsTag">语义化标签</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/html/anchor">锚元素</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">css</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/css/flex">flex 布局</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/css/grid">grid 布局</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/css/unit">布局单位</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/css/stacking-context">层叠上下文</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">javascript</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/javascript/promise">promise</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/javascript/async-await">async 和 await</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/javascript/execution-context">执行上下文</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/javascript/scopes">作用域</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">react</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react/roadmap">学习路线</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react/lifecycle">类组件生命周期</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react/hook">hook</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react/high-compoment">组件逻辑复用方案</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">react 源码</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/architecture">源码架构</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/fiber-node">fiber 节点</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/render-mode">渲染模式</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/execution-context">context</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/scheduler">scheduler</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/first-render">初次渲染</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/update-render">更新渲染</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/render-task">渲染任务的执行</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5 text-highlight"><a class="block" href="/react-src/reconcile">reconcile</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">实践</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/demo/music-player">音乐播放器</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/demo/font-advance">字体库优化</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">资料</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/material/roadmap">路线图</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">遐想</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/opinion/blog">博客</a></li></ul></li><!--/$--></ul></nav></nav><main class="relative lg:ml-[18rem] min-w-0 flex-1 pl-1 pr-5 pb-6"><article class="mx-auto xl:max-w-none overflow-x-hidden xl:ml-0 xl:mr-[18rem]"><h1 class="mdx-heading text-3xl font-extrabold my-6 text-header dark:text-header-dark" id="reconcile-原理">reconcile 原理</h1>
<blockquote class="border-l-2 border-current border-solid py-2 px-4 my-2 shadow-inner bg-[rgba(135,131,120,0.15)] dark:bg-highlight-dark bg-opacity-50 flex relative"><span class="block relative">
<p class="whitespace-pre-wrap my-2 ">前端框架的渲染指的是将数据和模版拼接到一起呈现到页面上。</p>
</span></blockquote>
<h2 class="mdx-heading text-2xl font-bold whitespace-pre-wrap mt-6 mb-4 group text-header  dark:text-header-dark" id="virtual-dom">virtual dom<a href="#virtual-dom" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h2>
<p class="whitespace-pre-wrap my-2 ">Virtual DOM 是真实 dom 的内存虚拟表示。本质是 javascript 对象，描述了真实 DOM 的信息和结构。
其用处是在需要更新页面内容时，通过先修改 virtual dom 对象，通过 dom diff 算法计算新旧 virtual dom 之间的差异，最后根据差异更新真实 dom。</p>
<h2 class="mdx-heading text-2xl font-bold whitespace-pre-wrap mt-6 mb-4 group text-header  dark:text-header-dark" id="为什么-virtual-dom-能提升性能">为什么 virtual dom 能提升性能<a href="#为什么-virtual-dom-能提升性能" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h2>
<ol class="ml-6 my-3 list-decimal">
<li class="leading-relaxed ">vitual dom 相当于 js 和真实 dom 之间增加了一层缓存，避免了没有必要的 dom 操作</li>
<li class="leading-relaxed ">vitual dom 到真实 dom 的更新是批处理，通过减少频繁操作 dom 来提升性能。</li>
</ol>
<h2 class="mdx-heading text-2xl font-bold whitespace-pre-wrap mt-6 mb-4 group text-header  dark:text-header-dark" id="dom-diff">dom diff<a href="#dom-diff" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h2>
<p class="whitespace-pre-wrap my-2 ">当组件发生变更，形成一棵新的 vitual dom，就会使用<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">diff</code>算法对新旧两棵树进行对比，根据对比结果修改更新真实<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">DOM</code>。</p>
<h2 class="mdx-heading text-2xl font-bold whitespace-pre-wrap mt-6 mb-4 group text-header  dark:text-header-dark" id="diff-的几种策略">diff 的几种策略<a href="#diff-的几种策略" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h2>
<ul class="ml-6 my-3 list-disc">
<li class="leading-relaxed "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">Web UI</code>中<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">DOM</code>节点跨层级的移动操作特别少，可以忽略不计。</li>
<li class="leading-relaxed ">拥有相同类型的两个组件将会生成相似的树形结构，拥有不同类型的两个组件将会生成不同的树形结构。</li>
<li class="leading-relaxed ">对于同一层级的一组子节点，它们可以通过唯一<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">id</code>进行区分</li>
</ul>
<h3 class="mdx-heading text-xl font-semibold whitespace-pre-wrap mt-4 mb-2 group text-header dark:text-header-dark" id="tree-diff">Tree diff<a href="#tree-diff" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h3>
<p class="whitespace-pre-wrap my-2 ">基于第一个策略，<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">react</code>只会对同一层次的节点进行比较，当发现节点不存在时，就会删除整个节点及其子节点，不会再进行比较，这样就只需要遍历一次，就能完成对整个<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">DOM</code>树的比较。也就是只考虑创建删除操作，不考虑变更位置。</p>
<h3 class="mdx-heading text-xl font-semibold whitespace-pre-wrap mt-4 mb-2 group text-header dark:text-header-dark" id="component-diff">Component diff<a href="#component-diff" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h3>
<ul class="ml-6 my-3 list-disc">
<li class="leading-relaxed ">如果是同一类型的组件，按照原策略继续比较虚拟 dom 树</li>
<li class="leading-relaxed ">如果不是，则将该组件判断为<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">dirty component</code>，从而替换整个组件下的所有子节点</li>
<li class="leading-relaxed ">对于同一类型的组件，有可能其<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">Virtual DOM</code>没有任何变化，如果能够确切的知道这点那可以节省大量的<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">diff</code>运算的时间，因此<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">React</code>允许用户通过<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">shouldComponentUpdate()</code>判断该组件是否需要进行<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">diff</code></li>
</ul>
<h3 class="mdx-heading text-xl font-semibold whitespace-pre-wrap mt-4 mb-2 group text-header dark:text-header-dark" id="element-diff">Element diff<a href="#element-diff" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h3>
<p class="whitespace-pre-wrap my-2 ">当节点处于同一层级时，<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">React diff</code>提供了三种节点操作：插入、移动和删除</p>
<ul class="ml-6 my-3 list-disc">
<li class="leading-relaxed ">插入：新的<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">component</code>类型不在老集合里 -&gt; 全新的节点，需要对新节点执行插入操作</li>
<li class="leading-relaxed ">移动：在老集合里有新<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">component</code>类型，且<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">element</code>是可更新的类型，<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">generateComponentChildren</code>已调用<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">receiveComponent</code>，这种情况下<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">prevChild=nextChild</code>，就需要做移动操作，可以复用以前的<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">dom</code>节点</li>
<li class="leading-relaxed ">删除：老的<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">component</code>类型，在新集合中也有，但对应的<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">element</code>不同则不能直接复用和更新，需要执行删除操作，或者老<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">component</code>不在新集合里，也需要执行删除操作</li>
</ul>
<h2 class="mdx-heading text-2xl font-bold whitespace-pre-wrap mt-6 mb-4 group text-header  dark:text-header-dark" id="同层级节点的-diff-过程">同层级节点的 diff 过程<a href="#同层级节点的-diff-过程" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h2>
<p class="whitespace-pre-wrap my-2 "><strong class="font-bold">首先明确下数据结构：新 vdom 是数组，即 newChildren；老 vdom 是 fiber 单链表，即 oldFiber。</strong></p>
<ol class="ml-6 my-3 list-decimal">
<li class="leading-relaxed ">
<p class="whitespace-pre-wrap my-2 ">新老 VDOM 都是从左边开始遍历的，按位置比较，即第 i 个老 vdom 和第 i 个新 vdom 比较，如果节点可以复用，那么先复用，然后新老 vdom 都往后移一位，否则就中止本轮循环。</p>
</li>
<li class="leading-relaxed ">
<p class="whitespace-pre-wrap my-2 ">如果经过 step1，新节点已经遍历完了，那么如果还有剩下的老节点，删除即可。</p>
</li>
<li class="leading-relaxed ">
<p class="whitespace-pre-wrap my-2 ">如果经过 step1，老节点没了，新节点还有，那么新节点逐个新增即可。初次渲染走的就是这里。</p>
</li>
<li class="leading-relaxed ">
<p class="whitespace-pre-wrap my-2 ">走到现在，新老节点都还有，但是是乱序的。因此可以把 oldFiber 单链表做成 Map，即 existingChildren，接下来遍历 newChildren，找到能复用的 fiber，就复用并且从 existingChildren 删除这个 fiber。</p>
</li>
<li class="leading-relaxed ">
<p class="whitespace-pre-wrap my-2 ">经历过 step4 之后，发现老节点 existingChildren 中还有没被复用的，全部删除即可。</p>
</li>
</ol>
<p class="whitespace-pre-wrap my-2 ">判断子节点类型：</p>
<ul class="ml-6 my-3 list-disc">
<li class="leading-relaxed ">单个节点</li>
<li class="leading-relaxed ">数组</li>
<li class="leading-relaxed ">字符串或数字</li>
</ul>
<h2 class="mdx-heading text-2xl font-bold whitespace-pre-wrap mt-6 mb-4 group text-header  dark:text-header-dark" id="源码">源码<a href="#源码" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h2>
<pre><!--$--><div class="prism-code language-jsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// react/packages/react-reconciler/src/ReactFiberBeginWork.old.js</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">export</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">reconcileChildren</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">current</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Fiber</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">|</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">workInProgress</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Fiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">nextChildren</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> any</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">renderLanes</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Lanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">current </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 首次渲染</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// If this is a fresh new component that hasn&#x27;t been rendered yet, we</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// won&#x27;t update its child set by applying minimal side-effects. Instead,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// we will add them all to the child before it gets rendered. That means</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// we can optimize this reconciliation pass by not tracking side-effects.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">child</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">mountChildFibers</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      nextChildren</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      renderLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 更新渲染</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// If the current child is the same as the work in progress, it means that</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// we haven&#x27;t yet started any work on these children. Therefore, we use</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// the clone algorithm to create a copy of all the current children.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// If we had any progressed work already, that is invalid at this point so</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// let&#x27;s throw it out.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">child</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">reconcileChildFibers</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      workInProgress</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      current</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">child</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      nextChildren</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      renderLanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">mountChildFibers</code> 和 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">reconcileChildFibers</code>  深挖还是同一个函数 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">reconcileChildFibers</code></p>
<pre><!--$--><div class="prism-code language-jsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">export</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">reconcileChildFibers</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">ChildReconciler</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">createChildReconciler</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">export</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">mountChildFibers</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">ChildReconciler</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">createChildReconciler</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">false</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">createChildReconciler</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">shouldTrackSideEffects</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">ChildReconciler</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 特别多的小函数</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// This API will tag the children with the side-effect of the reconciliation</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// itself. They will be added to the side-effect list as we pass through the</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// children and the parent.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">reconcileChildFibers</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">returnFiber</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Fiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">currentFirstChild</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Fiber</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">|</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">newChild</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> any</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">lanes</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Lanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Fiber</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">|</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// This function is not recursive.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// If the top level item is an array, we treat it as a set of children,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// not as a fragment. Nested arrays on the other hand will be treated as</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// fragment nodes. Recursion happens at the normal flow.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Handle top level unkeyed fragments as if they were arrays.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// This leads to an ambiguity between &lt;&gt;{[...]}&lt;/&gt; and &lt;&gt;...&lt;/&gt;.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// We treat the ambiguous cases above the same.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> isUnkeyedTopLevelFragment </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="whitespace-pre-wrap"> newChild </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;object&#x27;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      newChild </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      newChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">type</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">REACT_FRAGMENT_TYPE</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      newChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">key</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">isUnkeyedTopLevelFragment</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      newChild </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> newChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">props</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">children</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Handle object types</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="whitespace-pre-wrap"> newChild </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;object&#x27;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"> newChild </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">			</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 处理单个子节点的情况</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">switch</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">newChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">$$</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">REACT_ELEMENT_TYPE</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">placeSingleChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">            </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">reconcileSingleElement</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">              returnFiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">              currentFirstChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">              newChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">              lanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">            </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">REACT_PORTAL_TYPE</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          ···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">REACT_LAZY_TYPE</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          ···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">			</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 多个子节点</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">isArray</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">newChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">reconcileChildrenArray</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          returnFiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          currentFirstChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          newChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          lanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">			</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 处理子组件为迭代器的情况，实际上逻辑和数组差不多</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">getIteratorFn</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">newChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">reconcileChildrenIterator</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          returnFiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          currentFirstChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          newChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          lanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">throwOnInvalidObjectType</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">returnFiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> newChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 处理子组件是文本的情况</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="whitespace-pre-wrap"> newChild </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;string&#x27;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"> newChild </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">||</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="whitespace-pre-wrap"> newChild </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;number&#x27;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">placeSingleChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">reconcileSingleTextNode</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          returnFiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          currentFirstChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;&#x27;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">+</span><span class="whitespace-pre-wrap"> newChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          lanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">__DEV__</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      ···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Remaining cases are all treated as empty.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">deleteRemainingChildren</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">returnFiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> currentFirstChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> reconcileChildFibers</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">shouldTrackSideEffects</code> ：用于表示处理当前组件时是否应该跟踪副作用。副作用是指那些在组件渲染过程中可能引起的额外操作，例如访问网络、修改状态等。这里更新渲染相较于初次渲染就是多了副作用的处理逻辑。</p>
<p class="whitespace-pre-wrap my-2 ">处理新老相同节点的 diff，代码较多，且都比较重要，建议看源码。</p>
<p class="whitespace-pre-wrap my-2 ">此时更新后的组件的 fiber 还未创建，只有实例（类组件实例化，函数组件执行）<em><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">element</code></em> 。</p>
<pre><!--$--><div class="prism-code language-jsx rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// react/packages/react-reconciler/src/ReactChildFiber.old.js</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">reconcileSingleElement</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">returnFiber</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Fiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 父组件的 fiber</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">currentFirstChild</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Fiber</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">|</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 子组件第一个 fiber</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">element</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">ReactElement</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">lanes</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Lanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Fiber</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> key </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> element</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">key</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="whitespace-pre-wrap"> child </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> currentFirstChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 子组件的 fiber 在父组件中是链表存储</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">while</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">child </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">			</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// TODO: If key === null and child.key === null, then this only applies to</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// the first item in the list.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">child</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">key</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> key</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 查找 element 对应的旧 fiber，</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> elementType </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> element</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">type</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">elementType </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">REACT_FRAGMENT_TYPE</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">					···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">				</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">					···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">				</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">			</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">				</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 进入到该函数中，element 只为单组件，其他的旧 fiber 都可以删除了</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">deleteChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">returnFiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> child</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      child </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> child</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">sibling</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 复用不了旧组件的 fiber，那只能新建 fiber 了。</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">element</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">type</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">REACT_FRAGMENT_TYPE</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> created </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">createFiberFromFragment</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        element</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">props</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">children</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        returnFiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">mode</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        lanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        element</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">key</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      created</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> returnFiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> created</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> created </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">createFiberFromElement</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">element</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> returnFiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">mode</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> lanes</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      created</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">ref</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">coerceRef</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">returnFiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> currentFirstChild</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> element</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      created</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> returnFiber</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> created</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 ">处理子元素为数组的情况，那这个函数的用途和<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">reconcileSingleElement</code> 的目标差不多，就是通过 diff 算法构建出 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">newChildren</code> 对应新 fiber （也会判断是否复用就 fiber）</p></article><aside class="hidden xl:block fixed top-14 right-0 w-[18rem] py-6 overflow-y-auto"><ul class="text-sm font-medium"><li class="pl-2 text-base">reconcile 原理</li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-4"><a href="#virtual-dom" class="block py-1">virtual dom</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-4"><a href="#为什么-virtual-dom-能提升性能" class="block py-1">为什么 virtual dom 能提升性能</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-4"><a href="#dom-diff" class="block py-1">dom diff</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-4"><a href="#diff-的几种策略" class="block py-1">diff 的几种策略</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-6 text-xs"><a href="#tree-diff" class="block py-1">Tree diff</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-6 text-xs"><a href="#component-diff" class="block py-1">Component diff</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-6 text-xs"><a href="#element-diff" class="block py-1">Element diff</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-4"><a href="#同层级节点的-diff-过程" class="block py-1">同层级节点的 diff 过程</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-4"><a href="#源码" class="block py-1">源码</a></li></ul></aside></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"toc":[{"text":"reconcile 原理","hash":"#reconcile-原理","depth":1},{"text":"virtual dom","hash":"#virtual-dom","depth":2},{"text":"为什么 virtual dom 能提升性能","hash":"#为什么-virtual-dom-能提升性能","depth":2},{"text":"dom diff","hash":"#dom-diff","depth":2},{"text":"diff 的几种策略","hash":"#diff-的几种策略","depth":2},{"text":"Tree diff","hash":"#tree-diff","depth":3},{"text":"Component diff","hash":"#component-diff","depth":3},{"text":"Element diff","hash":"#element-diff","depth":3},{"text":"同层级节点的 diff 过程","hash":"#同层级节点的-diff-过程","depth":2},{"text":"源码","hash":"#源码","depth":2}],"code":"var Component=(()=\u003e{var a=Object.create;var t=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var m=Object.getOwnPropertyNames;var u=Object.getPrototypeOf,p=Object.prototype.hasOwnProperty;var C=(i,e)=\u003e()=\u003e(e||i((e={exports:{}}).exports,e),e.exports),b=(i,e)=\u003e{for(var r in e)t(i,r,{get:e[r],enumerable:!0})},c=(i,e,r,d)=\u003e{if(e\u0026\u0026typeof e==\"object\"||typeof e==\"function\")for(let l of m(e))!p.call(i,l)\u0026\u0026l!==r\u0026\u0026t(i,l,{get:()=\u003ee[l],enumerable:!(d=f(e,l))||d.enumerable});return i};var F=(i,e,r)=\u003e(r=i!=null?a(u(i)):{},c(e||!i||!i.__esModule?t(r,\"default\",{value:i,enumerable:!0}):r,i)),w=i=\u003ec(t({},\"__esModule\",{value:!0}),i);var o=C((E,h)=\u003e{h.exports=_jsx_runtime});var T={};b(T,{default:()=\u003ey});var n=F(o());function s(i){let e=Object.assign({h1:\"h1\",blockquote:\"blockquote\",p:\"p\",h2:\"h2\",ol:\"ol\",li:\"li\",code:\"code\",ul:\"ul\",h3:\"h3\",strong:\"strong\",pre:\"pre\",em:\"em\"},i.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(e.h1,{hash:\"reconcile-\\u539F\\u7406\",children:\"reconcile \\u539F\\u7406\"}),`\n`,(0,n.jsxs)(e.blockquote,{children:[`\n`,(0,n.jsx)(e.p,{children:\"\\u524D\\u7AEF\\u6846\\u67B6\\u7684\\u6E32\\u67D3\\u6307\\u7684\\u662F\\u5C06\\u6570\\u636E\\u548C\\u6A21\\u7248\\u62FC\\u63A5\\u5230\\u4E00\\u8D77\\u5448\\u73B0\\u5230\\u9875\\u9762\\u4E0A\\u3002\"}),`\n`]}),`\n`,(0,n.jsx)(e.h2,{hash:\"virtual-dom\",children:\"virtual dom\"}),`\n`,(0,n.jsx)(e.p,{children:`Virtual DOM \\u662F\\u771F\\u5B9E dom \\u7684\\u5185\\u5B58\\u865A\\u62DF\\u8868\\u793A\\u3002\\u672C\\u8D28\\u662F javascript \\u5BF9\\u8C61\\uFF0C\\u63CF\\u8FF0\\u4E86\\u771F\\u5B9E DOM \\u7684\\u4FE1\\u606F\\u548C\\u7ED3\\u6784\\u3002\n\\u5176\\u7528\\u5904\\u662F\\u5728\\u9700\\u8981\\u66F4\\u65B0\\u9875\\u9762\\u5185\\u5BB9\\u65F6\\uFF0C\\u901A\\u8FC7\\u5148\\u4FEE\\u6539 virtual dom \\u5BF9\\u8C61\\uFF0C\\u901A\\u8FC7 dom diff \\u7B97\\u6CD5\\u8BA1\\u7B97\\u65B0\\u65E7 virtual dom \\u4E4B\\u95F4\\u7684\\u5DEE\\u5F02\\uFF0C\\u6700\\u540E\\u6839\\u636E\\u5DEE\\u5F02\\u66F4\\u65B0\\u771F\\u5B9E dom\\u3002`}),`\n`,(0,n.jsx)(e.h2,{hash:\"\\u4E3A\\u4EC0\\u4E48-virtual-dom-\\u80FD\\u63D0\\u5347\\u6027\\u80FD\",children:\"\\u4E3A\\u4EC0\\u4E48 virtual dom \\u80FD\\u63D0\\u5347\\u6027\\u80FD\"}),`\n`,(0,n.jsxs)(e.ol,{children:[`\n`,(0,n.jsx)(e.li,{children:\"vitual dom \\u76F8\\u5F53\\u4E8E js \\u548C\\u771F\\u5B9E dom \\u4E4B\\u95F4\\u589E\\u52A0\\u4E86\\u4E00\\u5C42\\u7F13\\u5B58\\uFF0C\\u907F\\u514D\\u4E86\\u6CA1\\u6709\\u5FC5\\u8981\\u7684 dom \\u64CD\\u4F5C\"}),`\n`,(0,n.jsx)(e.li,{children:\"vitual dom \\u5230\\u771F\\u5B9E dom \\u7684\\u66F4\\u65B0\\u662F\\u6279\\u5904\\u7406\\uFF0C\\u901A\\u8FC7\\u51CF\\u5C11\\u9891\\u7E41\\u64CD\\u4F5C dom \\u6765\\u63D0\\u5347\\u6027\\u80FD\\u3002\"}),`\n`]}),`\n`,(0,n.jsx)(e.h2,{hash:\"dom-diff\",children:\"dom diff\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u5F53\\u7EC4\\u4EF6\\u53D1\\u751F\\u53D8\\u66F4\\uFF0C\\u5F62\\u6210\\u4E00\\u68F5\\u65B0\\u7684 vitual dom\\uFF0C\\u5C31\\u4F1A\\u4F7F\\u7528\",(0,n.jsx)(e.code,{children:\"diff\"}),\"\\u7B97\\u6CD5\\u5BF9\\u65B0\\u65E7\\u4E24\\u68F5\\u6811\\u8FDB\\u884C\\u5BF9\\u6BD4\\uFF0C\\u6839\\u636E\\u5BF9\\u6BD4\\u7ED3\\u679C\\u4FEE\\u6539\\u66F4\\u65B0\\u771F\\u5B9E\",(0,n.jsx)(e.code,{children:\"DOM\"}),\"\\u3002\"]}),`\n`,(0,n.jsx)(e.h2,{hash:\"diff-\\u7684\\u51E0\\u79CD\\u7B56\\u7565\",children:\"diff \\u7684\\u51E0\\u79CD\\u7B56\\u7565\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"Web UI\"}),\"\\u4E2D\",(0,n.jsx)(e.code,{children:\"DOM\"}),\"\\u8282\\u70B9\\u8DE8\\u5C42\\u7EA7\\u7684\\u79FB\\u52A8\\u64CD\\u4F5C\\u7279\\u522B\\u5C11\\uFF0C\\u53EF\\u4EE5\\u5FFD\\u7565\\u4E0D\\u8BA1\\u3002\"]}),`\n`,(0,n.jsx)(e.li,{children:\"\\u62E5\\u6709\\u76F8\\u540C\\u7C7B\\u578B\\u7684\\u4E24\\u4E2A\\u7EC4\\u4EF6\\u5C06\\u4F1A\\u751F\\u6210\\u76F8\\u4F3C\\u7684\\u6811\\u5F62\\u7ED3\\u6784\\uFF0C\\u62E5\\u6709\\u4E0D\\u540C\\u7C7B\\u578B\\u7684\\u4E24\\u4E2A\\u7EC4\\u4EF6\\u5C06\\u4F1A\\u751F\\u6210\\u4E0D\\u540C\\u7684\\u6811\\u5F62\\u7ED3\\u6784\\u3002\"}),`\n`,(0,n.jsxs)(e.li,{children:[\"\\u5BF9\\u4E8E\\u540C\\u4E00\\u5C42\\u7EA7\\u7684\\u4E00\\u7EC4\\u5B50\\u8282\\u70B9\\uFF0C\\u5B83\\u4EEC\\u53EF\\u4EE5\\u901A\\u8FC7\\u552F\\u4E00\",(0,n.jsx)(e.code,{children:\"id\"}),\"\\u8FDB\\u884C\\u533A\\u5206\"]}),`\n`]}),`\n`,(0,n.jsx)(e.h3,{hash:\"tree-diff\",children:\"Tree diff\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u57FA\\u4E8E\\u7B2C\\u4E00\\u4E2A\\u7B56\\u7565\\uFF0C\",(0,n.jsx)(e.code,{children:\"react\"}),\"\\u53EA\\u4F1A\\u5BF9\\u540C\\u4E00\\u5C42\\u6B21\\u7684\\u8282\\u70B9\\u8FDB\\u884C\\u6BD4\\u8F83\\uFF0C\\u5F53\\u53D1\\u73B0\\u8282\\u70B9\\u4E0D\\u5B58\\u5728\\u65F6\\uFF0C\\u5C31\\u4F1A\\u5220\\u9664\\u6574\\u4E2A\\u8282\\u70B9\\u53CA\\u5176\\u5B50\\u8282\\u70B9\\uFF0C\\u4E0D\\u4F1A\\u518D\\u8FDB\\u884C\\u6BD4\\u8F83\\uFF0C\\u8FD9\\u6837\\u5C31\\u53EA\\u9700\\u8981\\u904D\\u5386\\u4E00\\u6B21\\uFF0C\\u5C31\\u80FD\\u5B8C\\u6210\\u5BF9\\u6574\\u4E2A\",(0,n.jsx)(e.code,{children:\"DOM\"}),\"\\u6811\\u7684\\u6BD4\\u8F83\\u3002\\u4E5F\\u5C31\\u662F\\u53EA\\u8003\\u8651\\u521B\\u5EFA\\u5220\\u9664\\u64CD\\u4F5C\\uFF0C\\u4E0D\\u8003\\u8651\\u53D8\\u66F4\\u4F4D\\u7F6E\\u3002\"]}),`\n`,(0,n.jsx)(e.h3,{hash:\"component-diff\",children:\"Component diff\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"\\u5982\\u679C\\u662F\\u540C\\u4E00\\u7C7B\\u578B\\u7684\\u7EC4\\u4EF6\\uFF0C\\u6309\\u7167\\u539F\\u7B56\\u7565\\u7EE7\\u7EED\\u6BD4\\u8F83\\u865A\\u62DF dom \\u6811\"}),`\n`,(0,n.jsxs)(e.li,{children:[\"\\u5982\\u679C\\u4E0D\\u662F\\uFF0C\\u5219\\u5C06\\u8BE5\\u7EC4\\u4EF6\\u5224\\u65AD\\u4E3A\",(0,n.jsx)(e.code,{children:\"dirty component\"}),\"\\uFF0C\\u4ECE\\u800C\\u66FF\\u6362\\u6574\\u4E2A\\u7EC4\\u4EF6\\u4E0B\\u7684\\u6240\\u6709\\u5B50\\u8282\\u70B9\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"\\u5BF9\\u4E8E\\u540C\\u4E00\\u7C7B\\u578B\\u7684\\u7EC4\\u4EF6\\uFF0C\\u6709\\u53EF\\u80FD\\u5176\",(0,n.jsx)(e.code,{children:\"Virtual DOM\"}),\"\\u6CA1\\u6709\\u4EFB\\u4F55\\u53D8\\u5316\\uFF0C\\u5982\\u679C\\u80FD\\u591F\\u786E\\u5207\\u7684\\u77E5\\u9053\\u8FD9\\u70B9\\u90A3\\u53EF\\u4EE5\\u8282\\u7701\\u5927\\u91CF\\u7684\",(0,n.jsx)(e.code,{children:\"diff\"}),\"\\u8FD0\\u7B97\\u7684\\u65F6\\u95F4\\uFF0C\\u56E0\\u6B64\",(0,n.jsx)(e.code,{children:\"React\"}),\"\\u5141\\u8BB8\\u7528\\u6237\\u901A\\u8FC7\",(0,n.jsx)(e.code,{children:\"shouldComponentUpdate()\"}),\"\\u5224\\u65AD\\u8BE5\\u7EC4\\u4EF6\\u662F\\u5426\\u9700\\u8981\\u8FDB\\u884C\",(0,n.jsx)(e.code,{children:\"diff\"})]}),`\n`]}),`\n`,(0,n.jsx)(e.h3,{hash:\"element-diff\",children:\"Element diff\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u5F53\\u8282\\u70B9\\u5904\\u4E8E\\u540C\\u4E00\\u5C42\\u7EA7\\u65F6\\uFF0C\",(0,n.jsx)(e.code,{children:\"React diff\"}),\"\\u63D0\\u4F9B\\u4E86\\u4E09\\u79CD\\u8282\\u70B9\\u64CD\\u4F5C\\uFF1A\\u63D2\\u5165\\u3001\\u79FB\\u52A8\\u548C\\u5220\\u9664\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"\\u63D2\\u5165\\uFF1A\\u65B0\\u7684\",(0,n.jsx)(e.code,{children:\"component\"}),\"\\u7C7B\\u578B\\u4E0D\\u5728\\u8001\\u96C6\\u5408\\u91CC -\u003e \\u5168\\u65B0\\u7684\\u8282\\u70B9\\uFF0C\\u9700\\u8981\\u5BF9\\u65B0\\u8282\\u70B9\\u6267\\u884C\\u63D2\\u5165\\u64CD\\u4F5C\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"\\u79FB\\u52A8\\uFF1A\\u5728\\u8001\\u96C6\\u5408\\u91CC\\u6709\\u65B0\",(0,n.jsx)(e.code,{children:\"component\"}),\"\\u7C7B\\u578B\\uFF0C\\u4E14\",(0,n.jsx)(e.code,{children:\"element\"}),\"\\u662F\\u53EF\\u66F4\\u65B0\\u7684\\u7C7B\\u578B\\uFF0C\",(0,n.jsx)(e.code,{children:\"generateComponentChildren\"}),\"\\u5DF2\\u8C03\\u7528\",(0,n.jsx)(e.code,{children:\"receiveComponent\"}),\"\\uFF0C\\u8FD9\\u79CD\\u60C5\\u51B5\\u4E0B\",(0,n.jsx)(e.code,{children:\"prevChild=nextChild\"}),\"\\uFF0C\\u5C31\\u9700\\u8981\\u505A\\u79FB\\u52A8\\u64CD\\u4F5C\\uFF0C\\u53EF\\u4EE5\\u590D\\u7528\\u4EE5\\u524D\\u7684\",(0,n.jsx)(e.code,{children:\"dom\"}),\"\\u8282\\u70B9\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"\\u5220\\u9664\\uFF1A\\u8001\\u7684\",(0,n.jsx)(e.code,{children:\"component\"}),\"\\u7C7B\\u578B\\uFF0C\\u5728\\u65B0\\u96C6\\u5408\\u4E2D\\u4E5F\\u6709\\uFF0C\\u4F46\\u5BF9\\u5E94\\u7684\",(0,n.jsx)(e.code,{children:\"element\"}),\"\\u4E0D\\u540C\\u5219\\u4E0D\\u80FD\\u76F4\\u63A5\\u590D\\u7528\\u548C\\u66F4\\u65B0\\uFF0C\\u9700\\u8981\\u6267\\u884C\\u5220\\u9664\\u64CD\\u4F5C\\uFF0C\\u6216\\u8005\\u8001\",(0,n.jsx)(e.code,{children:\"component\"}),\"\\u4E0D\\u5728\\u65B0\\u96C6\\u5408\\u91CC\\uFF0C\\u4E5F\\u9700\\u8981\\u6267\\u884C\\u5220\\u9664\\u64CD\\u4F5C\"]}),`\n`]}),`\n`,(0,n.jsx)(e.h2,{hash:\"\\u540C\\u5C42\\u7EA7\\u8282\\u70B9\\u7684-diff-\\u8FC7\\u7A0B\",children:\"\\u540C\\u5C42\\u7EA7\\u8282\\u70B9\\u7684 diff \\u8FC7\\u7A0B\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.strong,{children:\"\\u9996\\u5148\\u660E\\u786E\\u4E0B\\u6570\\u636E\\u7ED3\\u6784\\uFF1A\\u65B0 vdom \\u662F\\u6570\\u7EC4\\uFF0C\\u5373 newChildren\\uFF1B\\u8001 vdom \\u662F fiber \\u5355\\u94FE\\u8868\\uFF0C\\u5373 oldFiber\\u3002\"})}),`\n`,(0,n.jsxs)(e.ol,{children:[`\n`,(0,n.jsxs)(e.li,{children:[`\n`,(0,n.jsx)(e.p,{children:\"\\u65B0\\u8001 VDOM \\u90FD\\u662F\\u4ECE\\u5DE6\\u8FB9\\u5F00\\u59CB\\u904D\\u5386\\u7684\\uFF0C\\u6309\\u4F4D\\u7F6E\\u6BD4\\u8F83\\uFF0C\\u5373\\u7B2C i \\u4E2A\\u8001 vdom \\u548C\\u7B2C i \\u4E2A\\u65B0 vdom \\u6BD4\\u8F83\\uFF0C\\u5982\\u679C\\u8282\\u70B9\\u53EF\\u4EE5\\u590D\\u7528\\uFF0C\\u90A3\\u4E48\\u5148\\u590D\\u7528\\uFF0C\\u7136\\u540E\\u65B0\\u8001 vdom \\u90FD\\u5F80\\u540E\\u79FB\\u4E00\\u4F4D\\uFF0C\\u5426\\u5219\\u5C31\\u4E2D\\u6B62\\u672C\\u8F6E\\u5FAA\\u73AF\\u3002\"}),`\n`]}),`\n`,(0,n.jsxs)(e.li,{children:[`\n`,(0,n.jsx)(e.p,{children:\"\\u5982\\u679C\\u7ECF\\u8FC7 step1\\uFF0C\\u65B0\\u8282\\u70B9\\u5DF2\\u7ECF\\u904D\\u5386\\u5B8C\\u4E86\\uFF0C\\u90A3\\u4E48\\u5982\\u679C\\u8FD8\\u6709\\u5269\\u4E0B\\u7684\\u8001\\u8282\\u70B9\\uFF0C\\u5220\\u9664\\u5373\\u53EF\\u3002\"}),`\n`]}),`\n`,(0,n.jsxs)(e.li,{children:[`\n`,(0,n.jsx)(e.p,{children:\"\\u5982\\u679C\\u7ECF\\u8FC7 step1\\uFF0C\\u8001\\u8282\\u70B9\\u6CA1\\u4E86\\uFF0C\\u65B0\\u8282\\u70B9\\u8FD8\\u6709\\uFF0C\\u90A3\\u4E48\\u65B0\\u8282\\u70B9\\u9010\\u4E2A\\u65B0\\u589E\\u5373\\u53EF\\u3002\\u521D\\u6B21\\u6E32\\u67D3\\u8D70\\u7684\\u5C31\\u662F\\u8FD9\\u91CC\\u3002\"}),`\n`]}),`\n`,(0,n.jsxs)(e.li,{children:[`\n`,(0,n.jsx)(e.p,{children:\"\\u8D70\\u5230\\u73B0\\u5728\\uFF0C\\u65B0\\u8001\\u8282\\u70B9\\u90FD\\u8FD8\\u6709\\uFF0C\\u4F46\\u662F\\u662F\\u4E71\\u5E8F\\u7684\\u3002\\u56E0\\u6B64\\u53EF\\u4EE5\\u628A oldFiber \\u5355\\u94FE\\u8868\\u505A\\u6210 Map\\uFF0C\\u5373 existingChildren\\uFF0C\\u63A5\\u4E0B\\u6765\\u904D\\u5386 newChildren\\uFF0C\\u627E\\u5230\\u80FD\\u590D\\u7528\\u7684 fiber\\uFF0C\\u5C31\\u590D\\u7528\\u5E76\\u4E14\\u4ECE existingChildren \\u5220\\u9664\\u8FD9\\u4E2A fiber\\u3002\"}),`\n`]}),`\n`,(0,n.jsxs)(e.li,{children:[`\n`,(0,n.jsx)(e.p,{children:\"\\u7ECF\\u5386\\u8FC7 step4 \\u4E4B\\u540E\\uFF0C\\u53D1\\u73B0\\u8001\\u8282\\u70B9 existingChildren \\u4E2D\\u8FD8\\u6709\\u6CA1\\u88AB\\u590D\\u7528\\u7684\\uFF0C\\u5168\\u90E8\\u5220\\u9664\\u5373\\u53EF\\u3002\"}),`\n`]}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"\\u5224\\u65AD\\u5B50\\u8282\\u70B9\\u7C7B\\u578B\\uFF1A\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"\\u5355\\u4E2A\\u8282\\u70B9\"}),`\n`,(0,n.jsx)(e.li,{children:\"\\u6570\\u7EC4\"}),`\n`,(0,n.jsx)(e.li,{children:\"\\u5B57\\u7B26\\u4E32\\u6216\\u6570\\u5B57\"}),`\n`]}),`\n`,(0,n.jsx)(e.h2,{hash:\"\\u6E90\\u7801\",children:\"\\u6E90\\u7801\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-jsx\",children:`// react/packages/react-reconciler/src/ReactFiberBeginWork.old.js\nexport function reconcileChildren(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  nextChildren: any,\n  renderLanes: Lanes,\n) {\n  if (current === null) {\n\t\t// \\u9996\\u6B21\\u6E32\\u67D3\n    // If this is a fresh new component that hasn't been rendered yet, we\n    // won't update its child set by applying minimal side-effects. Instead,\n    // we will add them all to the child before it gets rendered. That means\n    // we can optimize this reconciliation pass by not tracking side-effects.\n    workInProgress.child = mountChildFibers(\n      workInProgress,\n      null,\n      nextChildren,\n      renderLanes,\n    );\n  } else {\n\t\t// \\u66F4\\u65B0\\u6E32\\u67D3\n    // If the current child is the same as the work in progress, it means that\n    // we haven't yet started any work on these children. Therefore, we use\n    // the clone algorithm to create a copy of all the current children.\n\n    // If we had any progressed work already, that is invalid at this point so\n    // let's throw it out.\n    workInProgress.child = reconcileChildFibers(\n      workInProgress,\n      current.child,\n      nextChildren,\n      renderLanes,\n    );\n  }\n}\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.code,{children:\"mountChildFibers\"}),\" \\u548C \",(0,n.jsx)(e.code,{children:\"reconcileChildFibers\"}),\"  \\u6DF1\\u6316\\u8FD8\\u662F\\u540C\\u4E00\\u4E2A\\u51FD\\u6570 \",(0,n.jsx)(e.code,{children:\"reconcileChildFibers\"})]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-jsx\",children:`export const reconcileChildFibers: ChildReconciler = createChildReconciler(\n  true,\n);\nexport const mountChildFibers: ChildReconciler = createChildReconciler(false);\n\nfunction createChildReconciler(shouldTrackSideEffects): ChildReconciler {\n\t// \\u7279\\u522B\\u591A\\u7684\\u5C0F\\u51FD\\u6570\n\t\\xB7\\xB7\\xB7\n\n  // This API will tag the children with the side-effect of the reconciliation\n  // itself. They will be added to the side-effect list as we pass through the\n  // children and the parent.\n  function reconcileChildFibers(\n    returnFiber: Fiber,\n    currentFirstChild: Fiber | null,\n    newChild: any,\n    lanes: Lanes,\n  ): Fiber | null {\n    // This function is not recursive.\n    // If the top level item is an array, we treat it as a set of children,\n    // not as a fragment. Nested arrays on the other hand will be treated as\n    // fragment nodes. Recursion happens at the normal flow.\n\n    // Handle top level unkeyed fragments as if they were arrays.\n    // This leads to an ambiguity between \u003c\u003e{[...]}\u003c/\u003e and \u003c\u003e...\u003c/\u003e.\n    // We treat the ambiguous cases above the same.\n    const isUnkeyedTopLevelFragment =\n      typeof newChild === 'object' \u0026\u0026\n      newChild !== null \u0026\u0026\n      newChild.type === REACT_FRAGMENT_TYPE \u0026\u0026\n      newChild.key === null;\n    if (isUnkeyedTopLevelFragment) {\n      newChild = newChild.props.children;\n    }\n\n    // Handle object types\n    if (typeof newChild === 'object' \u0026\u0026 newChild !== null) {\n\t\t\t// \\u5904\\u7406\\u5355\\u4E2A\\u5B50\\u8282\\u70B9\\u7684\\u60C5\\u51B5\n      switch (newChild.$$typeof) {\n        case REACT_ELEMENT_TYPE:\n          return placeSingleChild(\n            reconcileSingleElement(\n              returnFiber,\n              currentFirstChild,\n              newChild,\n              lanes,\n            ),\n          );\n        case REACT_PORTAL_TYPE:\n          \\xB7\\xB7\\xB7\n        case REACT_LAZY_TYPE:\n          \\xB7\\xB7\\xB7\n      }\n\n\t\t\t// \\u591A\\u4E2A\\u5B50\\u8282\\u70B9\n      if (isArray(newChild)) {\n        return reconcileChildrenArray(\n          returnFiber,\n          currentFirstChild,\n          newChild,\n          lanes,\n        );\n      }\n\n\t\t\t// \\u5904\\u7406\\u5B50\\u7EC4\\u4EF6\\u4E3A\\u8FED\\u4EE3\\u5668\\u7684\\u60C5\\u51B5\\uFF0C\\u5B9E\\u9645\\u4E0A\\u903B\\u8F91\\u548C\\u6570\\u7EC4\\u5DEE\\u4E0D\\u591A\n      if (getIteratorFn(newChild)) {\n        return reconcileChildrenIterator(\n          returnFiber,\n          currentFirstChild,\n          newChild,\n          lanes,\n        );\n      }\n\n      throwOnInvalidObjectType(returnFiber, newChild);\n    }\n\n\t\t// \\u5904\\u7406\\u5B50\\u7EC4\\u4EF6\\u662F\\u6587\\u672C\\u7684\\u60C5\\u51B5\n    if (\n      (typeof newChild === 'string' \u0026\u0026 newChild !== '') ||\n      typeof newChild === 'number'\n    ) {\n      return placeSingleChild(\n        reconcileSingleTextNode(\n          returnFiber,\n          currentFirstChild,\n          '' + newChild,\n          lanes,\n        ),\n      );\n    }\n\n    if (__DEV__) {\n      \\xB7\\xB7\\xB7\n    }\n\n    // Remaining cases are all treated as empty.\n    return deleteRemainingChildren(returnFiber, currentFirstChild);\n  }\n\n  return reconcileChildFibers;\n}\n\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.code,{children:\"shouldTrackSideEffects\"}),\" \\uFF1A\\u7528\\u4E8E\\u8868\\u793A\\u5904\\u7406\\u5F53\\u524D\\u7EC4\\u4EF6\\u65F6\\u662F\\u5426\\u5E94\\u8BE5\\u8DDF\\u8E2A\\u526F\\u4F5C\\u7528\\u3002\\u526F\\u4F5C\\u7528\\u662F\\u6307\\u90A3\\u4E9B\\u5728\\u7EC4\\u4EF6\\u6E32\\u67D3\\u8FC7\\u7A0B\\u4E2D\\u53EF\\u80FD\\u5F15\\u8D77\\u7684\\u989D\\u5916\\u64CD\\u4F5C\\uFF0C\\u4F8B\\u5982\\u8BBF\\u95EE\\u7F51\\u7EDC\\u3001\\u4FEE\\u6539\\u72B6\\u6001\\u7B49\\u3002\\u8FD9\\u91CC\\u66F4\\u65B0\\u6E32\\u67D3\\u76F8\\u8F83\\u4E8E\\u521D\\u6B21\\u6E32\\u67D3\\u5C31\\u662F\\u591A\\u4E86\\u526F\\u4F5C\\u7528\\u7684\\u5904\\u7406\\u903B\\u8F91\\u3002\"]}),`\n`,(0,n.jsx)(e.p,{children:\"\\u5904\\u7406\\u65B0\\u8001\\u76F8\\u540C\\u8282\\u70B9\\u7684 diff\\uFF0C\\u4EE3\\u7801\\u8F83\\u591A\\uFF0C\\u4E14\\u90FD\\u6BD4\\u8F83\\u91CD\\u8981\\uFF0C\\u5EFA\\u8BAE\\u770B\\u6E90\\u7801\\u3002\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u6B64\\u65F6\\u66F4\\u65B0\\u540E\\u7684\\u7EC4\\u4EF6\\u7684 fiber \\u8FD8\\u672A\\u521B\\u5EFA\\uFF0C\\u53EA\\u6709\\u5B9E\\u4F8B\\uFF08\\u7C7B\\u7EC4\\u4EF6\\u5B9E\\u4F8B\\u5316\\uFF0C\\u51FD\\u6570\\u7EC4\\u4EF6\\u6267\\u884C\\uFF09\",(0,n.jsx)(e.em,{children:(0,n.jsx)(e.code,{children:\"element\"})}),\" \\u3002\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-jsx\",children:`// react/packages/react-reconciler/src/ReactChildFiber.old.js\nfunction reconcileSingleElement(\n    returnFiber: Fiber, // \\u7236\\u7EC4\\u4EF6\\u7684 fiber\n    currentFirstChild: Fiber | null, // \\u5B50\\u7EC4\\u4EF6\\u7B2C\\u4E00\\u4E2A fiber\n    element: ReactElement,\n    lanes: Lanes,\n  ): Fiber {\n\tconst key = element.key;\n  let child = currentFirstChild;// \\u5B50\\u7EC4\\u4EF6\\u7684 fiber \\u5728\\u7236\\u7EC4\\u4EF6\\u4E2D\\u662F\\u94FE\\u8868\\u5B58\\u50A8\n  while (child !== null) {\n\t\t\t// TODO: If key === null and child.key === null, then this only applies to\n      // the first item in the list.\n      if (child.key === key) { // \\u67E5\\u627E element \\u5BF9\\u5E94\\u7684\\u65E7 fiber\\uFF0C\n        const elementType = element.type;\n        if (elementType === REACT_FRAGMENT_TYPE){\n\t\t\t\t\t\\xB7\\xB7\\xB7\n\t\t\t\t} else {\n\t\t\t\t\t\\xB7\\xB7\\xB7\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// \\u8FDB\\u5165\\u5230\\u8BE5\\u51FD\\u6570\\u4E2D\\uFF0Celement \\u53EA\\u4E3A\\u5355\\u7EC4\\u4EF6\\uFF0C\\u5176\\u4ED6\\u7684\\u65E7 fiber \\u90FD\\u53EF\\u4EE5\\u5220\\u9664\\u4E86\n        deleteChild(returnFiber, child);\n      }\n      child = child.sibling;\n  }\n\n\t\t// \\u590D\\u7528\\u4E0D\\u4E86\\u65E7\\u7EC4\\u4EF6\\u7684 fiber\\uFF0C\\u90A3\\u53EA\\u80FD\\u65B0\\u5EFA fiber \\u4E86\\u3002\n    if (element.type === REACT_FRAGMENT_TYPE) {\n      const created = createFiberFromFragment(\n        element.props.children,\n        returnFiber.mode,\n        lanes,\n        element.key,\n      );\n      created.return = returnFiber;\n      return created;\n    } else {\n      const created = createFiberFromElement(element, returnFiber.mode, lanes);\n      created.ref = coerceRef(returnFiber, currentFirstChild, element);\n      created.return = returnFiber;\n      return created;\n    }\n}\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u5904\\u7406\\u5B50\\u5143\\u7D20\\u4E3A\\u6570\\u7EC4\\u7684\\u60C5\\u51B5\\uFF0C\\u90A3\\u8FD9\\u4E2A\\u51FD\\u6570\\u7684\\u7528\\u9014\\u548C\",(0,n.jsx)(e.code,{children:\"reconcileSingleElement\"}),\" \\u7684\\u76EE\\u6807\\u5DEE\\u4E0D\\u591A\\uFF0C\\u5C31\\u662F\\u901A\\u8FC7 diff \\u7B97\\u6CD5\\u6784\\u5EFA\\u51FA \",(0,n.jsx)(e.code,{children:\"newChildren\"}),\" \\u5BF9\\u5E94\\u65B0 fiber \\uFF08\\u4E5F\\u4F1A\\u5224\\u65AD\\u662F\\u5426\\u590D\\u7528\\u5C31 fiber\\uFF09\"]})]})}function g(i={}){let{wrapper:e}=i.components||{};return e?(0,n.jsx)(e,Object.assign({},i,{children:(0,n.jsx)(s,i)})):s(i)}var y=g;return w(T);})();\n;return Component;"},"__N_SSG":true},"page":"/[[...id]]","query":{"id":["react-src","reconcile"]},"buildId":"F5pi5djmx84d7mAaXUDE6","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>