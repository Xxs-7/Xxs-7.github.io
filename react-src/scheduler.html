<!DOCTYPE html><html lang="cn"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link data-next-font="" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/css/9028decf9ceeb2fa.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9028decf9ceeb2fa.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/_next/static/chunks/webpack-38cee4c0e358b1a3.js" defer=""></script><script src="/_next/static/chunks/framework-6698976aa0ea586d.js" defer=""></script><script src="/_next/static/chunks/main-9ca4f46f71f15dad.js" defer=""></script><script src="/_next/static/chunks/pages/_app-233c820ee5f72f94.js" defer=""></script><script src="/_next/static/chunks/7a7c95a0-ab903f899792323b.js" defer=""></script><script src="/_next/static/chunks/581-340f217658a3c725.js" defer=""></script><script src="/_next/static/chunks/pages/%5B%5B...id%5D%5D-706fc642a67ce3cd.js" defer=""></script><script src="/_next/static/ntD6QUMlZQsl3mf9dMsvt/_buildManifest.js" defer=""></script><script src="/_next/static/ntD6QUMlZQsl3mf9dMsvt/_ssgManifest.js" defer=""></script></head><body class=" bg-light text-light-text dark:bg-dark dark:text-dark-text max-sm:text-sm"><script>
                (function () {
                  function setTheme(newTheme) {
                    window.__theme = newTheme;
                    if (newTheme === 'dark') {
                      document.documentElement.classList.add('dark');
                    } else if (newTheme === 'light') {
                      document.documentElement.classList.remove('dark');
                    }
                  }

                  var preferredTheme;
                  try {
                    preferredTheme = localStorage.getItem('theme');
                  } catch (err) { }

                  window.__setPreferredTheme = function(newTheme) {
                    preferredTheme = newTheme;
                    setTheme(newTheme);
                    try {
                      localStorage.setItem('theme', newTheme);
                    } catch (err) { }
                  };

                  var initialTheme = preferredTheme;
                  var darkQuery = window.matchMedia('(prefers-color-scheme: dark)');

                  if (!initialTheme) {
                    initialTheme = darkQuery.matches ? 'dark' : 'light';
                  }
                  setTheme(initialTheme);

                  darkQuery.addEventListener('change', function (e) {
                    if (!preferredTheme) {
                      setTheme(e.matches ? 'dark' : 'light');
                    }
                  });
                })();
              </script><div id="__next"><header class="w-full fixed t-0 h-14 border-b backdrop-blur border-slate-900/10 dark:border-slate-300/10 z-10"><div class="w-full h-full flex flex-row items-center justify-between px-4"><div>厘清逻辑</div><div class="mr-2 flex flex-row items-center justify-between gap-2 text-xl"><a href="https://github.com/Xxs-7/Xxs-7.github.io" class="p-1 rounded-full hover:bg-dark/5 hover:dark:bg-light/5"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a><button class="block dark:hidden p-1 rounded-full hover:bg-dark/5 hover:dark:bg-light/5" type="button" aria-label="Use Dark Mode"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0z"></path><path d="M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"></path></svg></button><button type="button" class="hidden dark:block p-1 rounded-full hover:bg-dark/5 hover:dark:bg-light/5" aria-label="Use Light Mode"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0V0z"></path><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79zM1 10.5h3v2H1zM11 .55h2V3.5h-2zm8.04 2.495l1.408 1.407-1.79 1.79-1.407-1.408zm-1.8 15.115l1.79 1.8 1.41-1.41-1.8-1.79zM20 10.5h3v2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm-1 4h2v2.95h-2zm-7.45-.96l1.41 1.41 1.79-1.8-1.41-1.41z"></path></svg></button></div></div></header><div class="pt-14 flex max-w-screen overflow-y-scroll"><nav class="hidden lg:block fixed top-14 lg:bottom-0 lg:h-screen w-[18rem] pb-10 px-4 overflow-y-auto min-h-screen z-10"><nav><ul class="mt-6"><!--$--><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">html</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/html/SemanticsTag">语义化标签</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/html/anchor">锚元素</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">css</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/css/flex">flex 布局</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/css/grid">grid 布局</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/css/unit">布局单位</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">javascript</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/javascript/promise">promise</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/javascript/async-await">async 和 await</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/javascript/execution-context">执行上下文</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/javascript/scopes">作用域</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">react</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react/lifecycle">lifecycle</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react/hook">hook</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react/high-compoment">组件逻辑复用方案</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">react 源码</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/architecture">源码架构</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/fiber-node">fiber 节点</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/render-mode">渲染模式</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5 text-highlight"><a class="block" href="/react-src/scheduler">scheduler</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/first-render">初次渲染</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/update-render">更新渲染</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/render-task">渲染任务的执行</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/react-src/context">Context</a></li></ul></li><li class="mt-1"><div class="pl-1 border border-transparent rounded-sm font-bold text-lg">实践</div><ul><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/demo/music-player">音乐播放器</a></li><li class="pl-4 border border-transparent rounded-sm font-bold hover:bg-dark/5 text-sm py-0.5 hover:dark:bg-light/5"><a class="block" href="/demo/font-advance">字体库优化</a></li></ul></li><!--/$--></ul></nav></nav><main class="relative lg:ml-[18rem] min-w-0 flex-1 px-5 "><article class="mx-auto xl:max-w-none overflow-x-hidden xl:ml-0 xl:mr-[18rem]"><h1 class="mdx-heading text-3xl font-extrabold my-6 text-header dark:text-header-dark" id="scheduler">Scheduler</h1>
<p class="whitespace-pre-wrap my-2 ">scheduler 是一种在浏览器调度处理任务的性能优化方案的实现。任务会被存入最小堆中等待调度执行；任务在执行时可以被中止（让渡主线程去处理其他事情），而后继续执行。</p>
<p class="whitespace-pre-wrap my-2 ">在 react 中 scheduler 被用来调度执行组件渲染的任务，从而实现不阻塞页面的用户响应。该模块的代码完全独立于其他其他模块，如同一个第三方库被 react 调用。</p>
<h3 class="mdx-heading text-xl font-semibold whitespace-pre-wrap mt-4 mb-2 group text-header dark:text-header-dark" id="重点关注">重点关注<a href="#重点关注" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h3>
<ul class="ml-6 my-3 list-disc">
<li class="leading-relaxed ">react 渲染任务如何传入 scheduler 被存储的？最小堆存放 task</li>
<li class="leading-relaxed ">任务在哪个函数被执行，依次执行的顺序？</li>
<li class="leading-relaxed ">执行任务让渡主线程的具体代码逻辑是什么？shouldYieldToHost</li>
<li class="leading-relaxed ">任务执行的中断和恢复</li>
<li class="leading-relaxed ">任务优先级参与的代码逻辑</li>
</ul>
<h2 class="mdx-heading text-2xl font-bold whitespace-pre-wrap mt-6 mb-4 group text-header  dark:text-header-dark" id="任务调度">任务调度<a href="#任务调度" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h2>
<p class="whitespace-pre-wrap my-2 ">scheduler 就是做任务调度这件事，在 react 中，<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">createRoot</code>，<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">setState</code>，<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">context</code> 等 API 会产生渲染任务，并且渲染任务会有优先级，可以被中断执行。</p>
<h3 class="mdx-heading text-xl font-semibold whitespace-pre-wrap mt-4 mb-2 group text-header dark:text-header-dark" id="最小堆">最小堆<a href="#最小堆" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h3>
<p class="whitespace-pre-wrap my-2 ">手动实现一个简单的最小堆，最小堆是<strong class="font-bold">一种经过排序的完全二叉树，其中任一非终端节点的数据值均不大于其左子节点和右子节点的值</strong>。</p>
<ul class="ml-6 my-3 list-disc">
<li class="leading-relaxed "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">peek</code>：获取堆顶元素，即所有元素的最小值</li>
<li class="leading-relaxed "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">pop</code>：弹出堆顶元素，会重新排序构建最小堆结构</li>
<li class="leading-relaxed "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">push</code>：插入元素，会重新排序构建最小堆结构</li>
</ul>
<pre><!--$--><div class="prism-code language-js rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">export</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">peek</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">length</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">0</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">?</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap">0</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">export</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">push</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> node</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="whitespace-pre-wrap"> index </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">length</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">push</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">node</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">siftUp</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> node</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> index</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 先放在尾部，向上查找</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">siftUp</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> node</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> i</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="whitespace-pre-wrap"> index </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> i</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">while</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">index </span><span class="whitespace-pre-wrap">&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">0</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> parentIndex </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">index </span><span class="whitespace-pre-wrap">-</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">1</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&gt;&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">1</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> parent </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap">parentIndex</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">compare</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">parent</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> node</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">0</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap">parentIndex</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> node</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap">index</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> parent</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      index </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> parentIndex</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">export</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">pop</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">length</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">0</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> first </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap">0</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> last </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">pop</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">first </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> last</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap">0</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> last</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">siftDown</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> last</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">0</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> first</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 弹出首元素，分别对左右进行比较</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">siftDown</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> node</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> i</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="whitespace-pre-wrap"> index </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> i</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> len </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">length</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> halfLen </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> len </span><span class="whitespace-pre-wrap">&gt;&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">1</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">while</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">index </span><span class="whitespace-pre-wrap">&lt;</span><span class="whitespace-pre-wrap"> halfLen</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> leftIndex </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">index </span><span class="whitespace-pre-wrap">+</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">1</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">*</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">2</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">-</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">1</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> rightIndex </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> leftIndex </span><span class="whitespace-pre-wrap">+</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">1</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> left </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap">leftIndex</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> right </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap">rightIndex</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">compare</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">left</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> node</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&lt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">0</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">rightIndex </span><span class="whitespace-pre-wrap">&lt;</span><span class="whitespace-pre-wrap"> len </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">compare</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">right</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> left</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&lt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">0</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap">index</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> right</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap">rightIndex</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> node</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        index </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> rightIndex</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// not right or right &lt; left</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap">index</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> left</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap">leftIndex</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> node</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        index </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> leftIndex</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">rightIndex </span><span class="whitespace-pre-wrap">&lt;</span><span class="whitespace-pre-wrap"> len </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">compare</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">right</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> node</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&lt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">0</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap">index</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> right</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      heap</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">[</span><span class="whitespace-pre-wrap">rightIndex</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">]</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> node</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      index </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> rightIndex</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">compare</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">a</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> b</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// return a - b;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> diff </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> a</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">sortIndex</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">-</span><span class="whitespace-pre-wrap"> b</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">sortIndex</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> diff </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">0</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">?</span><span class="whitespace-pre-wrap"> diff </span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> a</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">id</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">-</span><span class="whitespace-pre-wrap"> b</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">id</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<h3 class="mdx-heading text-xl font-semibold whitespace-pre-wrap mt-4 mb-2 group text-header dark:text-header-dark" id="任务产生">任务产生<a href="#任务产生" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h3>
<p class="whitespace-pre-wrap my-2 ">react 中调用了 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">Scheduler.unstable_scheduleCallback</code> ，通过这个函数将渲染任务存储 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">taskQueue</code> 中，<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">taskQueue</code> 是最小堆类型，存放任务等待调度执行。</p>
<pre><!--$--><div class="prism-code language-js rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// react/packages/scheduler/src/forks/Scheduler.js</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">unstable_scheduleCallback</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">priorityLevel</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">PriorityLevel</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap">callback</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Callback</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  options</span><span class="whitespace-pre-wrap">?</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap">delay</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> number</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Task</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 当前时间戳</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="whitespace-pre-wrap"> currentTime </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">getCurrentTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="whitespace-pre-wrap"> startTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// react 没用到 option</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="whitespace-pre-wrap"> options </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;object&#x27;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"> options </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="whitespace-pre-wrap"> delay </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> options</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">delay</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="whitespace-pre-wrap"> delay </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;number&#x27;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"> delay </span><span class="whitespace-pre-wrap">&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">0</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      startTime </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> currentTime </span><span class="whitespace-pre-wrap">+</span><span class="whitespace-pre-wrap"> delay</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      startTime </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> currentTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 设置开始时间</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    startTime </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> currentTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 根据优先级设置超时时间</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="whitespace-pre-wrap"> timeout</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">switch</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">priorityLevel</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">ImmediatePriority</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 最高优先级，超时时间最短</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      timeout </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">IMMEDIATE_PRIORITY_TIMEOUT</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">break</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">UserBlockingPriority</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      timeout </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">USER_BLOCKING_PRIORITY_TIMEOUT</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">break</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">IdlePriority</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      timeout </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">IDLE_PRIORITY_TIMEOUT</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">break</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">LowPriority</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      timeout </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">LOW_PRIORITY_TIMEOUT</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">break</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">NormalPriority</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">default</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      timeout </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249)">NORMAL_PRIORITY_TIMEOUT</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">break</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 根据任务优先级设置过期时间</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="whitespace-pre-wrap"> expirationTime </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> startTime </span><span class="whitespace-pre-wrap">+</span><span class="whitespace-pre-wrap"> timeout</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 任务创建，讲本函数参数 callback 被存入任务中</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">newTask</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">Task</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">id</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> taskIdCounter</span><span class="whitespace-pre-wrap">++</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    callback</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    priorityLevel</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    startTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    expirationTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">sortIndex</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">-</span><span class="whitespace-pre-wrap">1</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">enableProfiling</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    newTask</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">isQueued</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">false</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">startTime </span><span class="whitespace-pre-wrap">&gt;</span><span class="whitespace-pre-wrap"> currentTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 这里是有 option 的情况，react 没有用到</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// This is a delayed task.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    newTask</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">sortIndex</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> startTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">push</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">timerQueue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> newTask</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">peek</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">taskQueue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"> newTask </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">peek</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">timerQueue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// All tasks are delayed, and this is the task with the earliest delay.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">isHostTimeoutScheduled</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Cancel an existing timeout.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">cancelHostTimeout</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        isHostTimeoutScheduled </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Schedule a timeout.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">requestHostTimeout</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">handleTimeout</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> startTime </span><span class="whitespace-pre-wrap">-</span><span class="whitespace-pre-wrap"> currentTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 没有 option 的情况走这里</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// sortIndex 为 task 被 push 到最小堆时的排序 index，</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 不难理解，任务过期时间越小，越靠近堆顶，越优先处理</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    newTask</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">sortIndex</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> expirationTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">push</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">taskQueue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> newTask</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">enableProfiling</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">markTaskStart</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">newTask</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> currentTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      newTask</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">isQueued</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Schedule a host callback, if needed. If we&#x27;re already performing work,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// wait until the next time we yield.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// isHostCallbackScheduled 意思是是否有 host callback 任务被调度了</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">!</span><span class="whitespace-pre-wrap">isHostCallbackScheduled </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">!</span><span class="whitespace-pre-wrap">isPerformingWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      isHostCallbackScheduled </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">requestHostCallback</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">flushWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> newTask</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<h3 class="mdx-heading text-xl font-semibold whitespace-pre-wrap mt-4 mb-2 group text-header dark:text-header-dark" id="任务调度执行">任务调度执行<a href="#任务调度执行" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h3>
<p class="whitespace-pre-wrap my-2 ">scheduler 是将传入的任务放到宏任务的事件循环里执行。</p>
<p class="whitespace-pre-wrap my-2 ">依次有三种兼容性降级的方案：<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">setImmediate</code> → <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">MessageChannel</code> →<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">SetTimeout</code></p>
<pre><!--$--><div class="prism-code language-js rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// react/packages/scheduler/src/forks/Scheduler.js</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="whitespace-pre-wrap"> schedulePerformWorkUntilDeadline</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="whitespace-pre-wrap"> localSetImmediate </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;function&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Node.js and old IE.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// There&#x27;s a few reasons for why we prefer setImmediate.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">//</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Unlike MessageChannel, it doesn&#x27;t prevent a Node.js process from exiting.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// (Even though this is a DOM fork of the Scheduler, you could get here</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// with a mix of Node.js 15+, which has a MessageChannel, and jsdom.)</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// https://github.com/facebook/react/issues/20756</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">//</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// But also, it runs earlier which is the semantic we want.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// If other browsers ever implement it, it&#x27;s better to use it.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Although both of these would be inferior to native scheduling.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">schedulePerformWorkUntilDeadline</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">localSetImmediate</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">performWorkUntilDeadline</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">MessageChannel</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;undefined&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// DOM and Worker environments.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// We prefer MessageChannel because of the 4ms setTimeout clamping.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> channel </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">MessageChannel</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> port </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> channel</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">port2</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  channel</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">port1</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">onmessage</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> performWorkUntilDeadline</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">schedulePerformWorkUntilDeadline</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    port</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">postMessage</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// We should only fallback here in non-browser environments.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">schedulePerformWorkUntilDeadline</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// $FlowFixMe[not-a-function] nullable value</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">localSetTimeout</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">performWorkUntilDeadline</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">0</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 ">实际执行的就是：</p>
<pre><!--$--><div class="prism-code language-js rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="whitespace-pre-wrap"> schedulePerformWorkUntilDeadline</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">schedulePerformWorkUntilDeadline</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">   </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">localSetImmediate</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">performWorkUntilDeadline</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 ">再回到从 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">scheduleUpdateOnFiber</code> 到 task 被执行：</p>
<pre><!--$--><div class="prism-code language-js rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 简要代码执行流程</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">unstable_scheduleCallback</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">requestHostCallback</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">flushWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">requestHostCallback</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">callback</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  scheduledHostCallback </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> callback</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">!</span><span class="whitespace-pre-wrap">isMessageLoopRunning</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    isMessageLoopRunning </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 执行上一段代码的  localSetImmediate(performWorkUntilDeadline);</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">schedulePerformWorkUntilDeadline</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 里面的 scheduledHostCallback 为 flushWork</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">performWorkUntilDeadline</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=&gt;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">scheduledHostCallback </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> currentTime </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">getCurrentTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Keep track of the start time so we can measure how long the main thread</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// has been blocked.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    startTime </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> currentTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// If a scheduler task throws, exit the current browser task so the</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// error can be observed.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">//</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Intentionally not using a try-catch, since that makes some debugging</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// techniques harder. Instead, if `scheduledHostCallback` errors, then</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// `hasMoreWork` will remain true, and we&#x27;ll continue the work loop.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="whitespace-pre-wrap"> hasMoreWork </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// $FlowFixMe[not-a-function] found when upgrading Flow</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      hasMoreWork </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">scheduledHostCallback</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">currentTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">finally</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">hasMoreWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// If there&#x27;s more work, schedule the next message event at the end</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// of the preceding one.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">schedulePerformWorkUntilDeadline</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        isMessageLoopRunning </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">false</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        scheduledHostCallback </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    isMessageLoopRunning </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">false</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Yielding to the browser will give it a chance to paint, so we can</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// reset this.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  needsPaint </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">false</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">flushWork</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">initialTime</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> number</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">enableProfiling</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	  ···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// We&#x27;ll need a host callback the next time work is scheduled.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  isHostCallbackScheduled </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">false</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">isHostTimeoutScheduled</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// We scheduled a timeout but it&#x27;s no longer needed. Cancel it.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    isHostTimeoutScheduled </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">false</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">cancelHostTimeout</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  isPerformingWork </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> previousPriorityLevel </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> currentPriorityLevel</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">enableProfiling</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	    ···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// No catch in prod code path.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">workLoop</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">initialTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">finally</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    currentTask </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    currentPriorityLevel </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> previousPriorityLevel</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    isPerformingWork </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">false</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">enableProfiling</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">     ···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">workLoop</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">initialTime</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> number</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">workLoop</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">initialTime</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> number</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="whitespace-pre-wrap"> currentTime </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> initialTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">advanceTimers</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">currentTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 取 task</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  currentTask </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">peek</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">taskQueue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">while</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    currentTask </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">!</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">enableSchedulerDebugging </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"> isSchedulerPaused</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">currentTask</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">expirationTime</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&gt;</span><span class="whitespace-pre-wrap"> currentTime </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">shouldYieldToHost</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// This currentTask hasn&#x27;t expired, and we&#x27;ve reached the deadline.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">break</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// $FlowFixMe[incompatible-use] found when upgrading Flow</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> callback </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> currentTask</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">callback</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="whitespace-pre-wrap"> callback </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;function&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// $FlowFixMe[incompatible-use] found when upgrading Flow</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      currentTask</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">callback</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// $FlowFixMe[incompatible-use] found when upgrading Flow</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      currentPriorityLevel </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> currentTask</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">priorityLevel</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// $FlowFixMe[incompatible-use] found when upgrading Flow</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> didUserCallbackTimeout </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> currentTask</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">expirationTime</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&lt;=</span><span class="whitespace-pre-wrap"> currentTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">enableProfiling</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// $FlowFixMe[incompatible-call] found when upgrading Flow</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">markTaskRun</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">currentTask</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> currentTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> continuationCallback </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">callback</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">didUserCallbackTimeout</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      currentTime </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">getCurrentTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="whitespace-pre-wrap"> continuationCallback </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;function&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// If a continuation is returned, immediately yield to the main thread</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// regardless of how much time is left in the current time slice.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// $FlowFixMe[incompatible-use] found when upgrading Flow</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        currentTask</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">callback</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> continuationCallback</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">enableProfiling</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          ···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">advanceTimers</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">currentTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">enableProfiling</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          ···</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">currentTask </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">peek</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">taskQueue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">pop</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">taskQueue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">advanceTimers</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">currentTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">pop</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">taskQueue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    currentTask </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">peek</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">taskQueue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Return whether there&#x27;s additional work</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">currentTask </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> firstTimer </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">peek</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">timerQueue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">firstTimer </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">requestHostTimeout</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">handleTimeout</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">,</span><span class="whitespace-pre-wrap"> firstTimer</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">startTime</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">-</span><span class="whitespace-pre-wrap"> currentTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">false</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 ">可以看出，核心执行流程是通过 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">while</code> 循环不断取 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">taskQueue</code> 中的 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">task</code>，并执行其 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">task.callback</code></p>
<pre><!--$--><div class="prism-code language-js rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 简化版流程</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">workLoop</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">initialTime</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> number</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	···  </span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 获取堆顶任务</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	currentTask </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">peek</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">taskQueue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">while</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    currentTask </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">!</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">enableSchedulerDebugging </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"> isSchedulerPaused</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 前一个比较是一个贪心的策略，未到 deadline，可以再等等</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 如果是优先级较高的，那其实会很快过期</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// shouldYieldToHost 是中断的逻辑</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">currentTask</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">expirationTime</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&gt;</span><span class="whitespace-pre-wrap"> currentTime </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">shouldYieldToHost</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// This currentTask hasn&#x27;t expired, and we&#x27;ve reached the deadline.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">break</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 执行 callback</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> callback </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> currentTask</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">callback</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="whitespace-pre-wrap"> callback </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;function&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">			</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> continuationCallback </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">callback</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">didUserCallbackTimeout</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="whitespace-pre-wrap"> continuationCallback </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;function&#x27;</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">				currentTask</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">callback</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> continuationCallback</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">				</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">			</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">				</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">currentTask </span><span class="whitespace-pre-wrap">===</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">peek</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">taskQueue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">          </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">pop</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">taskQueue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">			</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">			</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 移除被执行的任务</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">pop</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">taskQueue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		</span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 获取下一个堆顶任务</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">		currentTask </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">peek</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">taskQueue</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">	</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<p class="whitespace-pre-wrap my-2 ">函数中调用 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">shouldYieldToHost</code> 判断是否让渡处理权给页面，实际效果就是提前结束掉当前这个宏任务，当前任务的后续内容被中断，不执行了。里面逻辑比较复杂，时间判断逻辑较多，后续再研究。但是重点是调用了 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">navigator.scheduling.isInputPending</code> ，这个 API 的兼容性不太行，是 react 和 chrome 合作搞出来的。如果浏览器任务队列中有输入事件待处理，则返回 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">true</code>。</p>
<pre><!--$--><div class="prism-code language-js rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// 有兴趣看看就行</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> isInputPending </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">navigator</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(255, 121, 198)">&#x27;undefined&#x27;</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// $FlowFixMe[prop-missing]</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">navigator</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">scheduling</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">undefined</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">&amp;&amp;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// $FlowFixMe[incompatible-type]</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">navigator</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">scheduling</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">isInputPending</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">undefined</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">?</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">navigator</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">scheduling</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">isInputPending</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">bind</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">navigator</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">.</span><span class="whitespace-pre-wrap">scheduling</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">shouldYieldToHost</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> boolean </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> timeElapsed </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">getCurrentTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">-</span><span class="whitespace-pre-wrap"> startTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">timeElapsed </span><span class="whitespace-pre-wrap">&lt;</span><span class="whitespace-pre-wrap"> frameInterval</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// The main thread has only been blocked for a really short amount of time;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// smaller than a single frame. Don&#x27;t yield yet.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">false</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">enableIsInputPending</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">needsPaint</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// There&#x27;s a pending paint (signaled by `requestPaint`). Yield now.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">timeElapsed </span><span class="whitespace-pre-wrap">&lt;</span><span class="whitespace-pre-wrap"> continuousInputInterval</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// We haven&#x27;t blocked the thread for that long. Only yield if there&#x27;s a</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// pending discrete input (e.g. click). It&#x27;s OK if there&#x27;s pending</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// continuous input (e.g. mouseover).</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">isInputPending </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">isInputPending</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">timeElapsed </span><span class="whitespace-pre-wrap">&lt;</span><span class="whitespace-pre-wrap"> maxInterval</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Yield if there&#x27;s either a pending discrete or continuous input.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">isInputPending </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">isInputPending</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">x</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// We&#x27;ve blocked the thread for a long time. Even if there&#x27;s no pending</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// input, there may be some other scheduled work that we don&#x27;t know about,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// like a network event. Yield now.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// `isInputPending` isn&#x27;t available. Yield now.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre>
<h2 class="mdx-heading text-2xl font-bold whitespace-pre-wrap mt-6 mb-4 group text-header  dark:text-header-dark" id="任务调度为什么选择宏任务">任务调度为什么选择宏任务<a href="#任务调度为什么选择宏任务" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h2>
<p class="whitespace-pre-wrap my-2 ">当 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">shouldYieldToHost()</code> 返回 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">true</code> 后，Scheduler 需要满足以下功能点：</p>
<ol class="ml-6 my-3 list-decimal">
<li class="leading-relaxed ">暂停渲染任务的执行，将主线程还给浏览器，让浏览器有机会更新页面去处理用户响应等任务</li>
<li class="leading-relaxed ">在未来某个时刻继续调度任务，执行上次还没有完成的任务（这部分逻辑不在 scheduler，至于如何保留当前现场，之后恢复现场并继续执行，是任务里的 callback 应该做的事，实际上，渲染任务的 callback 里也会用到 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">shouldYieldToHost</code> ）</li>
</ol>
<p class="whitespace-pre-wrap my-2 ">要满足这两点就需要调度一个宏任务，因为宏任务是在下次事件循环中执行，不会阻塞本次页面更新。</p>
<img src="/lifeOfAFrame.png" width="800" height="300"/>
<p class="whitespace-pre-wrap my-2 ">为什么不用微任务，<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">requestAnimationFrame</code> 或 <code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">requestIdleCallback</code>?</p>
<p class="whitespace-pre-wrap my-2 ">微任务是在本次事件循环里执行，如果产生的渲染任务是以微任务方式执行，那么必须产生的微任务都执行完毕才进入下一个宏任务。
raf 不属于微任务或宏任务，是在帧间执行一次，而宏任务在帧间不一定只执行一个，可以执行多个最后再一起渲染。具体可以看这个分析 <a href="https://juejin.cn/post/7165780929439334437" class="hover:underline text-highlight decoration-2 underline-offset-2 decoration-highlight">React 之 requestAnimationFrame 执行机制探索</a>
<code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">requestIdleCallback</code> 是兼容性较差不适合在生产环境上，并且它实际上是在布局和绘制之后执行，那意味在里面做的事情（可能是通过数据修改触发dom修改）会重排。</p>
<h3 class="mdx-heading text-xl font-semibold whitespace-pre-wrap mt-4 mb-2 group text-header dark:text-header-dark" id="让渡主线程">让渡主线程<a href="#让渡主线程" class="hidden pl-2 group-hover:inline-block"><svg width="12" height="12" fill="none" aria-hidden="true"><path d="M3.75 1v10M8.25 1v10M1 3.75h10M1 8.25h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg></a></h3>
<p class="whitespace-pre-wrap my-2 "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">shouldYieldToHost</code></p>
<p class="whitespace-pre-wrap my-2 "><code class="inline text-code text-secondary dark:text-secondary-dark px-1.5 py-0.5 mx-0.5 rounded-md no-underline bg-[#f2ecde] dark:bg-[#2b333e] text-highlight whitespace-pre-wrap">navigator.scheduling.isInputPending API</code>是 react 与 Chrome 团队合作的产物。</p>
<pre><!--$--><div class="prism-code language-js rounded-md p-4 overflow-x-auto text-sm" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">shouldYieldToHost</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap">:</span><span class="whitespace-pre-wrap"> boolean </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="whitespace-pre-wrap"> timeElapsed </span><span class="whitespace-pre-wrap">=</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">getCurrentTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">-</span><span class="whitespace-pre-wrap"> startTime</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">timeElapsed </span><span class="whitespace-pre-wrap">&lt;</span><span class="whitespace-pre-wrap"> frameInterval</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// The main thread has only been blocked for a really short amount of time;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// smaller than a single frame. Don&#x27;t yield yet.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">false</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// The main thread has been blocked for a non-negligible amount of time. We</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// may want to yield control of the main thread, so the browser can perform</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// high priority tasks. The main ones are painting and user input. If there&#x27;s</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// a pending paint or a pending input, then we should yield. But if there&#x27;s</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// neither, then we can yield less often while remaining responsive. We&#x27;ll</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// eventually yield regardless, since there could be a pending paint that</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// wasn&#x27;t accompanied by a call to `requestPaint`, or other main thread tasks</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// like network events.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">enableIsInputPending</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">needsPaint</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// There&#x27;s a pending paint (signaled by `requestPaint`). Yield now.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">timeElapsed </span><span class="whitespace-pre-wrap">&lt;</span><span class="whitespace-pre-wrap"> continuousInputInterval</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// We haven&#x27;t blocked the thread for that long. Only yield if there&#x27;s a</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// pending discrete input (e.g. click). It&#x27;s OK if there&#x27;s pending</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// continuous input (e.g. mouseover).</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">isInputPending </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">isInputPending</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">timeElapsed </span><span class="whitespace-pre-wrap">&lt;</span><span class="whitespace-pre-wrap"> maxInterval</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// Yield if there&#x27;s either a pending discrete or continuous input.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">isInputPending </span><span class="whitespace-pre-wrap">!==</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">        </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(80, 250, 123)">isInputPending</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">(</span><span class="whitespace-pre-wrap">continuousOptions</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">)</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">{</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// We&#x27;ve blocked the thread for a long time. Even if there&#x27;s no pending</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// input, there may be some other scheduled work that we don&#x27;t know about,</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// like a network event. Yield now.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">      </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">    </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(98, 114, 164)">// `isInputPending` isn&#x27;t available. Yield now.</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap">  </span><span class="whitespace-pre-wrap" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="whitespace-pre-wrap"> </span><span class="whitespace-pre-wrap">true</span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">;</span><span class="whitespace-pre-wrap"></span></div><div class="token-line" style="color:#F8F8F2"><span class="whitespace-pre-wrap"></span><span class="whitespace-pre-wrap" style="color:rgb(248, 248, 242)">}</span><span class="whitespace-pre-wrap"></span></div></div><!--/$--></pre></article><aside class="hidden xl:block fixed top-14 right-0 w-[18rem] py-6 overflow-y-auto"><ul class="text-sm font-medium"><li class="pl-2 text-base">Scheduler</li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-6 text-xs"><a href="#重点关注" class="block py-1">重点关注</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-4"><a href="#任务调度" class="block py-1">任务调度</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-6 text-xs"><a href="#最小堆" class="block py-1">最小堆</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-6 text-xs"><a href="#任务产生" class="block py-1">任务产生</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-6 text-xs"><a href="#任务调度执行" class="block py-1">任务调度执行</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-4"><a href="#任务调度为什么选择宏任务" class="block py-1">任务调度为什么选择宏任务</a></li><li class="border-l hover:text-hover border-slate-900/10 dark:border-slate-300/10 pl-6 text-xs"><a href="#让渡主线程" class="block py-1">让渡主线程</a></li></ul></aside></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"toc":[{"text":"Scheduler","hash":"#scheduler","depth":1},{"text":"重点关注","hash":"#重点关注","depth":3},{"text":"任务调度","hash":"#任务调度","depth":2},{"text":"最小堆","hash":"#最小堆","depth":3},{"text":"任务产生","hash":"#任务产生","depth":3},{"text":"任务调度执行","hash":"#任务调度执行","depth":3},{"text":"任务调度为什么选择宏任务","hash":"#任务调度为什么选择宏任务","depth":2},{"text":"让渡主线程","hash":"#让渡主线程","depth":3}],"code":"var Component=(()=\u003e{var u=Object.create;var l=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var m=Object.getPrototypeOf,f=Object.prototype.hasOwnProperty;var k=(t,e)=\u003e()=\u003e(e||t((e={exports:{}}).exports,e),e.exports),g=(t,e)=\u003e{for(var i in e)l(t,i,{get:e[i],enumerable:!0})},o=(t,e,i,a)=\u003e{if(e\u0026\u0026typeof e==\"object\"||typeof e==\"function\")for(let r of p(e))!f.call(t,r)\u0026\u0026r!==i\u0026\u0026l(t,r,{get:()=\u003ee[r],enumerable:!(a=h(e,r))||a.enumerable});return t};var T=(t,e,i)=\u003e(i=t!=null?u(m(t)):{},o(e||!t||!t.__esModule?l(i,\"default\",{value:t,enumerable:!0}):i,t)),b=t=\u003eo(l({},\"__esModule\",{value:!0}),t);var c=k((P,s)=\u003e{s.exports=_jsx_runtime});var x={};g(x,{default:()=\u003eI});var n=T(c());function d(t){let e=Object.assign({h1:\"h1\",p:\"p\",h3:\"h3\",ul:\"ul\",li:\"li\",h2:\"h2\",code:\"code\",strong:\"strong\",pre:\"pre\",ol:\"ol\",a:\"a\"},t.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(e.h1,{hash:\"scheduler\",children:\"Scheduler\"}),`\n`,(0,n.jsx)(e.p,{children:\"scheduler \\u662F\\u4E00\\u79CD\\u5728\\u6D4F\\u89C8\\u5668\\u8C03\\u5EA6\\u5904\\u7406\\u4EFB\\u52A1\\u7684\\u6027\\u80FD\\u4F18\\u5316\\u65B9\\u6848\\u7684\\u5B9E\\u73B0\\u3002\\u4EFB\\u52A1\\u4F1A\\u88AB\\u5B58\\u5165\\u6700\\u5C0F\\u5806\\u4E2D\\u7B49\\u5F85\\u8C03\\u5EA6\\u6267\\u884C\\uFF1B\\u4EFB\\u52A1\\u5728\\u6267\\u884C\\u65F6\\u53EF\\u4EE5\\u88AB\\u4E2D\\u6B62\\uFF08\\u8BA9\\u6E21\\u4E3B\\u7EBF\\u7A0B\\u53BB\\u5904\\u7406\\u5176\\u4ED6\\u4E8B\\u60C5\\uFF09\\uFF0C\\u800C\\u540E\\u7EE7\\u7EED\\u6267\\u884C\\u3002\"}),`\n`,(0,n.jsx)(e.p,{children:\"\\u5728 react \\u4E2D scheduler \\u88AB\\u7528\\u6765\\u8C03\\u5EA6\\u6267\\u884C\\u7EC4\\u4EF6\\u6E32\\u67D3\\u7684\\u4EFB\\u52A1\\uFF0C\\u4ECE\\u800C\\u5B9E\\u73B0\\u4E0D\\u963B\\u585E\\u9875\\u9762\\u7684\\u7528\\u6237\\u54CD\\u5E94\\u3002\\u8BE5\\u6A21\\u5757\\u7684\\u4EE3\\u7801\\u5B8C\\u5168\\u72EC\\u7ACB\\u4E8E\\u5176\\u4ED6\\u5176\\u4ED6\\u6A21\\u5757\\uFF0C\\u5982\\u540C\\u4E00\\u4E2A\\u7B2C\\u4E09\\u65B9\\u5E93\\u88AB react \\u8C03\\u7528\\u3002\"}),`\n`,(0,n.jsx)(e.h3,{hash:\"\\u91CD\\u70B9\\u5173\\u6CE8\",children:\"\\u91CD\\u70B9\\u5173\\u6CE8\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"react \\u6E32\\u67D3\\u4EFB\\u52A1\\u5982\\u4F55\\u4F20\\u5165 scheduler \\u88AB\\u5B58\\u50A8\\u7684\\uFF1F\\u6700\\u5C0F\\u5806\\u5B58\\u653E task\"}),`\n`,(0,n.jsx)(e.li,{children:\"\\u4EFB\\u52A1\\u5728\\u54EA\\u4E2A\\u51FD\\u6570\\u88AB\\u6267\\u884C\\uFF0C\\u4F9D\\u6B21\\u6267\\u884C\\u7684\\u987A\\u5E8F\\uFF1F\"}),`\n`,(0,n.jsx)(e.li,{children:\"\\u6267\\u884C\\u4EFB\\u52A1\\u8BA9\\u6E21\\u4E3B\\u7EBF\\u7A0B\\u7684\\u5177\\u4F53\\u4EE3\\u7801\\u903B\\u8F91\\u662F\\u4EC0\\u4E48\\uFF1FshouldYieldToHost\"}),`\n`,(0,n.jsx)(e.li,{children:\"\\u4EFB\\u52A1\\u6267\\u884C\\u7684\\u4E2D\\u65AD\\u548C\\u6062\\u590D\"}),`\n`,(0,n.jsx)(e.li,{children:\"\\u4EFB\\u52A1\\u4F18\\u5148\\u7EA7\\u53C2\\u4E0E\\u7684\\u4EE3\\u7801\\u903B\\u8F91\"}),`\n`]}),`\n`,(0,n.jsx)(e.h2,{hash:\"\\u4EFB\\u52A1\\u8C03\\u5EA6\",children:\"\\u4EFB\\u52A1\\u8C03\\u5EA6\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"scheduler \\u5C31\\u662F\\u505A\\u4EFB\\u52A1\\u8C03\\u5EA6\\u8FD9\\u4EF6\\u4E8B\\uFF0C\\u5728 react \\u4E2D\\uFF0C\",(0,n.jsx)(e.code,{children:\"createRoot\"}),\"\\uFF0C\",(0,n.jsx)(e.code,{children:\"setState\"}),\"\\uFF0C\",(0,n.jsx)(e.code,{children:\"context\"}),\" \\u7B49 API \\u4F1A\\u4EA7\\u751F\\u6E32\\u67D3\\u4EFB\\u52A1\\uFF0C\\u5E76\\u4E14\\u6E32\\u67D3\\u4EFB\\u52A1\\u4F1A\\u6709\\u4F18\\u5148\\u7EA7\\uFF0C\\u53EF\\u4EE5\\u88AB\\u4E2D\\u65AD\\u6267\\u884C\\u3002\"]}),`\n`,(0,n.jsx)(e.h3,{hash:\"\\u6700\\u5C0F\\u5806\",children:\"\\u6700\\u5C0F\\u5806\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u624B\\u52A8\\u5B9E\\u73B0\\u4E00\\u4E2A\\u7B80\\u5355\\u7684\\u6700\\u5C0F\\u5806\\uFF0C\\u6700\\u5C0F\\u5806\\u662F\",(0,n.jsx)(e.strong,{children:\"\\u4E00\\u79CD\\u7ECF\\u8FC7\\u6392\\u5E8F\\u7684\\u5B8C\\u5168\\u4E8C\\u53C9\\u6811\\uFF0C\\u5176\\u4E2D\\u4EFB\\u4E00\\u975E\\u7EC8\\u7AEF\\u8282\\u70B9\\u7684\\u6570\\u636E\\u503C\\u5747\\u4E0D\\u5927\\u4E8E\\u5176\\u5DE6\\u5B50\\u8282\\u70B9\\u548C\\u53F3\\u5B50\\u8282\\u70B9\\u7684\\u503C\"}),\"\\u3002\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"peek\"}),\"\\uFF1A\\u83B7\\u53D6\\u5806\\u9876\\u5143\\u7D20\\uFF0C\\u5373\\u6240\\u6709\\u5143\\u7D20\\u7684\\u6700\\u5C0F\\u503C\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"pop\"}),\"\\uFF1A\\u5F39\\u51FA\\u5806\\u9876\\u5143\\u7D20\\uFF0C\\u4F1A\\u91CD\\u65B0\\u6392\\u5E8F\\u6784\\u5EFA\\u6700\\u5C0F\\u5806\\u7ED3\\u6784\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"push\"}),\"\\uFF1A\\u63D2\\u5165\\u5143\\u7D20\\uFF0C\\u4F1A\\u91CD\\u65B0\\u6392\\u5E8F\\u6784\\u5EFA\\u6700\\u5C0F\\u5806\\u7ED3\\u6784\"]}),`\n`]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-js\",children:`export function peek(heap) {\n  return heap.length === 0 ? null : heap[0];\n}\n\nexport function push(heap, node) {\n  let index = heap.length;\n  heap.push(node);\n  siftUp(heap, node, index);\n}\n\n// \\u5148\\u653E\\u5728\\u5C3E\\u90E8\\uFF0C\\u5411\\u4E0A\\u67E5\\u627E\nfunction siftUp(heap, node, i) {\n  let index = i;\n  while (index \u003e 0) {\n    const parentIndex = (index - 1) \u003e\u003e 1;\n    const parent = heap[parentIndex];\n    if (compare(parent, node) \u003e 0) {\n      heap[parentIndex] = node;\n      heap[index] = parent;\n      index = parentIndex;\n    } else {\n      return;\n    }\n  }\n}\n\nexport function pop(heap) {\n  if (heap.length === 0) {\n    return null;\n  }\n\n  const first = heap[0];\n  const last = heap.pop();\n\n  if (first !== last) {\n    heap[0] = last;\n    siftDown(heap, last, 0);\n  }\n  return first;\n}\n\n// \\u5F39\\u51FA\\u9996\\u5143\\u7D20\\uFF0C\\u5206\\u522B\\u5BF9\\u5DE6\\u53F3\\u8FDB\\u884C\\u6BD4\\u8F83\nfunction siftDown(heap, node, i) {\n  let index = i;\n  const len = heap.length;\n  const halfLen = len \u003e\u003e 1;\n  while (index \u003c halfLen) {\n    const leftIndex = (index + 1) * 2 - 1;\n    const rightIndex = leftIndex + 1;\n    const left = heap[leftIndex];\n    const right = heap[rightIndex];\n    if (compare(left, node) \u003c 0) {\n      if (rightIndex \u003c len \u0026\u0026 compare(right, left) \u003c 0) {\n        heap[index] = right;\n        heap[rightIndex] = node;\n        index = rightIndex;\n      } else {\n        // not right or right \u003c left\n        heap[index] = left;\n        heap[leftIndex] = node;\n        index = leftIndex;\n      }\n    } else if (rightIndex \u003c len \u0026\u0026 compare(right, node) \u003c 0) {\n      heap[index] = right;\n      heap[rightIndex] = node;\n      index = rightIndex;\n    } else {\n      return;\n    }\n  }\n}\n\nfunction compare(a, b) {\n  // return a - b;\n  const diff = a.sortIndex - b.sortIndex;\n  return diff !== 0 ? diff : a.id - b.id;\n}\n`})}),`\n`,(0,n.jsx)(e.h3,{hash:\"\\u4EFB\\u52A1\\u4EA7\\u751F\",children:\"\\u4EFB\\u52A1\\u4EA7\\u751F\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"react \\u4E2D\\u8C03\\u7528\\u4E86 \",(0,n.jsx)(e.code,{children:\"Scheduler.unstable_scheduleCallback\"}),\" \\uFF0C\\u901A\\u8FC7\\u8FD9\\u4E2A\\u51FD\\u6570\\u5C06\\u6E32\\u67D3\\u4EFB\\u52A1\\u5B58\\u50A8 \",(0,n.jsx)(e.code,{children:\"taskQueue\"}),\" \\u4E2D\\uFF0C\",(0,n.jsx)(e.code,{children:\"taskQueue\"}),\" \\u662F\\u6700\\u5C0F\\u5806\\u7C7B\\u578B\\uFF0C\\u5B58\\u653E\\u4EFB\\u52A1\\u7B49\\u5F85\\u8C03\\u5EA6\\u6267\\u884C\\u3002\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-js\",children:`// react/packages/scheduler/src/forks/Scheduler.js\nfunction unstable_scheduleCallback(\n  priorityLevel: PriorityLevel,\n  callback: Callback,\n  options?: {delay: number},\n): Task {\n\t// \\u5F53\\u524D\\u65F6\\u95F4\\u6233\n  var currentTime = getCurrentTime();\n\n  var startTime;\n\t// react \\u6CA1\\u7528\\u5230 option\n  if (typeof options === 'object' \u0026\u0026 options !== null) {\n    var delay = options.delay;\n    if (typeof delay === 'number' \u0026\u0026 delay \u003e 0) {\n      startTime = currentTime + delay;\n    } else {\n      startTime = currentTime;\n    }\n  } else {\n\t\t// \\u8BBE\\u7F6E\\u5F00\\u59CB\\u65F6\\u95F4\n    startTime = currentTime;\n  }\n\n\t// \\u6839\\u636E\\u4F18\\u5148\\u7EA7\\u8BBE\\u7F6E\\u8D85\\u65F6\\u65F6\\u95F4\n  var timeout;\n  switch (priorityLevel) {\n    case ImmediatePriority: // \\u6700\\u9AD8\\u4F18\\u5148\\u7EA7\\uFF0C\\u8D85\\u65F6\\u65F6\\u95F4\\u6700\\u77ED\n      timeout = IMMEDIATE_PRIORITY_TIMEOUT;\n      break;\n    case UserBlockingPriority:\n      timeout = USER_BLOCKING_PRIORITY_TIMEOUT;\n      break;\n    case IdlePriority:\n      timeout = IDLE_PRIORITY_TIMEOUT;\n      break;\n    case LowPriority:\n      timeout = LOW_PRIORITY_TIMEOUT;\n      break;\n    case NormalPriority:\n    default:\n      timeout = NORMAL_PRIORITY_TIMEOUT;\n      break;\n  }\n\t// \\u6839\\u636E\\u4EFB\\u52A1\\u4F18\\u5148\\u7EA7\\u8BBE\\u7F6E\\u8FC7\\u671F\\u65F6\\u95F4\n  var expirationTime = startTime + timeout;\n\n\t// \\u4EFB\\u52A1\\u521B\\u5EFA\\uFF0C\\u8BB2\\u672C\\u51FD\\u6570\\u53C2\\u6570 callback \\u88AB\\u5B58\\u5165\\u4EFB\\u52A1\\u4E2D\n  var newTask: Task = {\n    id: taskIdCounter++,\n    callback,\n    priorityLevel,\n    startTime,\n    expirationTime,\n    sortIndex: -1,\n  };\n  if (enableProfiling) {\n    newTask.isQueued = false;\n  }\n\n  if (startTime \u003e currentTime) {\n\t\t// \\u8FD9\\u91CC\\u662F\\u6709 option \\u7684\\u60C5\\u51B5\\uFF0Creact \\u6CA1\\u6709\\u7528\\u5230\n    // This is a delayed task.\n    newTask.sortIndex = startTime;\n    push(timerQueue, newTask);\n    if (peek(taskQueue) === null \u0026\u0026 newTask === peek(timerQueue)) {\n      // All tasks are delayed, and this is the task with the earliest delay.\n      if (isHostTimeoutScheduled) {\n        // Cancel an existing timeout.\n        cancelHostTimeout();\n      } else {\n        isHostTimeoutScheduled = true;\n      }\n      // Schedule a timeout.\n      requestHostTimeout(handleTimeout, startTime - currentTime);\n    }\n  } else {\n\t\t// \\u6CA1\\u6709 option \\u7684\\u60C5\\u51B5\\u8D70\\u8FD9\\u91CC\n\t\t// sortIndex \\u4E3A task \\u88AB push \\u5230\\u6700\\u5C0F\\u5806\\u65F6\\u7684\\u6392\\u5E8F index\\uFF0C\n\t\t// \\u4E0D\\u96BE\\u7406\\u89E3\\uFF0C\\u4EFB\\u52A1\\u8FC7\\u671F\\u65F6\\u95F4\\u8D8A\\u5C0F\\uFF0C\\u8D8A\\u9760\\u8FD1\\u5806\\u9876\\uFF0C\\u8D8A\\u4F18\\u5148\\u5904\\u7406\n    newTask.sortIndex = expirationTime;\n    push(taskQueue, newTask);\n    if (enableProfiling) {\n      markTaskStart(newTask, currentTime);\n      newTask.isQueued = true;\n    }\n    // Schedule a host callback, if needed. If we're already performing work,\n    // wait until the next time we yield.\n\t\t// isHostCallbackScheduled \\u610F\\u601D\\u662F\\u662F\\u5426\\u6709 host callback \\u4EFB\\u52A1\\u88AB\\u8C03\\u5EA6\\u4E86\n    if (!isHostCallbackScheduled \u0026\u0026 !isPerformingWork) {\n      isHostCallbackScheduled = true;\n      requestHostCallback(flushWork);\n    }\n  }\n\n  return newTask;\n}\n`})}),`\n`,(0,n.jsx)(e.h3,{hash:\"\\u4EFB\\u52A1\\u8C03\\u5EA6\\u6267\\u884C\",children:\"\\u4EFB\\u52A1\\u8C03\\u5EA6\\u6267\\u884C\"}),`\n`,(0,n.jsx)(e.p,{children:\"scheduler \\u662F\\u5C06\\u4F20\\u5165\\u7684\\u4EFB\\u52A1\\u653E\\u5230\\u5B8F\\u4EFB\\u52A1\\u7684\\u4E8B\\u4EF6\\u5FAA\\u73AF\\u91CC\\u6267\\u884C\\u3002\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u4F9D\\u6B21\\u6709\\u4E09\\u79CD\\u517C\\u5BB9\\u6027\\u964D\\u7EA7\\u7684\\u65B9\\u6848\\uFF1A\",(0,n.jsx)(e.code,{children:\"setImmediate\"}),\" \\u2192 \",(0,n.jsx)(e.code,{children:\"MessageChannel\"}),\" \\u2192\",(0,n.jsx)(e.code,{children:\"SetTimeout\"})]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-js\",children:`// react/packages/scheduler/src/forks/Scheduler.js\nlet schedulePerformWorkUntilDeadline;\nif (typeof localSetImmediate === 'function') {\n  // Node.js and old IE.\n  // There's a few reasons for why we prefer setImmediate.\n  //\n  // Unlike MessageChannel, it doesn't prevent a Node.js process from exiting.\n  // (Even though this is a DOM fork of the Scheduler, you could get here\n  // with a mix of Node.js 15+, which has a MessageChannel, and jsdom.)\n  // https://github.com/facebook/react/issues/20756\n  //\n  // But also, it runs earlier which is the semantic we want.\n  // If other browsers ever implement it, it's better to use it.\n  // Although both of these would be inferior to native scheduling.\n  schedulePerformWorkUntilDeadline = () =\u003e {\n    localSetImmediate(performWorkUntilDeadline);\n  };\n} else if (typeof MessageChannel !== 'undefined') {\n  // DOM and Worker environments.\n  // We prefer MessageChannel because of the 4ms setTimeout clamping.\n  const channel = new MessageChannel();\n  const port = channel.port2;\n  channel.port1.onmessage = performWorkUntilDeadline;\n  schedulePerformWorkUntilDeadline = () =\u003e {\n    port.postMessage(null);\n  };\n} else {\n  // We should only fallback here in non-browser environments.\n  schedulePerformWorkUntilDeadline = () =\u003e {\n    // $FlowFixMe[not-a-function] nullable value\n    localSetTimeout(performWorkUntilDeadline, 0);\n  };\n}\n`})}),`\n`,(0,n.jsx)(e.p,{children:\"\\u5B9E\\u9645\\u6267\\u884C\\u7684\\u5C31\\u662F\\uFF1A\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-js\",children:`let schedulePerformWorkUntilDeadline;\nschedulePerformWorkUntilDeadline = () =\u003e {\n   localSetImmediate(performWorkUntilDeadline);\n};\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u518D\\u56DE\\u5230\\u4ECE \",(0,n.jsx)(e.code,{children:\"scheduleUpdateOnFiber\"}),\" \\u5230 task \\u88AB\\u6267\\u884C\\uFF1A\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-js\",children:`// \\u7B80\\u8981\\u4EE3\\u7801\\u6267\\u884C\\u6D41\\u7A0B\nfunction unstable_scheduleCallback () {\n\trequestHostCallback(flushWork);\n}\nfunction requestHostCallback(callback) {\n  scheduledHostCallback = callback;\n  if (!isMessageLoopRunning) {\n    isMessageLoopRunning = true;\n\t\t// \\u6267\\u884C\\u4E0A\\u4E00\\u6BB5\\u4EE3\\u7801\\u7684  localSetImmediate(performWorkUntilDeadline);\n    schedulePerformWorkUntilDeadline();\n  }\n}\n// \\u91CC\\u9762\\u7684 scheduledHostCallback \\u4E3A flushWork\nconst performWorkUntilDeadline = () =\u003e {\n  if (scheduledHostCallback !== null) {\n    const currentTime = getCurrentTime();\n    // Keep track of the start time so we can measure how long the main thread\n    // has been blocked.\n    startTime = currentTime;\n\n    // If a scheduler task throws, exit the current browser task so the\n    // error can be observed.\n    //\n    // Intentionally not using a try-catch, since that makes some debugging\n    // techniques harder. Instead, if \\`scheduledHostCallback\\` errors, then\n    // \\`hasMoreWork\\` will remain true, and we'll continue the work loop.\n    let hasMoreWork = true;\n    try {\n      // $FlowFixMe[not-a-function] found when upgrading Flow\n      hasMoreWork = scheduledHostCallback(currentTime);\n    } finally {\n      if (hasMoreWork) {\n        // If there's more work, schedule the next message event at the end\n        // of the preceding one.\n        schedulePerformWorkUntilDeadline();\n      } else {\n        isMessageLoopRunning = false;\n        scheduledHostCallback = null;\n      }\n    }\n  } else {\n    isMessageLoopRunning = false;\n  }\n  // Yielding to the browser will give it a chance to paint, so we can\n  // reset this.\n  needsPaint = false;\n};\n\nfunction flushWork(initialTime: number) {\n  if (enableProfiling) {\n\t  \\xB7\\xB7\\xB7\n  }\n\n  // We'll need a host callback the next time work is scheduled.\n  isHostCallbackScheduled = false;\n  if (isHostTimeoutScheduled) {\n    // We scheduled a timeout but it's no longer needed. Cancel it.\n    isHostTimeoutScheduled = false;\n    cancelHostTimeout();\n  }\n\n  isPerformingWork = true;\n  const previousPriorityLevel = currentPriorityLevel;\n  try {\n    if (enableProfiling) {\n\t    \\xB7\\xB7\\xB7\n    } else {\n      // No catch in prod code path.\n      return workLoop(initialTime);\n    }\n  } finally {\n    currentTask = null;\n    currentPriorityLevel = previousPriorityLevel;\n    isPerformingWork = false;\n    if (enableProfiling) {\n     \\xB7\\xB7\\xB7\n    }\n  }\n}\n\nfunction workLoop(initialTime: number) {function workLoop(initialTime: number) {\n  let currentTime = initialTime;\n  advanceTimers(currentTime);\n\t// \\u53D6 task\n  currentTask = peek(taskQueue);\n  while (\n    currentTask !== null \u0026\u0026\n    !(enableSchedulerDebugging \u0026\u0026 isSchedulerPaused)\n  ) {\n    if (currentTask.expirationTime \u003e currentTime \u0026\u0026 shouldYieldToHost()) {\n      // This currentTask hasn't expired, and we've reached the deadline.\n      break;\n    }\n    // $FlowFixMe[incompatible-use] found when upgrading Flow\n    const callback = currentTask.callback;\n    if (typeof callback === 'function') {\n      // $FlowFixMe[incompatible-use] found when upgrading Flow\n      currentTask.callback = null;\n      // $FlowFixMe[incompatible-use] found when upgrading Flow\n      currentPriorityLevel = currentTask.priorityLevel;\n      // $FlowFixMe[incompatible-use] found when upgrading Flow\n      const didUserCallbackTimeout = currentTask.expirationTime \u003c= currentTime;\n      if (enableProfiling) {\n        // $FlowFixMe[incompatible-call] found when upgrading Flow\n        markTaskRun(currentTask, currentTime);\n      }\n      const continuationCallback = callback(didUserCallbackTimeout);\n      currentTime = getCurrentTime();\n      if (typeof continuationCallback === 'function') {\n        // If a continuation is returned, immediately yield to the main thread\n        // regardless of how much time is left in the current time slice.\n        // $FlowFixMe[incompatible-use] found when upgrading Flow\n        currentTask.callback = continuationCallback;\n        if (enableProfiling) {\n          \\xB7\\xB7\\xB7\n        }\n        advanceTimers(currentTime);\n        return true;\n      } else {\n        if (enableProfiling) {\n          \\xB7\\xB7\\xB7\n        }\n        if (currentTask === peek(taskQueue)) {\n          pop(taskQueue);\n        }\n        advanceTimers(currentTime);\n      }\n    } else {\n      pop(taskQueue);\n    }\n    currentTask = peek(taskQueue);\n  }\n  // Return whether there's additional work\n  if (currentTask !== null) {\n    return true;\n  } else {\n    const firstTimer = peek(timerQueue);\n    if (firstTimer !== null) {\n      requestHostTimeout(handleTimeout, firstTimer.startTime - currentTime);\n    }\n    return false;\n  }\n}\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u53EF\\u4EE5\\u770B\\u51FA\\uFF0C\\u6838\\u5FC3\\u6267\\u884C\\u6D41\\u7A0B\\u662F\\u901A\\u8FC7 \",(0,n.jsx)(e.code,{children:\"while\"}),\" \\u5FAA\\u73AF\\u4E0D\\u65AD\\u53D6 \",(0,n.jsx)(e.code,{children:\"taskQueue\"}),\" \\u4E2D\\u7684 \",(0,n.jsx)(e.code,{children:\"task\"}),\"\\uFF0C\\u5E76\\u6267\\u884C\\u5176 \",(0,n.jsx)(e.code,{children:\"task.callback\"})]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-js\",children:`// \\u7B80\\u5316\\u7248\\u6D41\\u7A0B\nfunction workLoop(initialTime: number) {\n\t\\xB7\\xB7\\xB7  \n\t// \\u83B7\\u53D6\\u5806\\u9876\\u4EFB\\u52A1\n\tcurrentTask = peek(taskQueue);\n  while (\n    currentTask !== null \u0026\u0026\n    !(enableSchedulerDebugging \u0026\u0026 isSchedulerPaused)\n  ) {\n\t\t// \\u524D\\u4E00\\u4E2A\\u6BD4\\u8F83\\u662F\\u4E00\\u4E2A\\u8D2A\\u5FC3\\u7684\\u7B56\\u7565\\uFF0C\\u672A\\u5230 deadline\\uFF0C\\u53EF\\u4EE5\\u518D\\u7B49\\u7B49\n\t\t// \\u5982\\u679C\\u662F\\u4F18\\u5148\\u7EA7\\u8F83\\u9AD8\\u7684\\uFF0C\\u90A3\\u5176\\u5B9E\\u4F1A\\u5F88\\u5FEB\\u8FC7\\u671F\n\t\t// shouldYieldToHost \\u662F\\u4E2D\\u65AD\\u7684\\u903B\\u8F91\n\t\tif (currentTask.expirationTime \u003e currentTime \u0026\u0026 shouldYieldToHost()) {\n      // This currentTask hasn't expired, and we've reached the deadline.\n      break;\n    }\n\t\t// \\u6267\\u884C callback\n\t\tconst callback = currentTask.callback;\n    if (typeof callback === 'function') {\n\t\t\tconst continuationCallback = callback(didUserCallbackTimeout);\n      if (typeof continuationCallback === 'function') {\n\t\t\t\tcurrentTask.callback = continuationCallback;\n\t\t\t\treturn true;\n\t\t\t} else {\n\t\t\t\tif (currentTask === peek(taskQueue)) {\n          pop(taskQueue);\n        }\n\t\t\t}\n\t\t} else {\n\t\t\t// \\u79FB\\u9664\\u88AB\\u6267\\u884C\\u7684\\u4EFB\\u52A1\n      pop(taskQueue);\n    }\n\t\t// \\u83B7\\u53D6\\u4E0B\\u4E00\\u4E2A\\u5806\\u9876\\u4EFB\\u52A1\n\t\tcurrentTask = peek(taskQueue);\n\t}\n}\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u51FD\\u6570\\u4E2D\\u8C03\\u7528 \",(0,n.jsx)(e.code,{children:\"shouldYieldToHost\"}),\" \\u5224\\u65AD\\u662F\\u5426\\u8BA9\\u6E21\\u5904\\u7406\\u6743\\u7ED9\\u9875\\u9762\\uFF0C\\u5B9E\\u9645\\u6548\\u679C\\u5C31\\u662F\\u63D0\\u524D\\u7ED3\\u675F\\u6389\\u5F53\\u524D\\u8FD9\\u4E2A\\u5B8F\\u4EFB\\u52A1\\uFF0C\\u5F53\\u524D\\u4EFB\\u52A1\\u7684\\u540E\\u7EED\\u5185\\u5BB9\\u88AB\\u4E2D\\u65AD\\uFF0C\\u4E0D\\u6267\\u884C\\u4E86\\u3002\\u91CC\\u9762\\u903B\\u8F91\\u6BD4\\u8F83\\u590D\\u6742\\uFF0C\\u65F6\\u95F4\\u5224\\u65AD\\u903B\\u8F91\\u8F83\\u591A\\uFF0C\\u540E\\u7EED\\u518D\\u7814\\u7A76\\u3002\\u4F46\\u662F\\u91CD\\u70B9\\u662F\\u8C03\\u7528\\u4E86 \",(0,n.jsx)(e.code,{children:\"navigator.scheduling.isInputPending\"}),\" \\uFF0C\\u8FD9\\u4E2A API \\u7684\\u517C\\u5BB9\\u6027\\u4E0D\\u592A\\u884C\\uFF0C\\u662F react \\u548C chrome \\u5408\\u4F5C\\u641E\\u51FA\\u6765\\u7684\\u3002\\u5982\\u679C\\u6D4F\\u89C8\\u5668\\u4EFB\\u52A1\\u961F\\u5217\\u4E2D\\u6709\\u8F93\\u5165\\u4E8B\\u4EF6\\u5F85\\u5904\\u7406\\uFF0C\\u5219\\u8FD4\\u56DE \",(0,n.jsx)(e.code,{children:\"true\"}),\"\\u3002\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-js\",children:`// \\u6709\\u5174\\u8DA3\\u770B\\u770B\\u5C31\\u884C\nconst isInputPending =\n  typeof navigator !== 'undefined' \u0026\u0026\n  // $FlowFixMe[prop-missing]\n  navigator.scheduling !== undefined \u0026\u0026\n  // $FlowFixMe[incompatible-type]\n  navigator.scheduling.isInputPending !== undefined\n    ? navigator.scheduling.isInputPending.bind(navigator.scheduling)\n    : null;\n\nfunction shouldYieldToHost(): boolean {\n  const timeElapsed = getCurrentTime() - startTime;\n  if (timeElapsed \u003c frameInterval) {\n    // The main thread has only been blocked for a really short amount of time;\n    // smaller than a single frame. Don't yield yet.\n    return false;\n  }\n\n  if (enableIsInputPending) {\n    if (needsPaint) {\n      // There's a pending paint (signaled by \\`requestPaint\\`). Yield now.\n      return true;\n    }\n    if (timeElapsed \u003c continuousInputInterval) {\n      // We haven't blocked the thread for that long. Only yield if there's a\n      // pending discrete input (e.g. click). It's OK if there's pending\n      // continuous input (e.g. mouseover).\n      if (isInputPending !== null) {\n        return isInputPending();\n      }\n    } else if (timeElapsed \u003c maxInterval) {\n      // Yield if there's either a pending discrete or continuous input.\n      if (isInputPending !== null) {\n        return isInputPending(x);\n      }\n    } else {\n      // We've blocked the thread for a long time. Even if there's no pending\n      // input, there may be some other scheduled work that we don't know about,\n      // like a network event. Yield now.\n      return true;\n    }\n  }\n\n  // \\`isInputPending\\` isn't available. Yield now.\n  return true;\n}\n`})}),`\n`,(0,n.jsx)(e.h2,{hash:\"\\u4EFB\\u52A1\\u8C03\\u5EA6\\u4E3A\\u4EC0\\u4E48\\u9009\\u62E9\\u5B8F\\u4EFB\\u52A1\",children:\"\\u4EFB\\u52A1\\u8C03\\u5EA6\\u4E3A\\u4EC0\\u4E48\\u9009\\u62E9\\u5B8F\\u4EFB\\u52A1\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u5F53\\xA0\",(0,n.jsx)(e.code,{children:\"shouldYieldToHost()\"}),\"\\xA0\\u8FD4\\u56DE\\xA0\",(0,n.jsx)(e.code,{children:\"true\"}),\"\\xA0\\u540E\\uFF0CScheduler \\u9700\\u8981\\u6EE1\\u8DB3\\u4EE5\\u4E0B\\u529F\\u80FD\\u70B9\\uFF1A\"]}),`\n`,(0,n.jsxs)(e.ol,{children:[`\n`,(0,n.jsx)(e.li,{children:\"\\u6682\\u505C\\u6E32\\u67D3\\u4EFB\\u52A1\\u7684\\u6267\\u884C\\uFF0C\\u5C06\\u4E3B\\u7EBF\\u7A0B\\u8FD8\\u7ED9\\u6D4F\\u89C8\\u5668\\uFF0C\\u8BA9\\u6D4F\\u89C8\\u5668\\u6709\\u673A\\u4F1A\\u66F4\\u65B0\\u9875\\u9762\\u53BB\\u5904\\u7406\\u7528\\u6237\\u54CD\\u5E94\\u7B49\\u4EFB\\u52A1\"}),`\n`,(0,n.jsxs)(e.li,{children:[\"\\u5728\\u672A\\u6765\\u67D0\\u4E2A\\u65F6\\u523B\\u7EE7\\u7EED\\u8C03\\u5EA6\\u4EFB\\u52A1\\uFF0C\\u6267\\u884C\\u4E0A\\u6B21\\u8FD8\\u6CA1\\u6709\\u5B8C\\u6210\\u7684\\u4EFB\\u52A1\\uFF08\\u8FD9\\u90E8\\u5206\\u903B\\u8F91\\u4E0D\\u5728 scheduler\\uFF0C\\u81F3\\u4E8E\\u5982\\u4F55\\u4FDD\\u7559\\u5F53\\u524D\\u73B0\\u573A\\uFF0C\\u4E4B\\u540E\\u6062\\u590D\\u73B0\\u573A\\u5E76\\u7EE7\\u7EED\\u6267\\u884C\\uFF0C\\u662F\\u4EFB\\u52A1\\u91CC\\u7684 callback \\u5E94\\u8BE5\\u505A\\u7684\\u4E8B\\uFF0C\\u5B9E\\u9645\\u4E0A\\uFF0C\\u6E32\\u67D3\\u4EFB\\u52A1\\u7684 callback \\u91CC\\u4E5F\\u4F1A\\u7528\\u5230 \",(0,n.jsx)(e.code,{children:\"shouldYieldToHost\"}),\" \\uFF09\"]}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"\\u8981\\u6EE1\\u8DB3\\u8FD9\\u4E24\\u70B9\\u5C31\\u9700\\u8981\\u8C03\\u5EA6\\u4E00\\u4E2A\\u5B8F\\u4EFB\\u52A1\\uFF0C\\u56E0\\u4E3A\\u5B8F\\u4EFB\\u52A1\\u662F\\u5728\\u4E0B\\u6B21\\u4E8B\\u4EF6\\u5FAA\\u73AF\\u4E2D\\u6267\\u884C\\uFF0C\\u4E0D\\u4F1A\\u963B\\u585E\\u672C\\u6B21\\u9875\\u9762\\u66F4\\u65B0\\u3002\"}),`\n`,(0,n.jsx)(\"img\",{src:\"/lifeOfAFrame.png\",width:800,height:300}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u4E3A\\u4EC0\\u4E48\\u4E0D\\u7528\\u5FAE\\u4EFB\\u52A1\\uFF0C\",(0,n.jsx)(e.code,{children:\"requestAnimationFrame\"}),\" \\u6216 \",(0,n.jsx)(e.code,{children:\"requestIdleCallback\"}),\"?\"]}),`\n`,(0,n.jsxs)(e.p,{children:[`\\u5FAE\\u4EFB\\u52A1\\u662F\\u5728\\u672C\\u6B21\\u4E8B\\u4EF6\\u5FAA\\u73AF\\u91CC\\u6267\\u884C\\uFF0C\\u5982\\u679C\\u4EA7\\u751F\\u7684\\u6E32\\u67D3\\u4EFB\\u52A1\\u662F\\u4EE5\\u5FAE\\u4EFB\\u52A1\\u65B9\\u5F0F\\u6267\\u884C\\uFF0C\\u90A3\\u4E48\\u5FC5\\u987B\\u4EA7\\u751F\\u7684\\u5FAE\\u4EFB\\u52A1\\u90FD\\u6267\\u884C\\u5B8C\\u6BD5\\u624D\\u8FDB\\u5165\\u4E0B\\u4E00\\u4E2A\\u5B8F\\u4EFB\\u52A1\\u3002\nraf \\u4E0D\\u5C5E\\u4E8E\\u5FAE\\u4EFB\\u52A1\\u6216\\u5B8F\\u4EFB\\u52A1\\uFF0C\\u662F\\u5728\\u5E27\\u95F4\\u6267\\u884C\\u4E00\\u6B21\\uFF0C\\u800C\\u5B8F\\u4EFB\\u52A1\\u5728\\u5E27\\u95F4\\u4E0D\\u4E00\\u5B9A\\u53EA\\u6267\\u884C\\u4E00\\u4E2A\\uFF0C\\u53EF\\u4EE5\\u6267\\u884C\\u591A\\u4E2A\\u6700\\u540E\\u518D\\u4E00\\u8D77\\u6E32\\u67D3\\u3002\\u5177\\u4F53\\u53EF\\u4EE5\\u770B\\u8FD9\\u4E2A\\u5206\\u6790 `,(0,n.jsx)(e.a,{href:\"https://juejin.cn/post/7165780929439334437\",children:\"React \\u4E4B requestAnimationFrame \\u6267\\u884C\\u673A\\u5236\\u63A2\\u7D22\"}),`\n`,(0,n.jsx)(e.code,{children:\"requestIdleCallback\"}),\" \\u662F\\u517C\\u5BB9\\u6027\\u8F83\\u5DEE\\u4E0D\\u9002\\u5408\\u5728\\u751F\\u4EA7\\u73AF\\u5883\\u4E0A\\uFF0C\\u5E76\\u4E14\\u5B83\\u5B9E\\u9645\\u4E0A\\u662F\\u5728\\u5E03\\u5C40\\u548C\\u7ED8\\u5236\\u4E4B\\u540E\\u6267\\u884C\\uFF0C\\u90A3\\u610F\\u5473\\u5728\\u91CC\\u9762\\u505A\\u7684\\u4E8B\\u60C5\\uFF08\\u53EF\\u80FD\\u662F\\u901A\\u8FC7\\u6570\\u636E\\u4FEE\\u6539\\u89E6\\u53D1dom\\u4FEE\\u6539\\uFF09\\u4F1A\\u91CD\\u6392\\u3002\"]}),`\n`,(0,n.jsx)(e.h3,{hash:\"\\u8BA9\\u6E21\\u4E3B\\u7EBF\\u7A0B\",children:\"\\u8BA9\\u6E21\\u4E3B\\u7EBF\\u7A0B\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.code,{children:\"shouldYieldToHost\"})}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.code,{children:\"navigator.scheduling.isInputPending API\"}),\"\\u662F react \\u4E0E Chrome \\u56E2\\u961F\\u5408\\u4F5C\\u7684\\u4EA7\\u7269\\u3002\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-js\",children:`function shouldYieldToHost(): boolean {\n  const timeElapsed = getCurrentTime() - startTime;\n  if (timeElapsed \u003c frameInterval) {\n    // The main thread has only been blocked for a really short amount of time;\n    // smaller than a single frame. Don't yield yet.\n    return false;\n  }\n\n  // The main thread has been blocked for a non-negligible amount of time. We\n  // may want to yield control of the main thread, so the browser can perform\n  // high priority tasks. The main ones are painting and user input. If there's\n  // a pending paint or a pending input, then we should yield. But if there's\n  // neither, then we can yield less often while remaining responsive. We'll\n  // eventually yield regardless, since there could be a pending paint that\n  // wasn't accompanied by a call to \\`requestPaint\\`, or other main thread tasks\n  // like network events.\n  if (enableIsInputPending) {\n    if (needsPaint) {\n      // There's a pending paint (signaled by \\`requestPaint\\`). Yield now.\n      return true;\n    }\n    if (timeElapsed \u003c continuousInputInterval) {\n      // We haven't blocked the thread for that long. Only yield if there's a\n      // pending discrete input (e.g. click). It's OK if there's pending\n      // continuous input (e.g. mouseover).\n      if (isInputPending !== null) {\n        return isInputPending();\n      }\n    } else if (timeElapsed \u003c maxInterval) {\n      // Yield if there's either a pending discrete or continuous input.\n      if (isInputPending !== null) {\n        return isInputPending(continuousOptions);\n      }\n    } else {\n      // We've blocked the thread for a long time. Even if there's no pending\n      // input, there may be some other scheduled work that we don't know about,\n      // like a network event. Yield now.\n      return true;\n    }\n  }\n\n  // \\`isInputPending\\` isn't available. Yield now.\n  return true;\n}\n`})})]})}function w(t={}){let{wrapper:e}=t.components||{};return e?(0,n.jsx)(e,Object.assign({},t,{children:(0,n.jsx)(d,t)})):d(t)}var I=w;return b(x);})();\n;return Component;"},"__N_SSG":true},"page":"/[[...id]]","query":{"id":["react-src","scheduler"]},"buildId":"ntD6QUMlZQsl3mf9dMsvt","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>